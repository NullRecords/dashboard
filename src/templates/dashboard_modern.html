<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Personal Assistant</title>
    <link rel="icon" href="/assets/images/forge-logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style id="skin-css">
        /* Default skin variables - will be overwritten by active skin */
        :root {
            --skin-primary: #9333ea;
            --skin-primary-light: #a855f7;
            --skin-primary-dark: #7e22ce;
            --skin-secondary: #6366f1;
            --skin-accent: #06b6d4;
            --skin-bg-primary: #111827;
            --skin-bg-secondary: #1f2937;
            --skin-bg-tertiary: #374151;
            --skin-text-primary: #f3f4f6;
            --skin-text-secondary: #d1d5db;
            --skin-text-muted: #9ca3af;
            --skin-border-primary: #374151;
            --skin-border-accent: #7c3aed;
        }
        /* Apply skin colors to elements */
        .skin-primary { color: var(--skin-primary); }
        .skin-primary-bg { background-color: var(--skin-primary); }
        .skin-primary-border { border-color: var(--skin-primary); }
        .skin-secondary { color: var(--skin-secondary); }
        .skin-accent { color: var(--skin-accent); }
        .skin-bg-primary { background-color: var(--skin-bg-primary); }
        .skin-bg-secondary { background-color: var(--skin-bg-secondary); }
        .skin-text-primary { color: var(--skin-text-primary); }
        .skin-text-secondary { color: var(--skin-text-secondary); }
        .skin-border { border-color: var(--skin-border-primary); }
        .skin-border-accent { border-color: var(--skin-border-accent); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-full" style="background-color: var(--skin-bg-primary); color: var(--skin-text-primary);">
    <div id="app-bg" class="fixed inset-0 -z-10 bg-cover bg-center opacity-25"></div>
    <!-- Main Container -->
    <div class="flex h-full">
        <!-- Sidebar Navigation -->
        <aside class="w-64 border-r overflow-y-auto" style="background-color: var(--skin-bg-secondary); border-color: var(--skin-border-primary);">
            <div class="p-6 border-b space-y-3" style="border-color: var(--skin-border-primary);">
                <img id="assistant-avatar" src="/assets/images/rogr.gif" alt="Assistant" class="w-full h-auto rounded-lg object-cover" style="border: 2px solid var(--skin-primary);"/>
                <div id="assistant-name" class="text-xl font-bold" style="color: var(--skin-primary-light);">R0-GR</div>
                <div class="flex gap-2">
                    <button onclick="toggleWakeWord()" class="px-3 py-2 rounded text-xs" style="background-color: var(--skin-primary-dark);">üé§ Listen</button>
                    <button onclick="promptSpeak()" class="px-3 py-2 rounded text-xs" style="background-color: var(--skin-primary);">üí¨ Ask</button>
                </div>
                <a id="assistant-link" href="/assistant" class="block text-xs underline" style="color: var(--skin-primary-light);">Open Assistant</a>
                <!-- Skin Switcher -->
                <div class="pt-2 border-t" style="border-color: var(--skin-border-primary);">
                    <label class="text-xs" style="color: var(--skin-text-muted);">Theme:</label>
                    <select id="skin-select" onchange="switchSkin(this.value)" class="w-full mt-1 px-2 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                        <option value="roger">ü§ñ Roger (Battle Droid)</option>
                        <option value="dracula">üòà Demon (Gothic)</option>
                    </select>
                </div>
            </div>
            <nav id="sidebar-nav" class="space-y-2 px-4 py-4">
                <button onclick="showSection('overview')" class="nav-link w-full text-left px-4 py-3 rounded-lg bg-gray-700 text-white transition-colors hover:bg-gray-600">
                    <i class="fas fa-home mr-2"></i>Overview
                </button>
                <button onclick="showSection('weather')" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-cloud-sun mr-2"></i>Weather
                </button>
                <button onclick="showSection('news')" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-newspaper mr-2"></i>News
                </button>
                <button onclick="showSection('tasks')" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-tasks mr-2"></i>Tasks
                </button>
                <button onclick="showSection('calendar')" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-calendar mr-2"></i>Calendar
                </button>
                <button onclick="showSection('settings')" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
                <a href="/assistant" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700 block">
                    <i class="fas fa-robot mr-2"></i>Roger Assistant
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto">
            <div class="sticky top-0 z-10 backdrop-blur border-b" style="background-color: var(--skin-bg-secondary); border-color: var(--skin-border-primary);">
                <div class="px-6 py-3 flex items-center justify-between">
                    <div id="header-title" class="text-xl font-bold text-white">Dashboard</div>
                    <div class="flex items-center gap-3 text-sm">
                        <!-- Theme Switcher - Prominent Position -->
                        <div class="flex items-center gap-2 px-3 py-1 rounded-lg" style="background-color: var(--skin-bg-tertiary);">
                            <span style="color: var(--skin-accent);">üé® Theme:</span>
                            <select id="skin-select-header" onchange="switchSkin(this.value)" class="px-2 py-1 rounded text-sm font-semibold" style="background-color: var(--skin-bg-primary); border: 2px solid var(--skin-primary); color: var(--skin-text-primary);">
                                <option value="roger">ü§ñ Roger</option>
                                <option value="dracula">üòà Demon</option>
                            </select>
                        </div>
                        <span style="color: var(--skin-text-muted);">|</span>
                        <span style="color: var(--skin-text-secondary);">Background:</span>
                        <select id="bg-select" class="px-2 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                            <option value="bg1">Background 1</option>
                            <option value="bg2">Background 2</option>
                            <option value="bg3">Background 3</option>
                        </select>
                        <button id="bg-prev" class="px-2 py-1 rounded" style="background-color: var(--skin-bg-tertiary);" title="Previous">‚ü®</button>
                        <button id="bg-next" class="px-2 py-1 rounded" style="background-color: var(--skin-bg-tertiary);" title="Next">‚ü©</button>
                        <input id="bg-url" type="url" placeholder="Paste image URL" class="hidden md:block w-48 px-2 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);"/>
                        <button id="bg-url-set" class="hidden md:block px-2 py-1 rounded" style="background-color: var(--skin-secondary);">Set</button>
                    </div>
                </div>
            </div>
            <!-- Overview Section -->
            <section id="section-overview" class="section-content p-8 space-y-8">
                <!-- Top Focus: Weather + Second Widget (Comics or Music Player) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Weather Widget (Large) - Always visible -->
                    <div data-widget="weather" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-weather-border, #0e7490);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold" style="color: var(--skin-accent);">üå°Ô∏è Weather</h3>
                            <div class="flex gap-2">
                                <button onclick="useCurrentLocation()" class="px-3 py-2 rounded text-xs" style="background-color: var(--skin-secondary); color: var(--skin-text-primary);">Use Current</button>
                            </div>
                        </div>
                        <div class="flex gap-3 mb-3">
                            <input id="weather-search-input" type="text" placeholder="Search city or place..." class="flex-1 px-3 py-2 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                            <button onclick="searchWeather()" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-secondary); color: var(--skin-text-primary);">Search</button>
                        </div>
                        <div id="weather-search-results" class="mb-3 text-sm" style="color: var(--skin-text-muted);"></div>
                        <div class="mb-3">
                            <div class="text-xs mb-2" style="color: var(--skin-text-muted);">Quick picks:</div>
                            <div class="flex flex-wrap gap-2">
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(45.5152,-122.6784,'Portland, OR')">Portland, OR</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(51.5072,-0.1276,'London, UK')">London</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(35.6762,139.6503,'Tokyo, JP')">Tokyo</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(-33.8688,151.2093,'Sydney, AU')">Sydney</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(48.8566,2.3522,'Paris, FR')">Paris</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(40.7128,-74.0060,'New York, US')">New York</button>
                            </div>
                        </div>
                        <div id="weather-display" style="color: var(--skin-text-secondary);">Loading...</div>
                        <div id="weather-forecast" class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2"></div>
                        <div id="weather-alerts" class="mt-4"></div>
                    </div>

                    <!-- Comics Widget (Roger) -->
                    <div data-widget="comics" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-comics-border, #ea580c);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold" style="color: var(--skin-accent);">üìö Comics</h3>
                            <select id="comic-select" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                                <option value="garfield">Garfield</option>
                                <option value="bloomcounty">Bloom County</option>
                                <option value="calvin">Calvin & Hobbes</option>
                                <option value="peanuts">Peanuts</option>
                                <option value="favorites">Favorites</option>
                            </select>
                        </div>
                        <div id="garfield" class="text-sm min-h-64" style="color: var(--skin-text-secondary);">Loading...</div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="reloadComic()" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">Reload</button>
                            <button onclick="showComicsArchive()" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-primary-dark); color: var(--skin-text-primary);">üìö Archive</button>
                        </div>
                    </div>

                    <!-- Music Player Widget (Dracula) -->
                    <div data-widget="music_player" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-accent, #dc2626);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold" style="color: var(--skin-accent);">üéµ Music Player</h3>
                            <button onclick="toggleMusicPlayer()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">‚ñ∂Ô∏è Play</button>
                        </div>
                        <div class="mb-4">
                            <label class="text-sm" style="color: var(--skin-text-muted);">Last.fm Station:</label>
                            <select id="lastfm-station" class="w-full px-3 py-2 rounded text-sm mt-2" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                                <option value="90s_alternative">üé∏ 90's Alternative Rock</option>
                                <option value="gothic_rock">ü¶á Gothic Rock</option>
                                <option value="darkwave">üåô Darkwave</option>
                                <option value="musicals">üé≠ Musical Theater</option>
                                <option value="industrial">‚öôÔ∏è Industrial</option>
                                <option value="shoegaze">üëü Shoegaze</option>
                            </select>
                        </div>
                        <div id="now-playing" class="text-sm mb-4" style="color: var(--skin-text-secondary);">
                            <div class="flex items-center gap-3">
                                <div class="w-16 h-16 rounded" style="background-color: var(--skin-bg-tertiary);"></div>
                                <div>
                                    <div class="font-semibold">Select a station to begin</div>
                                    <div class="text-xs" style="color: var(--skin-text-muted);">Your 90's alternative vibes await</div>
                                </div>
                            </div>
                        </div>
                        <div id="recent-tracks" class="space-y-2 text-sm" style="color: var(--skin-text-muted);">
                            <div class="text-xs uppercase tracking-wide mb-2">Recent Tracks</div>
                            <div class="italic">Play something to see recent tracks...</div>
                        </div>
                    </div>
                </div>

                <!-- Jokes & Quote -->
                <div data-widget="jokes_quote" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div data-widget="jokes" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-jokes-border, #9333ea);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-primary-light);">üòÑ Jokes</h3>
                            <button onclick="readJokes()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="jokes" class="text-sm" style="color: var(--skin-text-secondary);">Loading...</div>
                    </div>
                    <div data-widget="quote" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-quote-border, #4f46e5);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-secondary-light);">‚ú® Quote</h3>
                            <button onclick="readQuote()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-secondary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="quote" class="text-sm italic" style="color: var(--skin-text-secondary);">Loading...</div>
                    </div>
                </div>

                <!-- eBay Auctions Section (Roger) -->
                <div data-widget="ebay" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-ebay-border, #eab308);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-accent);">
                            <i class="fas fa-gavel mr-2"></i>eBay Auction Finds
                        </h3>
                        <button onclick="loadEbayAuctions()" class="px-4 py-2 rounded-lg text-sm" style="background-color: var(--skin-accent); color: var(--skin-bg-primary);">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <p class="text-sm mb-4" style="color: var(--skin-text-muted);">üíª Retro laptops & gaming systems ending soon with great prices</p>
                    <div id="ebay-auctions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center py-8 col-span-full" style="color: var(--skin-text-muted);">Loading retro tech auctions...</div>
                    </div>
                </div>

                <!-- Dark News Section (Dracula) - Horror, Fantasy, 90s Music -->
                <div data-widget="dark_news" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-news-border, #dc2626);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-accent);">
                            <i class="fas fa-moon mr-2"></i>Dark News Feed
                        </h3>
                        <button onclick="loadDarkNews()" class="px-4 py-2 rounded-lg text-sm" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="loadDarkNews('horror')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">üßõ Horror</button>
                        <button onclick="loadDarkNews('fantasy')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">üêâ Fantasy</button>
                        <button onclick="loadDarkNews('90s_music')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">üé∏ 90's Music</button>
                        <button onclick="loadDarkNews('gothic')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">ü¶á Gothic</button>
                    </div>
                    <div id="dark-news-list" class="space-y-3">
                        <div class="text-center py-8" style="color: var(--skin-text-muted);">Loading dark news...</div>
                    </div>
                </div>

                <!-- Art Communities (Dracula) -->
                <div data-widget="art_communities" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-communities-border, #9333ea);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-primary);">
                            <i class="fas fa-palette mr-2"></i>Art Communities
                        </h3>
                        <button onclick="loadArtCommunities()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">Refresh</button>
                    </div>
                    <div id="art-communities-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a href="https://reddit.com/r/Art" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé® r/Art</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Art and artists</div>
                        </a>
                        <a href="https://reddit.com/r/DigitalArt" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üíª r/DigitalArt</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Digital creation</div>
                        </a>
                        <a href="https://reddit.com/r/creepy" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üëª r/creepy</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Dark and creepy art</div>
                        </a>
                        <a href="https://reddit.com/r/ImaginaryMonsters" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üê≤ r/ImaginaryMonsters</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Fantasy creatures</div>
                        </a>
                    </div>
                </div>

                <!-- Music Communities (Dracula) -->
                <div data-widget="music_communities" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-communities-border, #9333ea);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-primary);">
                            <i class="fas fa-music mr-2"></i>Music Communities
                        </h3>
                        <button onclick="loadMusicCommunities()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">Refresh</button>
                    </div>
                    <div id="music-communities-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a href="https://reddit.com/r/90sAlternative" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé∏ r/90sAlternative</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">90's alternative rock</div>
                        </a>
                        <a href="https://reddit.com/r/goth" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">ü¶á r/goth</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Goth music & culture</div>
                        </a>
                        <a href="https://reddit.com/r/musicals" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé≠ r/musicals</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Musical theater</div>
                        </a>
                        <a href="https://reddit.com/r/singing" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé§ r/singing</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Singing tips & feedback</div>
                        </a>
                    </div>
                </div>

                <!-- Calm Radar / Anxiety Feed -->
                <div class="bg-gray-800 rounded-lg border border-emerald-700 p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-emerald-300"><i class="fas fa-leaf mr-2"></i>Calm Radar</h3>
                        <button onclick="loadAnxietyFeed()" class="text-emerald-400 hover:text-emerald-300 text-sm">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="anxiety-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-gray-400 text-center py-4 col-span-full">Loading calming content...</div>
                    </div>
                </div>

                <!-- Roger Home Content - Modular Widgets Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div data-widget="parts_search" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">üîß Parts Search</h3>
                        <div id="parts" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="history_fact" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">üìú History Fact</h3>
                        <div id="history" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="starwars" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">‚≠ê Star Wars</h3>
                        <div id="starwars" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="communities" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">üöÄ Communities</h3>
                        <div id="communities" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="roger_quotes" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-text-secondary);">ü§ñ Roger Quotes</h3>
                            <button onclick="readRogerQuote()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="roger-quotes" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <!-- Demon Quote Widget - Shows skin-specific quotes -->
                    <div data-widget="dracula_quotes" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 1px solid var(--skin-border-primary);">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-text-secondary);">üòà Demon's Wisdom</h3>
                            <button onclick="readDraculaQuote()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="dracula-quotes" class="text-sm italic" style="color: var(--skin-text-muted);">Loading chaotic wisdom...</div>
                    </div>
                </div>
            </section>

            <!-- Tasks Section -->
            <section id="section-tasks" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Tasks</div>
                    <div class="text-xs text-gray-300">Smart tasks from calendar and email</div>
                </div>
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">Tasks</h2>
                        <div class="flex gap-2">
                            <button onclick="generateSmartTasks(true)" class="px-3 py-2 bg-blue-700 hover:bg-blue-600 rounded text-sm">Generate Smart Tasks</button>
                            <label class="flex items-center gap-2 text-xs text-gray-300">
                                <input id="include-email" type="checkbox" class="accent-blue-500"> Include Email
                            </label>
                        </div>
                    </div>
                    <div id="tasks-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-gray-400 col-span-full text-center py-8">Loading tasks...</div>
                    </div>
                </div>
            </section>

            <!-- Weather Section -->
            <section id="section-weather" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Weather</div>
                    <div class="text-xs text-gray-300">Local station data, conditions, forecast and alerts</div>
                </div>
                
                <!-- Local Weather Station (Ambient Weather) -->
                <div id="ambient-weather-section" class="bg-gray-800 rounded-lg border border-green-600 p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-green-300">üè† Local Weather Station</h3>
                        <button onclick="loadAmbientWeather()" class="px-3 py-2 bg-green-700 hover:bg-green-600 rounded text-xs">Refresh</button>
                    </div>
                    <div id="ambient-weather-display" class="text-gray-200">Loading local station data...</div>
                </div>
                
                <!-- General Weather -->
                <div class="bg-gray-800 rounded-lg border border-cyan-700 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-cyan-300">üå°Ô∏è Weather</h3>
                        <div class="flex gap-2">
                            <button onclick="useCurrentLocation()" class="px-3 py-2 bg-cyan-700 hover:bg-cyan-600 rounded text-xs">Use Current</button>
                        </div>
                    </div>
                    <div class="flex gap-3 mb-3">
                        <input id="weather-search-input-2" type="text" placeholder="Search city or place..." class="flex-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded text-sm text-gray-200 placeholder-gray-500">
                        <button onclick="searchWeatherTo('weather-search-input-2','weather-search-results-2')" class="px-3 py-2 bg-cyan-700 hover:bg-cyan-600 rounded text-sm">Search</button>
                    </div>
                    <div id="weather-search-results-2" class="mb-3 text-sm text-gray-400"></div>
                    <div id="weather-display-2" class="text-gray-200">Loading...</div>
                    <div id="weather-forecast-2" class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2"></div>
                    <div id="weather-alerts-2" class="mt-4"></div>
                </div>
            </section>

            <!-- Calendar Section -->
            <section id="section-calendar" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Calendar</div>
                    <div class="text-xs text-gray-300">Family schedule and upcoming events</div>
                </div>
                <div class="bg-gray-800 rounded-lg border border-green-600 p-6">
                    <h3 class="text-2xl font-bold text-green-300 mb-4">
                        <i class="fas fa-calendar-alt mr-2"></i>Calendar
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-green-200 mb-3">Primary Calendar</h4>
                            <div id="calendar-primary" class="bg-gray-900 rounded border border-green-700 p-4 min-h-80 text-sm text-gray-400">Loading...</div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-200 mb-3">Family Calendar (iCloud)</h4>
                            <div id="calendar-family" class="bg-gray-900 rounded border border-blue-700 p-4 min-h-80 text-sm text-gray-400">Loading...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- News Section -->
            <section id="section-news" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">News</div>
                    <div class="text-xs text-gray-300">Curated updates and supportive tips</div>
                </div>
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">News</h2>
                        <div class="flex gap-2">
                            <select id="news-filter" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded text-sm text-gray-200">
                                <option value="all">All</option>
                                <option value="oregon">Oregon</option>
                                <option value="starwars">Star Wars</option>
                                <option value="startrek">Star Trek</option>
                            </select>
                            <button onclick="loadNews()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Refresh</button>
                        </div>
                    </div>
                    <div id="news-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-gray-400 col-span-full text-center py-8">Loading news...</div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-emerald-300 mb-2"><i class="fas fa-heart mr-2"></i>Calm Tips</h3>
                        <div id="calm-tips" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-gray-400 col-span-full text-center py-6">Loading calm tips...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Settings</div>
                    <div class="text-xs text-gray-300">Personalize your dashboard</div>
                </div>
                <div id="settings-container" class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <h2 class="text-2xl font-bold mb-4">Settings</h2>
                    <div class="text-gray-400">Loading settings...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <!-- Voice Settings Modal -->
    <div id="voice-settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-8 max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-300">ü§ñ Voice Settings</h2>
                <button onclick="closeVoiceSettings()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="voice-settings-content" class="space-y-6">Loading...</div>
        </div>
    </div>

    <!-- Garfield Archive Modal -->
    <div id="garfield-archive-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg border border-orange-600 p-8 max-w-4xl w-full max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-orange-300"><i class="fas fa-archive mr-2"></i>Garfield Archive</h2>
                <button onclick="closeGarfieldArchive()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="garfield-archive-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">Loading...</div>
        </div>
    </div>

    <!-- Comic Lightbox Modal -->
    <div id="comic-lightbox" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center cursor-pointer" onclick="closeComicLightbox(event)">
        <button onclick="closeComicLightbox(event)" class="absolute top-4 right-4 text-white hover:text-orange-400 text-4xl z-[70]" title="Close">&times;</button>
        <button onclick="prevComic(event)" class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-orange-400 text-4xl z-[70] p-2" title="Previous">&#10094;</button>
        <button onclick="nextComic(event)" class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-orange-400 text-4xl z-[70] p-2" title="Next">&#10095;</button>
        <div class="max-w-[95vw] max-h-[90vh] flex flex-col items-center" onclick="event.stopPropagation()">
            <img id="comic-lightbox-img" src="" alt="Comic" class="max-w-full max-h-[80vh] rounded-lg border-2 border-orange-500 shadow-2xl object-contain">
            <div class="flex items-center gap-4 mt-4">
                <button id="comic-favorite-btn" onclick="toggleComicFavorite(event)" class="text-2xl hover:scale-110 transition-transform" title="Add to Favorites">
                    <span id="comic-favorite-icon">ü§ç</span>
                </button>
                <div id="comic-lightbox-caption" class="text-orange-300 text-lg text-center"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/dashboard.js?v=7"></script>
    <script src="/static/leads_modern.js?v=7"></script>
    <script src="/static/trust_layer_ui.js?v=3"></script>
    <script src="/static/provider_manager.js?v=3"></script>

    <script>
        // Backgrounds
        const BACKGROUNDS = [
            { key: 'bg1', type: 'image', value: '/static/backgrounds/photo-1472457897821-70d3819a0e24.avif' },
            { key: 'bg2', type: 'image', value: '/static/backgrounds/photo-1618336753974-aae8e04506aa.avif' },
            { key: 'bg3', type: 'image', value: '/static/backgrounds/premium_photo-1721254102757-6ac520920e0a.avif' }
        ];

        function applyBackground(bg) {
            const layer = document.getElementById('app-bg');
            if (!layer) return;
            if (bg.type === 'gradient') {
                layer.style.backgroundImage = bg.value;
            } else {
                layer.style.backgroundImage = `url('${bg.value}')`;
            }
        }

        function setBackgroundByKey(key) {
            const idx = BACKGROUNDS.findIndex(b => b.key === key);
            const bg = idx >= 0 ? BACKGROUNDS[idx] : BACKGROUNDS[0];
            try { localStorage.setItem('dashboard_bg_key', bg.key); } catch {}
            const select = document.getElementById('bg-select');
            if (select) select.value = bg.key;
            applyBackground(bg);
        }

        function cycleBackground(dir = 1) {
            const current = (localStorage.getItem('dashboard_bg_key') || BACKGROUNDS[0].key);
            const idx = BACKGROUNDS.findIndex(b => b.key === current);
            const next = (idx + dir + BACKGROUNDS.length) % BACKGROUNDS.length;
            setBackgroundByKey(BACKGROUNDS[next].key);
        }

        function setBackgroundUrl(url) {
            if (!url) return;
            const bg = { key: 'custom-url', type: 'image', value: url };
            try { localStorage.setItem('dashboard_bg_custom', url); localStorage.setItem('dashboard_bg_key', bg.key); } catch {}
            const select = document.getElementById('bg-select');
            if (select) select.value = 'custom-url';
            const layer = document.getElementById('app-bg');
            if (layer) layer.style.backgroundImage = `url('${url}')`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('bg-select');
            const prev = document.getElementById('bg-prev');
            const next = document.getElementById('bg-next');
            const urlInput = document.getElementById('bg-url');
            const urlBtn = document.getElementById('bg-url-set');
            // Inject custom-url option if present
            try {
                const custom = localStorage.getItem('dashboard_bg_custom');
                if (custom && select && ![...select.options].some(o => o.value === 'custom-url')) {
                    const opt = document.createElement('option');
                    opt.value = 'custom-url'; opt.textContent = 'Custom URL';
                    select.appendChild(opt);
                }
            } catch {}
            if (select) {
                select.addEventListener('change', () => {
                    const v = select.value;
                    if (v === 'custom-url') {
                        const saved = localStorage.getItem('dashboard_bg_custom');
                        if (saved) setBackgroundUrl(saved);
                    } else {
                        setBackgroundByKey(v);
                    }
                });
            }
            if (prev) prev.addEventListener('click', () => cycleBackground(-1));
            if (next) next.addEventListener('click', () => cycleBackground(1));
            if (urlBtn) urlBtn.addEventListener('click', () => setBackgroundUrl(urlInput.value.trim()));
            // Initialize
            const stored = localStorage.getItem('dashboard_bg_key');
            if (stored === 'custom-url') {
                const cu = localStorage.getItem('dashboard_bg_custom');
                if (cu) setBackgroundUrl(cu); else setBackgroundByKey('bg1');
            } else if (stored) {
                setBackgroundByKey(stored);
            } else {
                setBackgroundByKey('bg1');
            }
            
            // Initialize skin system
            initializeSkin();
        });

        // =====================================================
        // SKIN/THEME SYSTEM
        // =====================================================
        
        let currentSkin = null;
        
        async function initializeSkin() {
            // Load saved skin preference or get active from server
            const savedSkin = localStorage.getItem('dashboard_skin') || 'roger';
            await switchSkin(savedSkin, false);
            
            // Update skin selector
            const skinSelect = document.getElementById('skin-select');
            if (skinSelect) {
                skinSelect.value = savedSkin;
            }
            
            console.log('‚úÖ Skin system initialized');
        }
        
        async function switchSkin(skinName, animate = true) {
            try {
                console.log(`üé® Switching to skin: ${skinName}`);
                
                // Fetch skin config from server
                const response = await fetch(`/api/skins/switch/${skinName}`, { method: 'POST' });
                const data = await response.json();
                
                if (!data.success) {
                    console.error('Failed to switch skin:', data.error);
                    return;
                }
                
                currentSkin = data.skin;
                console.log('üì¶ Skin data received:', JSON.stringify(currentSkin.dashboard?.widgets || {}, null, 2));
                localStorage.setItem('dashboard_skin', skinName);
                
                // Apply the skin (colors, avatar, widgets visibility)
                applySkin(currentSkin, animate);
                
                // Reload data for newly visible widgets
                initializeDataLoaders();
                
                console.log(`‚úÖ Skin applied: ${currentSkin.display_name}`);
                
            } catch (error) {
                console.error('Error switching skin:', error);
            }
        }
        
        function applySkin(skin, animate = true) {
            if (!skin) return;
            
            // Update CSS variables
            const cssVars = skin.css_variables || {};
            const root = document.documentElement;
            for (const [key, value] of Object.entries(cssVars)) {
                root.style.setProperty(key, value);
            }
            
            // Update page title
            document.getElementById('page-title').textContent = `${skin.display_name} - Personal Assistant`;
            
            // Update assistant avatar
            const avatar = document.getElementById('assistant-avatar');
            if (avatar && skin.avatar) {
                avatar.src = skin.avatar;
                avatar.alt = skin.display_name;
            }
            
            // Update assistant name
            const nameEl = document.getElementById('assistant-name');
            if (nameEl) {
                nameEl.textContent = skin.display_name;
            }
            
            // Update header title with tagline
            const headerTitle = document.getElementById('header-title');
            if (headerTitle && skin.tagline) {
                headerTitle.textContent = skin.tagline;
            }
            
            // Update ALL skin selectors (sidebar and header)
            const skinSelectors = ['skin-select', 'skin-select-header'];
            skinSelectors.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) sel.value = skin.name;
            });
            
            // Update backgrounds dropdown if skin has backgrounds
            if (skin.backgrounds && skin.backgrounds.length > 0) {
                updateBackgroundOptions(skin.backgrounds);
            }
            
            // MODULAR WIDGET SYSTEM - Show/hide widgets based on skin config
            applyWidgetVisibility(skin);
            
            // Update navigation if skin has custom nav
            if (skin.navigation && skin.navigation.length > 0) {
                // Could update nav labels/icons here
            }
            
            // Apply animation effect
            if (animate) {
                document.body.style.opacity = '0.8';
                setTimeout(() => {
                    document.body.style.opacity = '1';
                }, 150);
            }
            
            console.log(`üé® Theme applied: ${skin.display_name} - Colors and widgets updated!`);
        }
        
        // Widget visibility management based on skin config
        function applyWidgetVisibility(skin) {
            if (!skin || !skin.dashboard || !skin.dashboard.widgets) {
                console.log('‚ö†Ô∏è No widget config in skin, showing all widgets');
                return;
            }
            
            const widgets = skin.dashboard.widgets;
            console.log(`üéõÔ∏è Applying widget visibility for ${skin.name}:`, widgets);
            
            // Find all widget containers and apply visibility
            document.querySelectorAll('[data-widget]').forEach(container => {
                const widgetName = container.dataset.widget;
                const widgetConfig = widgets[widgetName];
                
                // Check if widget is explicitly enabled
                const isEnabled = widgetConfig && widgetConfig.enabled === true;
                
                if (isEnabled) {
                    container.classList.remove('hidden');
                    container.style.display = '';  // Reset any inline display style
                    console.log(`  ‚úÖ ${widgetName}: SHOW`);
                } else {
                    container.classList.add('hidden');
                    container.style.display = 'none';  // Force hide with inline style too
                    console.log(`  ‚ùå ${widgetName}: HIDE`);
                }
            });
            
            console.log('üéõÔ∏è Widget visibility applied!');
        }
        
        // Load Dracula-specific quote
        async function loadDraculaQuote() {
            const el = document.getElementById('dracula-quotes');
            if (!el || !currentSkin) return;
            
            const quote = getSkinQuote('random_quotes') || getSkinQuote('greetings');
            if (quote) {
                el.innerHTML = `<p class="italic">"${quote}"</p>`;
            }
        }
        
        // Read Dracula quote aloud
        async function readDraculaQuote() {
            const el = document.getElementById('dracula-quotes');
            if (!el) return;
            const text = el.innerText;
            try {
                await fetch('/api/voice/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, style: currentSkin?.voice?.style || 'dramatic' })
                });
            } catch (e) {
                console.error('Dracula quote read error:', e);
            }
        }
        
        // Dark news loader for Dracula theme
        async function loadDarkNews(category = 'all') {
            const list = document.getElementById('dark-news-list');
            if (!list) return;
            
            list.innerHTML = '<div class="text-center py-4" style="color: var(--skin-text-muted);">Loading dark news...</div>';
            
            // For now, show placeholder content - in production, this would call an API
            const darkNewsItems = {
                horror: [
                    { title: 'üßõ New Dracula Adaptation Announced', source: 'Horror News', link: '#' },
                    { title: 'üëª Best Horror Movies of 2024', source: 'Dread Central', link: '#' },
                    { title: 'üéÉ Halloween Horror Nights Preview', source: 'Bloody Disgusting', link: '#' }
                ],
                fantasy: [
                    { title: 'üêâ Game of Thrones Spinoff Update', source: 'Fantasy Hive', link: '#' },
                    { title: 'üìö Brandon Sanderson New Book', source: 'Tor.com', link: '#' },
                    { title: 'üßô D&D Movie Sequel News', source: 'IGN', link: '#' }
                ],
                '90s_music': [
                    { title: 'üé∏ Smashing Pumpkins Reunion Tour', source: 'Rolling Stone', link: '#' },
                    { title: 'üé§ Portishead Reissue Announced', source: 'Pitchfork', link: '#' },
                    { title: 'üéπ Massive Attack Documentary', source: 'NME', link: '#' }
                ],
                gothic: [
                    { title: 'ü¶á Sisters of Mercy Live Dates', source: 'Post-Punk.com', link: '#' },
                    { title: 'üñ§ The Cure New Album Rumors', source: 'Stereogum', link: '#' },
                    { title: 'üåô Bauhaus Retrospective', source: 'The Quietus', link: '#' }
                ]
            };
            
            let items = [];
            if (category === 'all') {
                Object.values(darkNewsItems).forEach(arr => items.push(...arr));
            } else {
                items = darkNewsItems[category] || [];
            }
            
            if (items.length === 0) {
                list.innerHTML = '<div class="text-center py-4" style="color: var(--skin-text-muted);">No dark news found...</div>';
                return;
            }
            
            list.innerHTML = items.map(item => `
                <a href="${item.link}" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                    <div class="font-semibold" style="color: var(--skin-text-primary);">${item.title}</div>
                    <div class="text-xs" style="color: var(--skin-text-muted);">${item.source}</div>
                </a>
            `).join('');
        }
        
        // Music player - Last.fm integration
        let currentStation = null;
        
        async function loadMusicStation(stationId = null) {
            const station = stationId || document.getElementById('lastfm-station')?.value || '90s_alternative';
            const nowPlaying = document.getElementById('now-playing');
            const recentTracks = document.getElementById('recent-tracks');
            
            if (nowPlaying) {
                nowPlaying.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 rounded flex items-center justify-center text-2xl animate-pulse" style="background-color: var(--skin-bg-tertiary);">üéµ</div>
                        <div>
                            <div class="font-semibold">Loading ${station.replace(/_/g, ' ')}...</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Fetching tracks from Last.fm</div>
                        </div>
                    </div>
                `;
            }
            
            try {
                const response = await fetch(`/api/music/station/${station}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    currentStation = data.data;
                    displayMusicStation(data.data);
                } else {
                    displayMusicError(data.error || 'Failed to load station');
                }
            } catch (error) {
                console.error('Music station error:', error);
                displayMusicError('Connection error');
            }
        }
        
        function displayMusicStation(data) {
            const nowPlaying = document.getElementById('now-playing');
            const recentTracks = document.getElementById('recent-tracks');
            
            if (nowPlaying && data.tracks && data.tracks.length > 0) {
                const featured = data.tracks[0];
                nowPlaying.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 rounded overflow-hidden" style="background-color: var(--skin-bg-tertiary);">
                            ${featured.image ? `<img src="${featured.image}" class="w-full h-full object-cover" alt="${featured.name}">` : '<div class="w-full h-full flex items-center justify-center text-2xl">üéµ</div>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold truncate" style="color: var(--skin-text-primary);">${featured.name}</div>
                            <div class="text-sm truncate" style="color: var(--skin-text-secondary);">${featured.artist}</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">${Number(featured.listeners).toLocaleString()} listeners</div>
                        </div>
                        <a href="${featured.url}" target="_blank" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">
                            Open ‚Üó
                        </a>
                    </div>
                `;
            }
            
            if (recentTracks && data.tracks && data.tracks.length > 1) {
                recentTracks.innerHTML = `
                    <div class="text-xs uppercase tracking-wide mb-2" style="color: var(--skin-text-muted);">Top Tracks - ${data.tag}</div>
                    ${data.tracks.slice(1, 6).map(track => `
                        <a href="${track.url}" target="_blank" class="flex items-center gap-2 p-2 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="w-8 h-8 rounded overflow-hidden flex-shrink-0" style="background-color: var(--skin-bg-primary);">
                                ${track.image ? `<img src="${track.image}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-sm">üéµ</div>'}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm truncate" style="color: var(--skin-text-primary);">${track.name}</div>
                                <div class="text-xs truncate" style="color: var(--skin-text-muted);">${track.artist}</div>
                            </div>
                        </a>
                    `).join('')}
                `;
            }
        }
        
        function displayMusicError(error) {
            const nowPlaying = document.getElementById('now-playing');
            if (nowPlaying) {
                nowPlaying.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 rounded flex items-center justify-center text-2xl" style="background-color: var(--skin-bg-tertiary);">‚ö†Ô∏è</div>
                        <div>
                            <div class="font-semibold" style="color: var(--skin-accent);">Music Unavailable</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">${error}</div>
                            <div class="text-xs mt-1" style="color: var(--skin-text-muted);">Set LASTFM_API_KEY in .env to enable</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function toggleMusicPlayer() {
            loadMusicStation();
        }
        
        // Auto-load when station selection changes
        document.addEventListener('DOMContentLoaded', () => {
            const stationSelect = document.getElementById('lastfm-station');
            if (stationSelect) {
                stationSelect.addEventListener('change', () => loadMusicStation());
            }
        });
        
        // Art/Music communities loaders (placeholders)
        function loadArtCommunities() {
            console.log('Art communities loaded');
        }
        
        function loadMusicCommunities() {
            console.log('Music communities loaded');
        }
        
        function updateBackgroundOptions(backgrounds) {
            const bgSelect = document.getElementById('bg-select');
            if (!bgSelect) return;
            
            // Clear existing options
            bgSelect.innerHTML = '';
            
            // Clear and rebuild BACKGROUNDS array from skin config
            BACKGROUNDS.length = 0;
            
            // Add new options from skin
            backgrounds.forEach((bg, index) => {
                const option = document.createElement('option');
                option.value = `bg${index + 1}`;
                option.textContent = bg.name || `Background ${index + 1}`;
                bgSelect.appendChild(option);
                
                // Add to BACKGROUNDS array
                BACKGROUNDS.push({
                    key: `bg${index + 1}`,
                    type: 'image',
                    value: `/static/backgrounds/${bg.file}`
                });
            });
            
            // Add custom URL option
            const customOption = document.createElement('option');
            customOption.value = 'custom-url';
            customOption.textContent = 'Custom URL';
            bgSelect.appendChild(customOption);
            
            console.log('üñºÔ∏è Updated backgrounds:', BACKGROUNDS);
            
            // Apply first background
            if (BACKGROUNDS.length > 0) {
                setBackgroundByKey('bg1');
            }
        }
        
        function getSkinQuote(category = 'random_quotes') {
            if (!currentSkin || !currentSkin.quotes) return null;
            const quotes = currentSkin.quotes[category] || currentSkin.quotes.random_quotes || [];
            if (quotes.length === 0) return null;
            return quotes[Math.floor(Math.random() * quotes.length)];
        }
        
        // Get skin-specific greeting
        function getSkinGreeting() {
            return getSkinQuote('greetings') || currentSkin?.signature_phrase || 'Hello!';
        }

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-gray-700', 'text-white');
                link.classList.add('text-gray-300');
            });

            const section = document.getElementById(`section-${sectionName}`);
            if (section) {
                section.classList.remove('hidden');
                // Load section-specific data
                if (sectionName === 'calendar') {
                    loadFamilyCalendar();
                } else if (sectionName === 'weather') {
                    // Load local weather station first
                    loadAmbientWeather();
                    // Then load general weather
                    try {
                        const saved = JSON.parse(localStorage.getItem('weather_selected') || 'null');
                        if (saved && saved.lat && saved.lon) {
                            loadWeather(saved.lat, saved.lon, saved.name || null);
                            // mirror to weather section elements
                            mirrorWeatherToSection();
                        } else {
                            useCurrentLocation();
                            mirrorWeatherToSection();
                        }
                    } catch {
                        loadWeather();
                        mirrorWeatherToSection();
                    }
                } else if (sectionName === 'news') {
                    loadNews();
                    loadCalmTips();
                } else if (sectionName === 'settings') {
                    loadSettings();
                } else if (sectionName === 'overview') {
                    // Ensure overview content is fresh when switching back
                    reloadComic();
                    loadJokes();
                    loadQuote();
                    loadEbayAuctions();
                }
                if (typeof event !== 'undefined' && event && event.target) {
                    const navLink = event.target.closest('.nav-link');
                    if (navLink) {
                        navLink.classList.add('bg-gray-700', 'text-white');
                        navLink.classList.remove('text-gray-300');
                    }
                }
            }
        }

        function mirrorWeatherToSection() {
            // Copy overview weather content to standalone section
            const srcDisplay = document.getElementById('weather-display');
            const srcForecast = document.getElementById('weather-forecast');
            const srcAlerts = document.getElementById('weather-alerts');
            const dstDisplay = document.getElementById('weather-display-2');
            const dstForecast = document.getElementById('weather-forecast-2');
            const dstAlerts = document.getElementById('weather-alerts-2');
            if (srcDisplay && dstDisplay) dstDisplay.innerHTML = srcDisplay.innerHTML;
            if (srcForecast && dstForecast) dstForecast.innerHTML = srcForecast.innerHTML;
            if (srcAlerts && dstAlerts) dstAlerts.innerHTML = srcAlerts.innerHTML;
        }

        // Roger voice controls
        async function toggleWakeWord() {
            try {
                const current = await (await fetch('/api/voice/settings')).json();
                const v = current.voice || {};
                const newVal = !v.wake_word_enabled;
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wake_word_enabled: newVal })
                });
                alert(newVal ? 'Roger is now listening for wake word.' : 'Roger wake word listening disabled.');
            } catch (e) {
                console.error('Wake word toggle failed', e);
            }
        }

        async function promptSpeak() {
            const text = prompt('Ask Roger:');
            if (!text) return;
            try {
                const r = await fetch('/api/voice/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, style: 'droid', signature: false })
                });
                const data = await r.json();
                if (!data.success) console.warn('Voice speak failed', data);
            } catch (e) {
                console.error('Speak error', e);
            }
        }

        // Voice Settings
        function openVoiceSettings() {
            document.getElementById('voice-settings-modal').classList.remove('hidden');
            loadVoiceSettings();
        }

        function closeVoiceSettings() {
            document.getElementById('voice-settings-modal').classList.add('hidden');
        }

        async function loadVoiceSettings() {
            const content = document.getElementById('voice-settings-content');
            try {
                const resp = await fetch('/api/voice/settings');
                const data = await resp.json();
                if (data && data.voice) {
                    const s = data.voice;
                    content.innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Voice Style</label>
                                <select id="voice-style" onchange="updateVoiceSetting('style')" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                                    <option value="droid" ${s.default_style === 'droid' ? 'selected' : ''}>ü§ñ Droid (Battle Droid)</option>
                                    <option value="radio" ${s.default_style === 'radio' ? 'selected' : ''}>üìª Radio</option>
                                    <option value="pa_system" ${s.default_style === 'pa_system' ? 'selected' : ''}>üì¢ PA System</option>
                                    <option value="clean" ${s.default_style === 'clean' ? 'selected' : ''}>üîä Clean (No Effects)</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">üé¨ Authentic Battle Droid Samples</label>
                                    <p class="text-xs text-gray-400">Use real Star Wars audio for signature phrases</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="use-authentic" ${s.use_authentic_samples !== false ? 'checked' : ''} onchange="updateVoiceSetting('authentic')" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Speed: <span id="speed-value">${(s.speed || 0.75).toFixed(2)}</span>x</label>
                                <input type="range" id="voice-speed" min="0.5" max="1.5" step="0.05" value="${s.speed || 0.75}" oninput="document.getElementById('speed-value').textContent = this.value" onchange="updateVoiceSetting('speed')" class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Pitch: <span id="pitch-value">${(s.pitch || 0.85).toFixed(2)}</span>x</label>
                                <input type="range" id="voice-pitch" min="0.5" max="1.5" step="0.05" value="${s.pitch || 0.85}" oninput="document.getElementById('pitch-value').textContent = this.value" onchange="updateVoiceSetting('pitch')" class="w-full">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveVoiceSettings()" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold">Save Settings</button>
                                <button onclick="testVoice()" id="test-voice-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-semibold">üîä Test</button>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error loading voice settings:', e);
                content.innerHTML = '<div class="text-red-400">Error loading settings</div>';
            }
        }

        async function updateVoiceSetting(field) {
            const speed = parseFloat(document.getElementById('voice-speed')?.value || 0.75);
            const pitch = parseFloat(document.getElementById('voice-pitch')?.value || 0.85);
            const style = document.getElementById('voice-style')?.value || 'droid';
            const useAuthentic = document.getElementById('use-authentic')?.checked !== false;

            if (field === 'speed') {
                document.getElementById('speed-value').textContent = speed.toFixed(2);
            }
            if (field === 'pitch') {
                document.getElementById('pitch-value').textContent = pitch.toFixed(2);
            }

            try {
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        default_style: style,
                        speed: speed,
                        pitch: pitch,
                        use_authentic_samples: useAuthentic
                    })
                });
            } catch (e) {
                console.error('Error updating voice setting:', e);
            }
        }

        async function saveVoiceSettings() {
            try {
                const style = document.getElementById('voice-style')?.value || 'droid';
                const speed = parseFloat(document.getElementById('voice-speed')?.value || 0.75);
                const pitch = parseFloat(document.getElementById('voice-pitch')?.value || 0.85);
                const useAuthentic = document.getElementById('use-authentic')?.checked !== false;
                
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        default_style: style,
                        speed: speed,
                        pitch: pitch,
                        use_authentic_samples: useAuthentic
                    })
                });
                closeVoiceSettings();
            } catch (e) {
                console.error('Save voice settings error:', e);
                alert('Failed to save settings');
            }
        }

        async function testVoice() {
            const testBtn = document.getElementById('test-voice-btn');
            if (testBtn) testBtn.disabled = true;
            try {
                const r = await fetch('/api/voice/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'Roger roger. Voice test complete.', style: 'droid', signature: true })
                });
                const data = await r.json();
                if (!data.success) alert('Voice test failed: ' + (data.error || 'Unknown error'));
            } catch (e) {
                console.error('Voice test error:', e);
            } finally {
                if (testBtn) testBtn.disabled = false;
            }
        }

        // Read functions for voice
        async function readJokes() {
            const jokesEl = document.getElementById('jokes');
            if (!jokesEl) return;
            const text = jokesEl.innerText || 'No jokes loaded';
            try {
                await fetch('/api/voice/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, style: 'droid', signature: true })
                });
            } catch (e) {
                console.error('Read jokes error:', e);
            }
        }

        async function readQuote() {
            const quoteEl = document.getElementById('quote');
            if (!quoteEl) return;
            const text = quoteEl.innerText || 'No quote loaded';
            try {
                await fetch('/api/voice/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, style: 'droid', signature: false })
                });
            } catch (e) {
                console.error('Read quote error:', e);
            }
        }

        async function readRogerQuote() {
            const el = document.getElementById('roger-quotes');
            if (!el) return;
            const text = el.innerText || 'No quote loaded';
            try {
                await fetch('/api/voice/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, style: 'droid', signature: true })
                });
            } catch (e) {
                console.error('Read roger quote error:', e);
            }
        }

        // OAuth Connect Functions
        function connectGoogle() {
            window.open('/auth/google', 'google_oauth', 'width=500,height=600,popup=yes');
        }

        function connectMicrosoft() {
            window.open('/auth/microsoft', 'microsoft_oauth', 'width=500,height=600,popup=yes');
        }

        function connectProton() {
            // Proton uses Bridge - show configuration modal
            alert('Proton Bridge Setup:\n\n1. Install Proton Mail Bridge on your system\n2. Log in to the Bridge application\n3. Configure IMAP/SMTP credentials in credentials.yaml\n\nSee PROVIDER_SETUP.md for detailed instructions.');
        }

        // Settings Page Loader
        async function loadSettings() {
            const container = document.getElementById('settings-container');
            if (!container) return;
            
            try {
                // Fetch voice settings and auth status
                const voiceResp = await fetch('/api/voice/settings');
                const voiceData = await voiceResp.json();
                const v = voiceData.voice || {};
                
                // Check auth status for each provider
                let googleStatus = { authenticated: false };
                let microsoftStatus = { authenticated: false };
                let protonStatus = { authenticated: false };
                
                try {
                    const gResp = await fetch('/api/auth/google/status');
                    googleStatus = await gResp.json();
                } catch (e) { console.log('Google auth check skipped'); }
                
                // Microsoft and Proton auth not yet implemented
                // try {
                //     const mResp = await fetch('/api/auth/microsoft/status');
                //     microsoftStatus = await mResp.json();
                // } catch (e) { console.log('Microsoft auth check skipped'); }
                
                // try {
                //     const pResp = await fetch('/api/auth/proton/status');
                //     protonStatus = await pResp.json();
                // } catch (e) { console.log('Proton auth check skipped'); }
                
                // Get saved preferences from localStorage
                const bgKey = localStorage.getItem('dashboard_bg_key') || 'bg1';
                const weatherLoc = JSON.parse(localStorage.getItem('weather_selected') || '{}');
                
                container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Settings</h2>
                    
                    <!-- Connected Accounts -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-link mr-2"></i>Connected Accounts</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <img src="https://www.google.com/favicon.ico" class="w-5 h-5" alt="Google">
                                        <span class="font-semibold">Google</span>
                                    </div>
                                    <span class="text-xs ${googleStatus.authenticated ? 'text-green-400' : 'text-gray-500'}">${googleStatus.authenticated ? '‚úì Connected' : 'Not connected'}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">Gmail, Calendar, Drive</p>
                                <button onclick="connectGoogle()" class="w-full px-3 py-2 ${googleStatus.authenticated ? 'bg-green-700 hover:bg-green-600' : 'bg-blue-600 hover:bg-blue-700'} rounded text-sm">
                                    ${googleStatus.authenticated ? '‚úì Reconnect' : 'Connect Google'}
                                </button>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <img src="https://www.microsoft.com/favicon.ico" class="w-5 h-5" alt="Microsoft">
                                        <span class="font-semibold">Microsoft 365</span>
                                    </div>
                                    <span class="text-xs ${microsoftStatus.authenticated ? 'text-green-400' : 'text-gray-500'}">${microsoftStatus.authenticated ? '‚úì Connected' : 'Not connected'}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">Outlook, OneDrive, Teams</p>
                                <button onclick="connectMicrosoft()" class="w-full px-3 py-2 ${microsoftStatus.authenticated ? 'bg-green-700 hover:bg-green-600' : 'bg-blue-600 hover:bg-blue-700'} rounded text-sm">
                                    ${microsoftStatus.authenticated ? '‚úì Reconnect' : 'Connect Microsoft'}
                                </button>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">üîí</span>
                                        <span class="font-semibold">Proton</span>
                                    </div>
                                    <span class="text-xs ${protonStatus.authenticated ? 'text-green-400' : 'text-gray-500'}">${protonStatus.authenticated ? '‚úì Connected' : 'Not connected'}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">ProtonMail via Bridge</p>
                                <button onclick="connectProton()" class="w-full px-3 py-2 ${protonStatus.authenticated ? 'bg-green-700 hover:bg-green-600' : 'bg-purple-600 hover:bg-purple-700'} rounded text-sm">
                                    ${protonStatus.authenticated ? '‚úì Reconnect' : 'Connect Proton'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Appearance -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-palette mr-2"></i>Appearance</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Background Theme</label>
                                <div class="text-sm text-gray-400 mb-2">Current: ${bgKey}</div>
                                <div class="flex gap-2">
                                    <button onclick="setBackgroundByKey('bg1')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Theme 1</button>
                                    <button onclick="setBackgroundByKey('bg2')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Theme 2</button>
                                    <button onclick="setBackgroundByKey('bg3')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Theme 3</button>
                                </div>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Default Weather Location</label>
                                <div class="text-sm text-gray-400">${weatherLoc.name || 'Not set - using current location'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voice Settings -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-microphone mr-2"></i>Voice (Roger)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Voice Style</label>
                                <select id="settings-voice-style" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mb-3">
                                    <option value="droid" ${v.default_style === 'droid' ? 'selected' : ''}>ü§ñ Droid (Battle Droid)</option>
                                    <option value="radio" ${v.default_style === 'radio' ? 'selected' : ''}>üìª Radio</option>
                                    <option value="pa_system" ${v.default_style === 'pa_system' ? 'selected' : ''}>üì¢ PA System</option>
                                    <option value="clean" ${v.default_style === 'clean' ? 'selected' : ''}>üîä Clean (No Effects)</option>
                                </select>
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm">Authentic Battle Droid Samples</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="settings-authentic" ${v.use_authentic_samples !== false ? 'checked' : ''} class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <span class="text-sm">Random Sarcasm</span>
                                        <div class="text-xs text-gray-500">Roger adds occasional sarcastic comments</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="settings-sarcasm" ${v.sarcasm_enabled ? 'checked' : ''} class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Speed: <span id="settings-speed-value">${(v.speed || 0.75).toFixed(2)}</span>x</label>
                                <input type="range" id="settings-voice-speed" min="0.5" max="1.5" step="0.05" value="${v.speed || 0.75}" oninput="document.getElementById('settings-speed-value').textContent = this.value" class="w-full mb-3">
                                <label class="block text-sm font-semibold mb-2">Pitch: <span id="settings-pitch-value">${(v.pitch || 0.85).toFixed(2)}</span>x</label>
                                <input type="range" id="settings-voice-pitch" min="0.5" max="1.5" step="0.05" value="${v.pitch || 0.85}" oninput="document.getElementById('settings-pitch-value').textContent = this.value" class="w-full mb-3">
                                <label class="block text-sm font-semibold mb-2">Sarcasm Chance: <span id="settings-sarcasm-value">${Math.round((v.sarcasm_chance || 0.4) * 100)}</span>%</label>
                                <input type="range" id="settings-sarcasm-chance" min="0" max="100" step="5" value="${Math.round((v.sarcasm_chance || 0.4) * 100)}" oninput="document.getElementById('settings-sarcasm-value').textContent = this.value" class="w-full">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="saveSettingsVoice()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">Save Voice Settings</button>
                            <button onclick="testVoice()" id="settings-test-voice-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">üîä Test Voice</button>
                        </div>
                    </div>
                    
                    <!-- Comics Settings -->
                    <div class="mb-8" id="comics-settings-section">
                        <h3 class="text-lg font-semibold text-orange-300 mb-4"><i class="fas fa-book-open mr-2"></i>Comics</h3>
                        <div id="comics-settings-content" class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <div class="text-gray-400">Loading comics settings...</div>
                        </div>
                    </div>
                    
                    <!-- Data & Privacy -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-database mr-2"></i>Data & Privacy</h3>
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <div class="font-semibold">Clear Local Cache</div>
                                    <div class="text-xs text-gray-500">Remove cached data and preferences</div>
                                </div>
                                <button onclick="if(confirm('Clear all local data?')){localStorage.clear();location.reload();}" class="px-3 py-2 bg-red-700 hover:bg-red-600 rounded text-sm">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- About -->
                    <div>
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-info-circle mr-2"></i>About</h3>
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <div class="text-sm text-gray-300">R0-GR Personal Dashboard</div>
                            <div class="text-xs text-gray-500 mt-1">A Buildly Labs project</div>
                            <div class="text-xs text-gray-500 mt-1">Voice: Piper TTS with custom droid effects</div>
                        </div>
                    </div>
                `;
                // Load comics settings after main template renders
                loadComicsSettings();
            } catch (e) {
                console.error('Settings load error:', e);
                container.innerHTML = '<div class="text-red-400">Error loading settings</div>';
            }
        }

        // Comics Settings Functions
        async function loadComicsSettings() {
            const content = document.getElementById('comics-settings-content');
            if (!content) return;
            
            try {
                const resp = await fetch('/api/settings/comics');
                const data = await resp.json();
                
                if (!data.success) {
                    content.innerHTML = '<div class="text-red-400">Error loading comics settings</div>';
                    return;
                }
                
                const comics = data.comics || {};
                
                let comicsHtml = '';
                Object.entries(comics).forEach(([id, comic]) => {
                    const borderClass = comic.archive_count > 0 ? 'border-gray-700' : 'border-yellow-700/50';
                    const sourceIcon = comic.source === 'archive' ? 'üìÇ' : 'üåê';
                    const sourceText = comic.source === 'gocomics' ? 'GoComics' : 'Local Archive';
                    const customText = comic.custom ? ' ‚Ä¢ Custom' : '';
                    const archiveCountClass = comic.archive_count > 0 ? 'text-green-400' : 'text-yellow-400';
                    const archiveCount = comic.archive_count || 0;
                    const noArchiveBadge = comic.archive_count === 0 ? '<span class="text-xs text-yellow-400 bg-yellow-900/30 px-2 py-1 rounded">No archive</span>' : '';
                    const archiveChecked = comic.archive_enabled !== false ? 'checked' : '';
                    const enabledChecked = comic.enabled !== false ? 'checked' : '';
                    const removeBtn = comic.custom ? '<button data-comic-id="'+id+'" onclick="removeComic(this.dataset.comicId)" class="px-2 py-1 bg-red-700 hover:bg-red-600 rounded text-xs" title="Remove comic"><i class="fas fa-trash"></i></button>' : '';
                    
                    comicsHtml += '<div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg border '+borderClass+' hover:border-gray-600">' +
                        '<div class="flex items-center gap-3">' +
                            '<span class="text-lg">'+sourceIcon+'</span>' +
                            '<div>' +
                                '<div class="font-semibold text-gray-200">'+comic.name+'</div>' +
                                '<div class="text-xs text-gray-500">'+sourceText+customText+' ‚Ä¢ <span class="'+archiveCountClass+'">'+archiveCount+' archived</span></div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-4">' +
                            noArchiveBadge +
                            '<div class="flex items-center gap-2">' +
                                '<span class="text-xs text-gray-400">Archive</span>' +
                                '<label class="relative inline-flex items-center cursor-pointer">' +
                                    '<input type="checkbox" id="archive-'+id+'" '+archiveChecked+' onchange="updateComicSetting(this.id.replace(\'archive-\',\'\'), \'archive_enabled\', this.checked)" class="sr-only peer">' +
                                    '<div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-600"></div>' +
                                '</label>' +
                            '</div>' +
                            '<div class="flex items-center gap-2">' +
                                '<span class="text-xs text-gray-400">Show</span>' +
                                '<label class="relative inline-flex items-center cursor-pointer">' +
                                    '<input type="checkbox" id="enabled-'+id+'" '+enabledChecked+' onchange="updateComicSetting(this.id.replace(\'enabled-\',\'\'), \'enabled\', this.checked)" class="sr-only peer">' +
                                    '<div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>' +
                                '</label>' +
                            '</div>' +
                            removeBtn +
                        '</div>' +
                    '</div>';
                });
                
                content.innerHTML = 
                    '<div class="mb-6 p-4 bg-gray-800 rounded-lg border border-orange-600">' +
                        '<h4 class="text-sm font-semibold text-orange-300 mb-3"><i class="fas fa-plus-circle mr-2"></i>Add Comic from GoComics</h4>' +
                        '<div class="flex gap-2">' +
                            '<input type="url" id="new-comic-url" placeholder="https://www.gocomics.com/comic-name" class="flex-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded text-sm text-gray-200 placeholder-gray-500">' +
                            '<button onclick="addComicFromUrl()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded text-sm whitespace-nowrap"><i class="fas fa-plus mr-1"></i>Add</button>' +
                        '</div>' +
                        '<div class="text-xs text-gray-500 mt-2">Paste a GoComics URL to add a new comic strip</div>' +
                        '<div id="add-comic-status" class="text-xs mt-2 hidden"></div>' +
                    '</div>' +
                    '<div class="space-y-3">' +
                        '<div class="text-sm font-semibold text-gray-300 mb-2">Manage Comics</div>' +
                        comicsHtml +
                    '</div>' +
                    '<div class="mt-4 text-xs text-gray-500">' +
                        '<i class="fas fa-info-circle mr-1"></i>' +
                        '<strong>Show:</strong> Display comic in the dropdown. ' +
                        '<strong>Archive:</strong> Save comics to your local archive as they are viewed.' +
                    '</div>';
            } catch (e) {
                console.error('Error loading comics settings:', e);
                content.innerHTML = '<div class="text-red-400">Error loading comics settings</div>';
            }
        }

        async function updateComicSetting(comicId, field, value) {
            try {
                const resp = await fetch('/api/settings/comics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        comics: {
                            [comicId]: { [field]: value }
                        }
                    })
                });
                const data = await resp.json();
                if (!data.success) {
                    console.error('Failed to update comic setting:', data.error);
                }
                // Refresh the comic dropdown
                updateComicDropdown();
            } catch (e) {
                console.error('Error updating comic setting:', e);
            }
        }

        async function addComicFromUrl() {
            const input = document.getElementById('new-comic-url');
            const status = document.getElementById('add-comic-status');
            const url = input?.value?.trim();
            
            if (!url) {
                status.textContent = 'Please enter a URL';
                status.className = 'text-xs mt-2 text-yellow-400';
                status.classList.remove('hidden');
                return;
            }
            
            status.textContent = 'Adding comic...';
            status.className = 'text-xs mt-2 text-gray-400';
            status.classList.remove('hidden');
            
            try {
                const resp = await fetch('/api/settings/comics/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await resp.json();
                
                if (data.success) {
                    status.textContent = '‚úì Added "' + (data.comic?.name || 'Comic') + '"';
                    status.className = 'text-xs mt-2 text-green-400';
                    input.value = '';
                    // Refresh the comics list and dropdown
                    loadComicsSettings();
                    updateComicDropdown();
                } else {
                    status.textContent = '‚úó ' + (data.error || 'Failed to add comic');
                    status.className = 'text-xs mt-2 text-red-400';
                }
            } catch (e) {
                console.error('Error adding comic:', e);
                status.textContent = '‚úó Error adding comic';
                status.className = 'text-xs mt-2 text-red-400';
            }
        }

        async function removeComic(comicId) {
            if (!confirm('Remove this comic from your list?')) return;
            
            try {
                const resp = await fetch('/api/settings/comics/' + comicId, {
                    method: 'DELETE'
                });
                const data = await resp.json();
                
                if (data.success) {
                    loadComicsSettings();
                    updateComicDropdown();
                } else {
                    alert(data.error || 'Failed to remove comic');
                }
            } catch (e) {
                console.error('Error removing comic:', e);
                alert('Error removing comic');
            }
        }

        async function updateComicDropdown() {
            const select = document.getElementById('comic-select');
            if (!select) return;
            
            try {
                const resp = await fetch('/api/settings/comics');
                const data = await resp.json();
                
                if (!data.success) return;
                
                const comics = data.comics || {};
                const currentValue = select.value;
                
                // Rebuild the dropdown with only enabled comics that have content available
                // GoComics sources always work (live fetch), archive sources need archives
                select.innerHTML = '';
                
                Object.entries(comics)
                    .filter(([id, comic]) => {
                        if (comic.enabled === false) return false;
                        // GoComics can always fetch live
                        if (comic.source === 'gocomics' || comic.gocomics_slug) return true;
                        // Archive-only sources need actual archives
                        return comic.archive_count > 0;
                    })
                    .forEach(([id, comic]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        // Show archive count for comics with large archives
                        if (comic.archive_count >= 10) {
                            option.textContent = `${comic.name} (${comic.archive_count})`;
                        } else {
                            option.textContent = comic.name;
                        }
                        select.appendChild(option);
                    });
                
                // Add favorites option if there are any comics with archives
                const hasArchives = Object.values(comics).some(c => c.archive_count > 0);
                if (hasArchives) {
                    const favOption = document.createElement('option');
                    favOption.value = 'favorites';
                    favOption.textContent = 'Favorites';
                    select.appendChild(favOption);
                }
                
                // Restore selection if still available, otherwise select first
                if ([...select.options].some(o => o.value === currentValue)) {
                    select.value = currentValue;
                } else if (select.options.length > 0) {
                    select.value = select.options[0].value;
                }
            } catch (e) {
                console.error('Error updating comic dropdown:', e);
            }
        }

        async function saveSettingsVoice() {
            try {
                const style = document.getElementById('settings-voice-style')?.value || 'droid';
                const speed = parseFloat(document.getElementById('settings-voice-speed')?.value || 0.75);
                const pitch = parseFloat(document.getElementById('settings-voice-pitch')?.value || 0.85);
                const useAuthentic = document.getElementById('settings-authentic')?.checked !== false;
                const sarcasmEnabled = document.getElementById('settings-sarcasm')?.checked || false;
                const sarcasmChance = (parseInt(document.getElementById('settings-sarcasm-chance')?.value || 40)) / 100;
                
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        default_style: style,
                        speed: speed,
                        pitch: pitch,
                        use_authentic_samples: useAuthentic,
                        sarcasm_enabled: sarcasmEnabled,
                        sarcasm_chance: sarcasmChance
                    })
                });
                alert('Voice settings saved!');
            } catch (e) {
                console.error('Save voice settings error:', e);
                alert('Failed to save settings');
            }
        }

        // Comics
        let currentComicList = [];
        let currentComicIndex = 0;
        let currentComicSeries = 'garfield';

        async function loadComicArchive(series) {
            try {
                const resp = await fetch(`/api/comics/${series}/archive?limit=500`);
                const data = await resp.json();
                if (data.success && data.comics && data.comics.length > 0) {
                    currentComicList = data.comics;
                    currentComicSeries = series;
                    return true;
                }
            } catch (e) {
                console.error('Failed to load archive:', e);
            }
            return false;
        }

        // Track favorites for current session
        let comicFavorites = new Set();
        
        async function loadComicFavorites() {
            try {
                const resp = await fetch('/api/comics/favorites');
                const data = await resp.json();
                if (data.success && data.favorites) {
                    comicFavorites = new Set(data.favorites.map(f => `${f.series}:${f.id}`));
                }
            } catch (e) {
                console.error('Failed to load favorites:', e);
            }
        }
        
        function updateFavoriteIcon() {
            const icon = document.getElementById('comic-favorite-icon');
            if (!icon || currentComicList.length === 0) return;
            
            const comic = currentComicList[currentComicIndex];
            if (!comic) return;
            
            const key = `${comic.series || currentComicSeries}:${comic.id || comic.date}`;
            icon.textContent = comicFavorites.has(key) ? '‚ù§Ô∏è' : 'ü§ç';
        }
        
        async function toggleComicFavorite(event) {
            if (event) event.stopPropagation();
            if (currentComicList.length === 0) return;
            
            const comic = currentComicList[currentComicIndex];
            if (!comic) return;
            
            const series = comic.series || currentComicSeries;
            const comicId = comic.id || comic.date;
            const key = `${series}:${comicId}`;
            
            try {
                const resp = await fetch('/api/comics/favorite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        series: series,
                        id: comicId,
                        title: comic.title || `${series} - ${comicId}`,
                        date: comic.date || comicId,
                        image_url: comic.image_url
                    })
                });
                const data = await resp.json();
                if (data.success) {
                    if (data.is_favorite) {
                        comicFavorites.add(key);
                        showNotification('Added to favorites! ‚ù§Ô∏è', 'success');
                    } else {
                        comicFavorites.delete(key);
                        showNotification('Removed from favorites', 'info');
                    }
                    updateFavoriteIcon();
                }
            } catch (e) {
                console.error('Failed to toggle favorite:', e);
                showNotification('Failed to update favorite', 'error');
            }
        }
        
        // Load favorites on page load
        loadComicFavorites();

        async function openComicLightbox(imageUrl, caption, series) {
            const lightbox = document.getElementById('comic-lightbox');
            const img = document.getElementById('comic-lightbox-img');
            const captionEl = document.getElementById('comic-lightbox-caption');
            
            img.src = imageUrl;
            captionEl.textContent = caption || '';
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Load archive for navigation if not already loaded for this series
            if (series && series !== currentComicSeries) {
                await loadComicArchive(series);
            }
            
            // Find current comic in list
            if (currentComicList.length > 0) {
                const idx = currentComicList.findIndex(c => c.image_url === imageUrl);
                if (idx >= 0) {
                    currentComicIndex = idx;
                }
            }
            
            // Update favorite icon
            updateFavoriteIcon();
        }

        function closeComicLightbox(event) {
            if (event) event.stopPropagation();
            document.getElementById('comic-lightbox').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function prevComic(event) {
            if (event) event.stopPropagation();
            if (currentComicList.length > 0) {
                currentComicIndex = (currentComicIndex - 1 + currentComicList.length) % currentComicList.length;
                const comic = currentComicList[currentComicIndex];
                document.getElementById('comic-lightbox-img').src = comic.image_url;
                document.getElementById('comic-lightbox-caption').textContent = comic.date || '';
                updateFavoriteIcon();
            }
        }

        function nextComic(event) {
            if (event) event.stopPropagation();
            if (currentComicList.length > 0) {
                currentComicIndex = (currentComicIndex + 1) % currentComicList.length;
                const comic = currentComicList[currentComicIndex];
                document.getElementById('comic-lightbox-img').src = comic.image_url;
                document.getElementById('comic-lightbox-caption').textContent = comic.date || '';
                updateFavoriteIcon();
            }
        }

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', (e) => {
            const lightbox = document.getElementById('comic-lightbox');
            if (lightbox && !lightbox.classList.contains('hidden')) {
                if (e.key === 'Escape') closeComicLightbox();
                else if (e.key === 'ArrowLeft') prevComic();
                else if (e.key === 'ArrowRight') nextComic();
            }
        });

        async function reloadComic() {
            const display = document.getElementById('garfield');
            const sel = document.getElementById('comic-select');
            const choice = sel ? sel.value : 'garfield';
            if (!display) return;
            display.innerHTML = '<div class="animate-pulse text-gray-400">Loading comic...</div>';
            try {
                let url = '';
                let comicConfig = null;
                
                // Get comic config to determine how to fetch
                try {
                    const configResp = await fetch('/api/settings/comics');
                    const configData = await configResp.json();
                    if (configData.success && configData.comics) {
                        comicConfig = configData.comics[choice];
                    }
                } catch (e) {
                    console.log('Could not fetch comic config, using defaults');
                }
                
                // Handle special cases first
                if (choice === 'favorites') {
                    display.innerHTML = '<div class="text-sm text-gray-300">Use the Archive button to browse favorites.</div>';
                    return;
                }
                
                // Determine the right endpoint based on comic source
                if (choice === 'garfield') {
                    url = '/api/comics/garfield/random';
                } else if (comicConfig && comicConfig.gocomics_slug) {
                    // Use the generic GoComics endpoint for custom comics
                    url = `/api/comics/gocomics/${comicConfig.gocomics_slug}`;
                } else if (choice === 'bloomcounty') {
                    url = '/api/comics/bloomcounty/random';
                } else if (choice === 'calvin') {
                    url = '/api/comics/calvin/daily';
                } else if (choice === 'peanuts') {
                    url = '/api/comics/peanuts';
                } else {
                    display.innerHTML = '<div class="text-gray-400">Unknown comic type.</div>';
                    return;
                }
                
                const resp = await fetch(url);
                const data = await resp.json();
                const comic = data.comic || data;
                const image = comic.image_url || data.image_url;
                const link = (comic.link || data.page_url || '#');
                const date = comic.date || data.date || '';
                if (image) {
                    // Pre-load archive for this series for navigation
                    currentComicSeries = choice;
                    loadComicArchive(choice);
                    display.innerHTML = `
                        <div class="cursor-pointer" onclick="openComicLightbox('${image}', '${date}', '${choice}')">
                            <img src="${image}" alt="Comic" class="w-full rounded-lg border border-orange-600 max-h-64 object-contain bg-gray-900 hover:border-orange-400 hover:shadow-lg transition-all">
                            <div class="text-xs text-gray-400 mt-1 text-center">Click to enlarge ‚Ä¢ Use ‚Üê ‚Üí to browse archive</div>
                        </div>`;
                } else {
                    display.innerHTML = '<div class="text-gray-400">No comic available.</div>';
                }
            } catch (e) {
                console.error('Comic error:', e);
                display.innerHTML = '<div class="text-red-400">Error loading comic.</div>';
            }
        }

        async function showComicsArchive() {
            const modal = document.getElementById('garfield-archive-modal');
            const content = document.getElementById('garfield-archive-content');
            const sel = document.getElementById('comic-select');
            const series = sel ? sel.value : 'garfield';
            
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">Loading archive...</div>';
            
            try {
                // Load archive for the selected series
                const resp = await fetch(`/api/comics/${series}/archive?limit=200`);
                const data = await resp.json();
                if (data.success && data.comics && data.comics.length > 0) {
                    // Store for lightbox navigation
                    currentComicList = data.comics;
                    currentComicSeries = series;
                    content.innerHTML = data.comics.map((comic, index) => `
                        <div class="bg-gray-900 rounded-lg border border-orange-600 overflow-hidden cursor-pointer hover:border-orange-400 hover:shadow-lg transition-all" onclick="openComicFromArchive(${index})">
                            <img src="${comic.image_url}" alt="Comic" class="w-full h-40 object-cover" loading="lazy">
                            <div class="p-2 text-xs text-orange-300">${comic.date || ''}</div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">No comics in archive yet. Comics are saved as you view them daily.</div>';
                }
            } catch (e) {
                console.error('Archive error:', e);
                content.innerHTML = '<div class="col-span-full text-red-400 text-center py-8">Error loading archive</div>';
            }
        }

        function openComicFromArchive(index) {
            currentComicIndex = index;
            const comic = currentComicList[index];
            closeGarfieldArchive();
            openComicLightbox(comic.image_url, comic.date || '', currentComicSeries);
        }

        function closeGarfieldArchive() {
            document.getElementById('garfield-archive-modal').classList.add('hidden');
        }

        // eBay Auctions
        async function loadEbayAuctions() {
            const list = document.getElementById('ebay-auctions-list');
            if (!list) return;
            list.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8 animate-pulse">Scanning eBay for deals...</div>';
            try {
                const resp = await fetch('/api/ebay/auctions?category=retro_tech');
                const data = await resp.json();
                console.log('eBay response:', data);
                if (data.success && data.auctions && data.auctions.length > 0) {
                    list.innerHTML = data.auctions.map(auction => `
                        <div class="bg-gray-900 rounded-lg border border-yellow-600 overflow-hidden flex flex-col">
                            <img src="${auction.image_url}" alt="${auction.title}" class="w-full h-40 object-cover">
                            <div class="p-3 flex-1 flex flex-col">
                                <h4 class="font-semibold text-yellow-300 line-clamp-2 text-sm mb-2">${auction.title}</h4>
                                <div class="flex justify-between items-center mb-3 mt-auto">
                                    <span class="text-lg font-bold text-green-300">$${auction.current_price}</span>
                                    <span class="text-xs text-gray-400">${auction.time_left}</span>
                                </div>
                                <a href="${auction.link}" target="_blank" class="block w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-sm text-center font-semibold">View</a>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">üîç No auctions found right now. eBay\'s structure may have changed.</div>';
                }
            } catch (e) {
                console.error('eBay error:', e);
                list.innerHTML = '<div class="col-span-full text-red-400 text-center py-8">Error loading auctions</div>';
            }
        }

        // Weather
        async function loadWeather(lat = null, lon = null, name = null) {
            const display = document.getElementById('weather-display');
            const forecastBox = document.getElementById('weather-forecast');
            const alertsBox = document.getElementById('weather-alerts');
            try {
                const qs = new URLSearchParams();
                if (lat !== null && lon !== null) {
                    qs.set('lat', lat);
                    qs.set('lon', lon);
                }
                if (name) qs.set('location', name);
                const resp = await fetch(`/api/weather${qs.toString() ? '?' + qs.toString() : ''}`);
                const data = await resp.json();
                const w = data;
                if (w && (w.temperature || w.description)) {
                    display.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="text-5xl font-extrabold text-cyan-300">${w.temperature || ''}</div>
                                <div class="text-sm text-gray-400">${w.description || 'No data'}</div>
                                <div class="text-xs text-gray-500 mt-1">Feels like ${w.feels_like || ''}</div>
                                <div class="text-xs text-gray-500 mt-1">Wind: ${w.wind_speed ?? ''} mph</div>
                                <div class="text-xs text-gray-500 mt-1">Humidity: ${w.humidity ?? ''}%</div>
                                <div class="text-xs text-gray-500 mt-1">Location: ${w.location || (name || 'Unknown')}</div>
                            </div>
                        </div>
                    `;

                    // Forecast
                    if (Array.isArray(w.forecast)) {
                        forecastBox.innerHTML = w.forecast.map(f => `
                            <div class="bg-gray-900 rounded border border-cyan-700 p-2 text-xs text-gray-300">
                                <div class="font-semibold text-cyan-300">${f.day || ''}</div>
                                <div class="text-gray-400">${f.high} / ${f.low}</div>
                                <div class="text-gray-500">${f.condition || ''}</div>
                            </div>
                        `).join('');
                    } else {
                        forecastBox.innerHTML = '';
                    }

                    // Alerts
                    if (Array.isArray(w.alerts) && w.alerts.length) {
                        alertsBox.innerHTML = `
                            <div class="text-sm font-semibold text-red-300 mb-2">Severe Weather Alerts</div>
                            ${w.alerts.map(a => `
                                <div class="bg-gray-900 rounded border border-red-700 p-3 mb-2">
                                    <div class="text-red-300 font-semibold text-sm">${a.event || 'Alert'} (${a.severity || ''})</div>
                                    <div class="text-xs text-gray-400">${a.start || ''} ‚Üí ${a.end || ''}</div>
                                    <div class="text-xs text-gray-300 mt-1">${a.description || ''}</div>
                                    <div class="text-xs text-gray-500 mt-1">Source: ${a.source || ''}</div>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        alertsBox.innerHTML = '';
                    }
                }
            } catch (e) {
                console.error('Weather error:', e);
                display.innerHTML = '<div class="text-sm text-red-400">Error loading weather</div>';
                forecastBox.innerHTML = '';
                alertsBox.innerHTML = '';
            }
        }

        // Ambient Weather (Local Station)
        async function loadAmbientWeather() {
            const display = document.getElementById('ambient-weather-display');
            if (!display) return;
            
            try {
                const resp = await fetch('/api/weather/ambient');
                const data = await resp.json();
                
                if (!data.success) {
                    if (!data.configured) {
                        display.innerHTML = `
                            <div class="bg-gray-900 rounded border border-yellow-600 p-4">
                                <div class="text-yellow-400 font-semibold mb-2">‚ö†Ô∏è Ambient Weather Not Configured</div>
                                <div class="text-sm text-gray-400 mb-3">To connect your local weather station:</div>
                                <ol class="text-xs text-gray-400 list-decimal ml-4 space-y-1">
                                    <li>Go to <a href="https://ambientweather.net/account" target="_blank" class="text-cyan-400 underline">ambientweather.net/account</a></li>
                                    <li>Create an API Key and Application Key</li>
                                    <li>Add both keys to config/credentials.yaml under ambient_weather</li>
                                </ol>
                            </div>
                        `;
                    } else {
                        display.innerHTML = `<div class="text-red-400">${data.error || 'Error loading station data'}</div>`;
                    }
                    return;
                }
                
                const w = data.data;
                const windDir = w.wind_direction_cardinal || '';
                const lastUpdate = w.timestamp ? new Date(w.timestamp).toLocaleTimeString() : '';
                
                display.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Main Temperature -->
                        <div class="bg-gray-900 rounded border border-green-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Outdoor</div>
                            <div class="text-4xl font-extrabold text-green-300">${w.temperature_display || w.temperature + '¬∞F'}</div>
                            <div class="text-sm text-gray-400">Feels like ${w.feels_like_display || (w.feels_like ? w.feels_like + '¬∞F' : '--')}</div>
                            <div class="text-xs text-gray-500 mt-2">Humidity: ${w.humidity}%</div>
                            <div class="text-xs text-gray-500">Dew Point: ${w.dew_point ? w.dew_point.toFixed(1) + '¬∞F' : '--'}</div>
                        </div>
                        
                        <!-- Indoor -->
                        ${w.temperature_indoor ? `
                        <div class="bg-gray-900 rounded border border-blue-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Indoor</div>
                            <div class="text-3xl font-bold text-blue-300">${w.temperature_indoor}¬∞F</div>
                            <div class="text-xs text-gray-500 mt-2">Humidity: ${w.humidity_indoor || '--'}%</div>
                        </div>
                        ` : ''}
                        
                        <!-- Wind -->
                        <div class="bg-gray-900 rounded border border-cyan-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Wind</div>
                            <div class="text-2xl font-bold text-cyan-300">${w.wind_speed || 0} mph ${windDir}</div>
                            <div class="text-xs text-gray-400">Gusts: ${w.wind_gust || 0} mph</div>
                            <div class="text-xs text-gray-500 mt-2">Max Today: ${w.max_daily_gust || 0} mph</div>
                        </div>
                        
                        <!-- Pressure -->
                        <div class="bg-gray-900 rounded border border-purple-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Pressure</div>
                            <div class="text-xl font-bold text-purple-300">${w.pressure_display || (w.pressure_relative ? w.pressure_relative.toFixed(2) + ' inHg' : '--')}</div>
                        </div>
                        
                        <!-- Rain -->
                        <div class="bg-gray-900 rounded border border-blue-600 p-4">
                            <div class="text-xs text-gray-500 mb-1">Rain</div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div><span class="text-gray-400">Hourly:</span> <span class="text-blue-300">${w.rain_hourly || 0}"</span></div>
                                <div><span class="text-gray-400">Daily:</span> <span class="text-blue-300">${w.rain_daily || 0}"</span></div>
                                <div><span class="text-gray-400">Weekly:</span> <span class="text-blue-300">${w.rain_weekly || 0}"</span></div>
                                <div><span class="text-gray-400">Monthly:</span> <span class="text-blue-300">${w.rain_monthly || 0}"</span></div>
                            </div>
                        </div>
                        
                        <!-- UV / Solar -->
                        ${w.uv_index !== undefined || w.solar_radiation !== undefined ? `
                        <div class="bg-gray-900 rounded border border-yellow-600 p-4">
                            <div class="text-xs text-gray-500 mb-1">UV / Solar</div>
                            ${w.uv_index !== undefined ? `<div class="text-xl font-bold text-yellow-300">UV ${w.uv_index}</div>` : ''}
                            ${w.solar_radiation !== undefined ? `<div class="text-xs text-gray-400">Solar: ${w.solar_radiation} W/m¬≤</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- Air Quality -->
                        ${w.pm25 !== undefined || w.aqi_pm25 !== undefined ? `
                        <div class="bg-gray-900 rounded border border-orange-600 p-4">
                            <div class="text-xs text-gray-500 mb-1">Air Quality</div>
                            ${w.aqi_pm25 !== undefined ? `<div class="text-xl font-bold text-orange-300">AQI ${w.aqi_pm25}</div>` : ''}
                            ${w.pm25 !== undefined ? `<div class="text-xs text-gray-400">PM2.5: ${w.pm25} ¬µg/m¬≥</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Station Info -->
                    <div class="mt-4 text-xs text-gray-500 flex justify-between">
                        <span>üì° ${w.station_name || 'Weather Station'} ${w.station_location ? '‚Ä¢ ' + w.station_location : ''}</span>
                        <span>Updated: ${lastUpdate}</span>
                    </div>
                `;
            } catch (e) {
                console.error('Ambient weather error:', e);
                display.innerHTML = '<div class="text-red-400">Error loading local weather station</div>';
            }
        }

        async function searchWeather() {
            const q = document.getElementById('weather-search-input').value.trim();
            const results = document.getElementById('weather-search-results');
            if (!q) { results.innerHTML = ''; return; }
            try {
                const resp = await fetch(`/api/weather/search?q=${encodeURIComponent(q)}`);
                const data = await resp.json();
                if (data.success && Array.isArray(data.results)) {
                    results.innerHTML = data.results.map(r => `
                        <button class="block w-full text-left px-3 py-2 bg-gray-900 hover:bg-gray-700 rounded border border-gray-700 mb-2"
                            onclick="selectWeatherLocation(${r.latitude},${r.longitude},'${r.name}, ${r.country}')">
                            <span class="text-gray-200">${r.name}</span>
                            <span class="text-gray-500">${r.country}</span>
                        </button>
                    `).join('');
                } else {
                    results.innerHTML = '<div class="text-xs text-gray-500">No matches</div>';
                }
            } catch (e) {
                console.error('Weather search error:', e);
            }
        }

        async function searchWeatherTo(inputId, resultsId) {
            const q = document.getElementById(inputId).value.trim();
            const results = document.getElementById(resultsId);
            if (!q) { results.innerHTML = ''; return; }
            try {
                const resp = await fetch(`/api/weather/search?q=${encodeURIComponent(q)}`);
                const data = await resp.json();
                if (data.success && Array.isArray(data.results)) {
                    results.innerHTML = data.results.map(r => `
                        <button class="block w-full text-left px-3 py-2 bg-gray-900 hover:bg-gray-700 rounded border border-gray-700 mb-2"
                            onclick="selectWeatherLocation(${r.latitude},${r.longitude},'${r.name}, ${r.country}')">
                            <span class="text-gray-200">${r.name}</span>
                            <span class="text-gray-500">${r.country}</span>
                        </button>
                    `).join('');
                } else {
                    results.innerHTML = '<div class="text-xs text-gray-500">No matches</div>';
                }
            } catch (e) {
                console.error('Weather search error:', e);
            }
        }

        // News
        async function loadNews() {
            const filterSel = document.getElementById('news-filter');
            const filter = filterSel ? filterSel.value : 'all';
            const list = document.getElementById('news-list');
            try {
                const resp = await fetch(`/api/news?filter=${encodeURIComponent(filter)}`);
                const data = await resp.json();
                const articles = data.articles || [];
                if (!articles.length) {
                    list.innerHTML = '<div class="text-gray-400 col-span-full text-center py-8">No news available</div>';
                    return;
                }
                list.innerHTML = articles.map(a => `
                    <div class="bg-gray-900 rounded border border-gray-700 p-4">
                        <a href="${a.url}" target="_blank" class="text-gray-200 hover:text-white font-semibold">${a.title}</a>
                        <div class="text-xs text-gray-500 mt-1">${a.source || ''} ‚Ä¢ ${a.published_at || ''}</div>
                        <div class="text-sm text-gray-400 mt-2">${a.description || ''}</div>
                        <div class="text-xs text-gray-600 mt-2">${a.category || ''}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('News error:', e);
                list.innerHTML = '<div class="text-red-400 col-span-full text-center py-8">Error loading news</div>';
            }
        }

        // Calm Tips (from anxiety feed, supportive only)
        async function loadCalmTips() {
            const tips = document.getElementById('calm-tips');
            try {
                const resp = await fetch('/api/feeds/anxiety');
                const data = await resp.json();
                const articles = (data.articles || []).filter(a => {
                    const t = (a.title || '').toLowerCase();
                    return t.includes('tips') || t.includes('how to') || t.includes('ways to') || t.includes('manage') || t.includes('cope');
                }).slice(0, 6);
                if (!articles.length) {
                    tips.innerHTML = '<div class="text-gray-400 col-span-full text-center py-6">No tips right now</div>';
                    return;
                }
                tips.innerHTML = articles.map(a => `
                    <div class="bg-gray-900 rounded border border-emerald-700 p-3">
                        <a href="${a.link}" target="_blank" class="text-emerald-300 hover:text-emerald-200 font-semibold text-sm line-clamp-2">${a.title}</a>
                        <div class="text-xs text-emerald-200/70 mt-1">${a.date || ''}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Calm tips error:', e);
                tips.innerHTML = '<div class="text-gray-400 col-span-full text-center py-6">Error loading tips</div>';
            }
        }

        // Tasks
        async function loadTasks() {
            const list = document.getElementById('tasks-list');
            try {
                const r = await fetch('/api/tasks');
                const d = await r.json();
                const tasks = d.tasks || [];
                if (!tasks.length) {
                    list.innerHTML = '<div class="text-gray-400 col-span-full text-center py-8">No tasks yet</div>';
                    return;
                }
                list.innerHTML = tasks.map(t => `
                    <div class="bg-gray-900 rounded border border-gray-700 p-4">
                        <div class="font-semibold text-gray-200">${t.title}</div>
                        <div class="text-xs text-gray-500 mt-1">${t.category || ''} ‚Ä¢ ${t.priority || ''}</div>
                        ${t.due_date ? `<div class=\"text-xs text-gray-500 mt-1\">Due: ${t.due_date}</div>` : ''}
                        ${t.source_url ? `<a href=\"${t.source_url}\" target=\"_blank\" class=\"text-xs text-blue-300 hover:underline mt-2 inline-block\">View source</a>` : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error('Tasks error', e);
                list.innerHTML = '<div class="text-red-400 col-span-full text-center py-8">Error loading tasks</div>';
            }
        }

        async function generateSmartTasks(includeCalendarDefault) {
            const includeEmail = document.getElementById('include-email')?.checked || false;
            try {
                const r = await fetch('/api/tasks/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ include_notes: true, include_calendar: includeCalendarDefault, include_email: includeEmail })
                });
                const d = await r.json();
                loadTasks();
            } catch (e) {
                console.error('Generate tasks error', e);
            }
        }

        function selectWeatherLocation(lat, lon, name) {
            try {
                localStorage.setItem('weather_selected', JSON.stringify({lat, lon, name}));
            } catch {}
            loadWeather(lat, lon, name);
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) { return; }
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                loadWeather(latitude, longitude, 'Current Location');
            }, () => {
                // Fallback: load default
                loadWeather();
            });
        }

        // Calm Radar / Anxiety Feed
        async function loadAnxietyFeed() {
            const list = document.getElementById('anxiety-list');
            try {
                const resp = await fetch('/api/feeds/anxiety');
                const data = await resp.json();
                if (data.success && data.articles && data.articles.length > 0) {
                    list.innerHTML = data.articles.slice(0, 6).map(a => `
                        <div class="bg-gray-900 rounded border border-emerald-700 p-3">
                            <a href="${a.link}" target="_blank" class="text-emerald-300 hover:text-emerald-200 font-semibold text-sm line-clamp-2">${a.title}</a>
                            <div class="text-xs text-emerald-200/70 mt-1">${a.date || 'Calm signal'}</div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="setAnxietyPref('${a.id}','like')" class="flex-1 px-2 py-1 bg-emerald-700 hover:bg-emerald-600 rounded text-xs">üëç</button>
                                <button onclick="setAnxietyPref('${a.id}','hide')" class="flex-1 px-2 py-1 bg-emerald-800 hover:bg-emerald-700 rounded text-xs">üëÄ</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Anxiety feed error:', e);
            }
        }
        // Jokes
        async function loadJokes() {
            const el = document.getElementById('jokes');
            if (!el) return;
            try {
                const r = await fetch('/api/joke');
                const d = await r.json();
                console.log('Joke loaded:', d.joke);
                if (d.joke) {
                    el.innerHTML = `<div class="text-sm text-gray-300">${d.joke}</div>`;
                }
            } catch (e) { console.error('Jokes error', e); }
        }

        // Quote
        async function loadQuote() {
            const el = document.getElementById('quote');
            if (!el) return;
            try {
                const r = await fetch('/api/quote');
                const d = await r.json();
                console.log('Quote loaded:', d.quote);
                if (d.quote) {
                    el.innerHTML = `<div class="text-sm text-gray-300 italic">"${d.quote}"</div>`;
                }
            } catch (e) { console.error('Quote error', e); }
        }

        // Comics: handled above; keep only the change listener here
        document.addEventListener('change', (ev) => {
            const t = ev.target;
            if (t && t.id === 'comic-select') reloadComic();
        });

        function setAnxietyPref(id, value) {
            const prefs = JSON.parse(localStorage.getItem('anxiety_prefs') || '{}');
            prefs[id] = value;
            localStorage.setItem('anxiety_prefs', JSON.stringify(prefs));
        }

        // Family Calendar from iCloud
        async function loadFamilyCalendar() {
            const display = document.getElementById('calendar-family');
            try {
                const resp = await fetch('/api/calendar/family');
                const data = await resp.json();
                if (data.success && data.events && data.events.length > 0) {
                    display.innerHTML = data.events.slice(0, 10).map(event => `
                        <div class="mb-3 pb-3 border-b border-blue-700 last:border-0">
                            <div class="font-semibold text-blue-300 text-sm">${event.title}</div>
                            <div class="text-xs text-gray-400">${event.start_time}</div>
                        </div>
                    `).join('');
                } else {
                    display.innerHTML = '<div class="text-gray-500 text-sm">No family events</div>';
                }
            } catch (e) {
                console.error('Family calendar error:', e);
                display.innerHTML = '<div class="text-gray-500 text-sm">Error loading calendar</div>';
            }
        }

        // Roger Home Content
        async function loadRogerHome() {
            try {
                const resp = await fetch('/api/roger_home');
                const data = await resp.json();
                console.log('Roger Home loaded:', data);
                if (!data.ok) return;
                const c = data.content || {};

                // Parts
                const partsEl = document.getElementById('parts');
                if (partsEl && c.parts_search_terms) {
                    partsEl.innerHTML = `
                        <div class="space-y-2">
                            ${c.parts_search_terms.slice(0, 3).map(t => `<div class="text-xs text-gray-300">üîç ${t}</div>`).join('')}
                            ${c.parts_tips ? `<div class="text-xs text-gray-400 mt-2">${c.parts_tips[0]}</div>` : ''}
                        </div>`;
                }

                // History
                const historyEl = document.getElementById('history');
                if (historyEl && c.history_fact) {
                    historyEl.innerHTML = `<div class="text-sm text-gray-300">${c.history_fact}</div>`;
                }

                // Star Wars
                const starwarsEl = document.getElementById('starwars');
                if (starwarsEl && c.starwars_fact) {
                    starwarsEl.innerHTML = `<div class="text-sm text-gray-300">${c.starwars_fact}</div>`;
                }

                // Communities
                const commEl = document.getElementById('communities');
                if (commEl && Array.isArray(c.subreddit_suggestions)) {
                    commEl.innerHTML = c.subreddit_suggestions.slice(0, 3).map(s => `
                        <div class="mb-2">
                            <a href="https://reddit.com/r/${s.subreddit}" target="_blank" class="text-purple-300 hover:underline text-sm">r/${s.subreddit}</a>
                            <div class="text-xs text-gray-500">${s.tip}</div>
                        </div>
                    `).join('');
                }

                // Roger Quotes
                const rogerQuotesEl = document.getElementById('roger-quotes');
                if (rogerQuotesEl && c.positive_quote) {
                    rogerQuotesEl.innerHTML = `<div class="text-sm text-gray-300 italic">"${c.positive_quote}"</div>`;
                }
            } catch (e) {
                console.error('Roger home error:', e);
            }
        }

        // Initialize data loaders - MODULAR based on skin config
        function initializeDataLoaders() {
            console.log('üöÄ INITIALIZING DATA LOADERS');
            
            // Initialize comic dropdown with settings
            updateComicDropdown();
            
            // Just call all the loaders
            loadJokes();
            loadQuote();
            loadRogerHome();
            reloadComic();
            loadEbayAuctions();
            loadWeather();
            
            // Check which widgets are enabled for current skin
            const widgets = currentSkin?.dashboard?.widgets || {};
            
            // Load data for enabled widgets only
            if (isWidgetEnabled('jokes')) loadJokes();
            if (isWidgetEnabled('quote')) loadQuote();
            if (isWidgetEnabled('comics')) reloadComic();
            if (isWidgetEnabled('ebay')) loadEbayAuctions();
            if (isWidgetEnabled('roger_quotes') || isWidgetEnabled('communities') || 
                isWidgetEnabled('starwars') || isWidgetEnabled('parts_search') || 
                isWidgetEnabled('history_fact')) {
                loadRogerHome();
            }
            
            // Load Dracula-specific widgets
            if (isWidgetEnabled('dark_news')) loadDarkNews();
            if (isWidgetEnabled('dracula_quotes')) loadDraculaQuote();
            if (isWidgetEnabled('music_player')) {
                // Initialize music player with Last.fm data
                console.log('üéµ Music player widget enabled - loading station');
                loadMusicStation();
            }
            
            loadAnxietyFeed();
            
            console.log('üöÄ ALL RELEVANT DATA LOADERS CALLED');
        }
        
        // Helper to check if widget is enabled
        function isWidgetEnabled(widgetName) {
            if (!currentSkin || !currentSkin.dashboard || !currentSkin.dashboard.widgets) {
                return true; // Default to enabled if no config
            }
            const widget = currentSkin.dashboard.widgets[widgetName];
            return widget && widget.enabled === true;
        }

        // Page initialization is handled by initializeSkin() which is called from DOMContentLoaded
        // initializeSkin -> switchSkin -> applySkin (applies widget visibility) -> initializeDataLoaders
        // No need for separate load event handler

    </script>
</body>
</html>
