<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Personal Assistant</title>
    <link rel="icon" href="/assets/images/forge-logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style id="skin-css">
        /* Default skin variables - will be overwritten by active skin */
        :root {
            --skin-primary: #9333ea;
            --skin-primary-light: #a855f7;
            --skin-primary-dark: #7e22ce;
            --skin-secondary: #6366f1;
            --skin-accent: #06b6d4;
            --skin-bg-primary: #111827;
            --skin-bg-secondary: #1f2937;
            --skin-bg-tertiary: #374151;
            --skin-text-primary: #f3f4f6;
            --skin-text-secondary: #d1d5db;
            --skin-text-muted: #9ca3af;
            --skin-border-primary: #374151;
            --skin-border-accent: #7c3aed;
        }
        /* Apply skin colors to elements */
        .skin-primary { color: var(--skin-primary); }
        .skin-primary-bg { background-color: var(--skin-primary); }
        .skin-primary-border { border-color: var(--skin-primary); }
        .skin-secondary { color: var(--skin-secondary); }
        .skin-accent { color: var(--skin-accent); }
        .skin-bg-primary { background-color: var(--skin-bg-primary); }
        .skin-bg-secondary { background-color: var(--skin-bg-secondary); }
        .skin-text-primary { color: var(--skin-text-primary); }
        .skin-text-secondary { color: var(--skin-text-secondary); }
        .skin-border { border-color: var(--skin-border-primary); }
        .skin-border-accent { border-color: var(--skin-border-accent); }
    </style>
    <script>
        // ========================================
        // MODULE REGISTRY SYSTEM
        // Defines all available dashboard modules
        // ========================================
        const MODULE_REGISTRY = {
            // Weather & Environment
            weather: {
                id: 'weather',
                name: 'Weather',
                icon: 'üå°Ô∏è',
                category: 'environment',
                description: 'Current weather, forecast, and ambient weather station',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi']
            },
            
            // Entertainment - Both Themes
            jokes: {
                id: 'jokes',
                name: 'Daily Jokes',
                icon: 'üòÑ',
                category: 'entertainment',
                description: 'Programming and dad jokes',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi']
            },
            quote: {
                id: 'quote',
                name: 'Daily Quote',
                icon: '‚ú®',
                category: 'entertainment',
                description: 'Inspirational and motivational quotes',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi']
            },
            
            // Entertainment - Roger Theme
            comics: {
                id: 'comics',
                name: 'Daily Comics',
                icon: 'üì∞',
                category: 'entertainment',
                description: 'Garfield and other daily comics',
                defaultEnabled: true,
                themes: ['roger', 'alice', 'jedi']
            },
            ebay: {
                id: 'ebay',
                name: 'eBay Auctions',
                icon: 'üõí',
                category: 'shopping',
                description: 'Retro tech and collectible auctions',
                defaultEnabled: true,
                themes: ['roger', 'jedi']
            },
            parts_search: {
                id: 'parts_search',
                name: 'Parts Search',
                icon: 'üîß',
                category: 'utility',
                description: 'Search for electronic parts',
                defaultEnabled: false,
                themes: ['roger']
            },
            history_fact: {
                id: 'history_fact',
                name: 'History Fact',
                icon: 'üìö',
                category: 'entertainment',
                description: 'Historical facts and events',
                defaultEnabled: false,
                themes: ['roger']
            },
            starwars: {
                id: 'starwars',
                name: 'Star Wars',
                icon: '‚≠ê',
                category: 'entertainment',
                description: 'Star Wars trivia and facts',
                defaultEnabled: true,
                themes: ['roger', 'jedi']
            },
            communities: {
                id: 'communities',
                name: 'Tech Communities',
                icon: 'üë•',
                category: 'social',
                description: 'Tech and maker communities',
                defaultEnabled: false,
                themes: ['roger']
            },
            roger_quotes: {
                id: 'roger_quotes',
                name: 'Roger Quotes',
                icon: 'ü§ñ',
                category: 'entertainment',
                description: 'Battle droid quotes and phrases',
                defaultEnabled: false,
                themes: ['roger']
            },
            
            // Entertainment - Demon/Dracula Theme
            music_player: {
                id: 'music_player',
                name: 'Music Player',
                icon: 'üéµ',
                category: 'entertainment',
                description: 'Last.fm radio with YouTube playback',
                defaultEnabled: true,
                themes: ['dracula', 'alice']
            },
            dark_news: {
                id: 'dark_news',
                name: 'Dark News Feed',
                icon: 'ü¶á',
                category: 'news',
                description: 'Gothic, horror, fantasy and 90s music news from real feeds',
                defaultEnabled: false,  // Disabled by default - use News section filter instead
                themes: ['dracula']
            },
            art_communities: {
                id: 'art_communities',
                name: 'Art Communities',
                icon: 'üé®',
                category: 'social',
                description: 'Art and creative communities',
                defaultEnabled: true,
                themes: ['dracula', 'alice']
            },
            music_communities: {
                id: 'music_communities',
                name: 'Music Communities',
                icon: 'üé∏',
                category: 'social',
                description: 'Music and band communities',
                defaultEnabled: true,
                themes: ['dracula']
            },
            dracula_quotes: {
                id: 'dracula_quotes',
                name: 'Demon Quotes',
                icon: 'üòà',
                category: 'entertainment',
                description: 'Gothic wisdom and dark humor',
                defaultEnabled: false,
                themes: ['dracula']
            },
            
            // ================================
            // CUSTOM MODULES - Available to All Themes
            // ================================
            
            // Navigation Sections (Full Page)
            tasks: {
                id: 'tasks',
                name: 'Smart Tasks',
                icon: '‚úÖ',
                category: 'productivity',
                description: 'AI-generated tasks from calendar and email',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi'],
                isSection: true
            },
            calendar: {
                id: 'calendar',
                name: 'Calendar',
                icon: 'üìÖ',
                category: 'productivity',
                description: 'Family schedule and upcoming events',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi'],
                isSection: true
            },
            news: {
                id: 'news',
                name: 'News Feed',
                icon: 'üì∞',
                category: 'news',
                description: 'Curated news with calm tips',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi'],
                isSection: true
            },
            
            // Additional Entertainment Widgets
            favorites: {
                id: 'favorites',
                name: 'Music Favorites',
                icon: '‚ù§Ô∏è',
                category: 'entertainment',
                description: 'Your saved favorite tracks',
                defaultEnabled: true,
                themes: ['dracula', 'alice']
            },
            calm_tips: {
                id: 'calm_tips',
                name: 'Calm Tips',
                icon: 'üßò',
                category: 'wellness',
                description: 'Anxiety-calming tips and reminders',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi']
            },
            ambient_weather: {
                id: 'ambient_weather',
                name: 'Ambient Weather',
                icon: 'üå§Ô∏è',
                category: 'environment',
                description: 'Data from personal weather station',
                defaultEnabled: false,
                themes: ['roger', 'dracula', 'alice', 'jedi']
            },
            
            // ================================
            // EXTERNAL PAGE MODULES (Left Nav Links)
            // These link to separate pages, not dashboard sections
            // ================================
            email: {
                id: 'email',
                name: 'Email',
                icon: 'üìß',
                category: 'productivity',
                description: 'Gmail inbox with AI analysis',
                defaultEnabled: true,
                themes: ['roger'],  // More suited to work/productivity theme
                isExternalPage: true,
                url: '/email'
            },
            leads: {
                id: 'leads',
                name: 'Leads',
                icon: 'üéØ',
                category: 'business',
                description: 'AI-generated business leads',
                defaultEnabled: true,
                themes: ['roger'],  // Business module for work theme
                isExternalPage: true,
                url: '/leads'
            },
            trust_layer: {
                id: 'trust_layer',
                name: 'Trust Layer',
                icon: 'üõ°Ô∏è',
                category: 'productivity',
                description: 'AI trust and approval system',
                defaultEnabled: false,
                themes: ['roger'],  // Technical module
                isExternalPage: true,
                url: '/trust'
            },
            homeassistant: {
                id: 'homeassistant',
                name: 'Home Assistant',
                icon: 'üè†',
                category: 'smart_home',
                description: 'Smart home control and automation',
                defaultEnabled: true,
                themes: ['roger', 'dracula', 'alice', 'jedi'],
                isSection: true
            }
        };
        
        // Module categories for organization
        const MODULE_CATEGORIES = {
            environment: { name: 'Environment', icon: 'üåç' },
            entertainment: { name: 'Entertainment', icon: 'üé≠' },
            news: { name: 'News & Info', icon: 'üì∞' },
            shopping: { name: 'Shopping', icon: 'üõí' },
            social: { name: 'Communities', icon: 'üë•' },
            utility: { name: 'Utilities', icon: 'üîß' },
            smart_home: { name: 'Smart Home', icon: 'üè†' },
            productivity: { name: 'Productivity', icon: 'üìã' },
            wellness: { name: 'Wellness', icon: 'üßò' },
            business: { name: 'Business', icon: 'üíº' }
        };
        
        // Get user's module settings from localStorage
        function getModuleSettings() {
            const saved = localStorage.getItem('dashboardModules');
            if (saved) {
                return JSON.parse(saved);
            }
            // Default: use module defaults
            const defaults = {};
            Object.keys(MODULE_REGISTRY).forEach(id => {
                defaults[id] = { enabled: MODULE_REGISTRY[id].defaultEnabled };
            });
            return defaults;
        }
        
        // Save module settings
        function saveModuleSettings(settings) {
            localStorage.setItem('dashboardModules', JSON.stringify(settings));
        }
        
        // Check if a module is enabled
        function isModuleEnabled(moduleId) {
            const settings = getModuleSettings();
            const module = MODULE_REGISTRY[moduleId];
            if (!module) return false;
            
            // Check if explicitly set
            if (settings[moduleId] !== undefined) {
                return settings[moduleId].enabled;
            }
            
            // Fall back to default
            return module.defaultEnabled;
        }
        
        // Toggle a module's enabled state
        function toggleModule(moduleId) {
            const settings = getModuleSettings();
            const currentState = isModuleEnabled(moduleId);
            settings[moduleId] = { enabled: !currentState };
            saveModuleSettings(settings);
            applyModuleVisibility();
        }
        
        // Apply module visibility to the DOM
        function applyModuleVisibility() {
            const currentTheme = localStorage.getItem('dashboard_skin') || 'roger';
            
            Object.keys(MODULE_REGISTRY).forEach(moduleId => {
                const module = MODULE_REGISTRY[moduleId];
                const elements = document.querySelectorAll(`[data-widget="${moduleId}"]`);
                const isEnabled = isModuleEnabled(moduleId);
                const isForTheme = module.themes.includes(currentTheme);
                
                elements.forEach(el => {
                    if (isEnabled && isForTheme) {
                        el.classList.remove('hidden');
                        el.style.display = '';
                    } else {
                        el.classList.add('hidden');
                        el.style.display = 'none';
                    }
                });
            });
            
            // Also handle the jokes_quote container
            const jokesQuoteContainer = document.querySelector('[data-widget="jokes_quote"]');
            if (jokesQuoteContainer) {
                const jokesEnabled = isModuleEnabled('jokes');
                const quoteEnabled = isModuleEnabled('quote');
                if (!jokesEnabled && !quoteEnabled) {
                    jokesQuoteContainer.classList.add('hidden');
                } else {
                    jokesQuoteContainer.classList.remove('hidden');
                }
            }
            
            // Also handle navigation items for section modules
            document.querySelectorAll('[data-nav-module]').forEach(navItem => {
                const moduleId = navItem.dataset.navModule;
                const isEnabled = isModuleEnabled(moduleId);
                const module = MODULE_REGISTRY[moduleId];
                const isForTheme = module ? module.themes.includes(currentTheme) : true;
                
                if (isEnabled && isForTheme) {
                    navItem.classList.remove('hidden');
                    navItem.style.display = '';
                } else {
                    navItem.classList.add('hidden');
                    navItem.style.display = 'none';
                }
            });
        }
        
        // Get modules for a specific category
        function getModulesByCategory(category) {
            return Object.values(MODULE_REGISTRY).filter(m => m.category === category);
        }
        
        // Get modules available for a theme
        function getModulesForTheme(theme) {
            return Object.values(MODULE_REGISTRY).filter(m => m.themes.includes(theme));
        }
        
        // Reset modules to theme defaults
        function resetModulesToThemeDefaults() {
            const currentTheme = localStorage.getItem('dashboard_skin') || 'roger';
            const settings = {};
            Object.keys(MODULE_REGISTRY).forEach(id => {
                const mod = MODULE_REGISTRY[id];
                // Enable if it's a default for this theme
                settings[id] = { 
                    enabled: mod.defaultEnabled && mod.themes.includes(currentTheme)
                };
            });
            saveModuleSettings(settings);
            applyModuleVisibility();
            // Refresh settings page to update toggles
            loadSettings();
        }
        
        // Enable all modules for current theme
        function enableAllModules() {
            const currentTheme = localStorage.getItem('dashboard_skin') || 'roger';
            const settings = getModuleSettings();
            Object.keys(MODULE_REGISTRY).forEach(id => {
                const mod = MODULE_REGISTRY[id];
                if (mod.themes.includes(currentTheme)) {
                    settings[id] = { enabled: true };
                }
            });
            saveModuleSettings(settings);
            applyModuleVisibility();
            loadSettings();
        }
        
        // Disable all modules
        function disableAllModules() {
            const settings = {};
            Object.keys(MODULE_REGISTRY).forEach(id => {
                settings[id] = { enabled: false };
            });
            saveModuleSettings(settings);
            applyModuleVisibility();
            loadSettings();
        }
        
        // Apply module visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to let skin load first
            setTimeout(applyModuleVisibility, 100);
        });
    </script>
</head>
<body class="bg-gray-900 text-gray-100 h-full overflow-hidden" style="background-color: var(--skin-bg-primary); color: var(--skin-text-primary);">
    <div id="app-bg" class="fixed inset-0 -z-10 bg-cover bg-center opacity-25"></div>
    <!-- Main Container -->
    <div class="flex h-full min-h-0">
        <!-- Sidebar Navigation -->
        <aside class="w-64 border-r overflow-y-auto" style="background-color: var(--skin-bg-secondary); border-color: var(--skin-border-primary);">
            <div class="p-6 border-b space-y-3" style="border-color: var(--skin-border-primary);">
                <div class="relative group cursor-pointer" onclick="openAvatarPicker()">
                    <img id="assistant-avatar" src="/assets/images/rogr.gif" alt="Assistant" class="w-full h-auto rounded-lg object-cover" style="border: 2px solid var(--skin-primary);"/>
                    <div class="absolute inset-0 bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <span class="text-white text-sm"><i class="fas fa-camera mr-1"></i>Change Avatar</span>
                    </div>
                </div>
                <div id="assistant-name" class="text-xl font-bold" style="color: var(--skin-primary-light);">R0-GR</div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="toggleWakeWord()" id="wake-word-btn" class="px-3 py-2 rounded text-xs" style="background-color: var(--skin-primary-dark);">üé§ Listen</button>
                    <button onclick="promptSpeak()" class="px-3 py-2 rounded text-xs" style="background-color: var(--skin-primary);">üí¨ Ask</button>
                    <button onclick="stopAllAudio()" id="mute-btn" class="px-3 py-2 rounded text-xs" style="background-color: var(--skin-bg-tertiary);" title="Stop all audio">üîá Mute</button>
                </div>
                <a id="assistant-link" href="/assistant" class="block text-xs underline" style="color: var(--skin-primary-light);">Open Assistant</a>
                <!-- Skin Switcher -->
                <div class="pt-2 border-t" style="border-color: var(--skin-border-primary);">
                    <label class="text-xs" style="color: var(--skin-text-muted);">Theme:</label>
                    <select id="skin-select" onchange="switchSkin(this.value)" class="w-full mt-1 px-2 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                        <option value="roger">ü§ñ Roger (Battle Droid)</option>
                        <option value="dracula">üòà Demon (Gothic)</option>
                    </select>
                </div>
            </div>
            <nav id="sidebar-nav" class="space-y-2 px-4 py-4">
                <button onclick="showSection('overview')" class="nav-link w-full text-left px-4 py-3 rounded-lg bg-gray-700 text-white transition-colors hover:bg-gray-600">
                    <i class="fas fa-home mr-2"></i>Overview
                </button>
                <button onclick="showSection('weather')" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-cloud-sun mr-2"></i>Weather
                </button>
                <button onclick="showSection('news')" data-nav-module="news" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-newspaper mr-2"></i>News
                </button>
                <button onclick="showSection('tasks')" data-nav-module="tasks" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-tasks mr-2"></i>Tasks
                </button>
                <button onclick="showSection('calendar')" data-nav-module="calendar" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-calendar mr-2"></i>Calendar
                </button>
                <!-- External Page Links (configurable per theme) -->
                <a href="/email" data-nav-module="email" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700 block">
                    <i class="fas fa-envelope mr-2"></i>Email
                </a>
                <a href="/leads" data-nav-module="leads" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700 block">
                    <i class="fas fa-bullseye mr-2"></i>Leads
                </a>
                <a href="/trust" data-nav-module="trust_layer" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700 block">
                    <i class="fas fa-shield-alt mr-2"></i>Trust Layer
                </a>
                <!-- External Wiki Link (Kiwix) -->
                <a href="http://wiki.hoth.home" target="_blank" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700 block">
                    <i class="fas fa-book mr-2"></i>Wiki
                </a>
                <!-- Home Assistant -->
                <button onclick="showSection('homeassistant')" data-nav-module="homeassistant" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-home mr-2"></i>Home
                </button>
                <button onclick="showSection('settings')" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
                <a href="/assistant" id="assistant-nav-link" class="nav-link w-full text-left px-4 py-3 rounded-lg text-gray-300 transition-colors hover:bg-gray-700 block">
                    <i id="assistant-nav-icon" class="fas fa-robot mr-2"></i><span id="assistant-nav-name">Assistant</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto">
            <div class="sticky top-0 z-10 backdrop-blur border-b" style="background-color: var(--skin-bg-secondary); border-color: var(--skin-border-primary);">
                <div class="px-6 py-3 flex items-center justify-between">
                    <div id="header-title" class="text-xl font-bold text-white">Dashboard</div>
                    <div class="flex items-center gap-3 text-sm">
                        <!-- Theme Switcher - Prominent Position -->
                        <div class="flex items-center gap-2 px-3 py-1 rounded-lg" style="background-color: var(--skin-bg-tertiary);">
                            <span style="color: var(--skin-accent);">üé® Theme:</span>
                            <select id="skin-select-header" onchange="switchSkin(this.value)" class="px-2 py-1 rounded text-sm font-semibold" style="background-color: var(--skin-bg-primary); border: 2px solid var(--skin-primary); color: var(--skin-text-primary);">
                                <option value="roger">ü§ñ Roger</option>
                                <option value="dracula">üòà Demon</option>
                            </select>
                        </div>
                        <span style="color: var(--skin-text-muted);">|</span>
                        <span style="color: var(--skin-text-secondary);">Background:</span>
                        <select id="bg-select" class="px-2 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                            <option value="bg1">Background 1</option>
                            <option value="bg2">Background 2</option>
                            <option value="bg3">Background 3</option>
                        </select>
                        <button id="bg-prev" class="px-2 py-1 rounded" style="background-color: var(--skin-bg-tertiary);" title="Previous">‚ü®</button>
                        <button id="bg-next" class="px-2 py-1 rounded" style="background-color: var(--skin-bg-tertiary);" title="Next">‚ü©</button>
                        <input id="bg-url" type="url" placeholder="Paste image URL" class="hidden md:block w-48 px-2 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);"/>
                        <button id="bg-url-set" class="hidden md:block px-2 py-1 rounded" style="background-color: var(--skin-secondary);">Set</button>
                    </div>
                </div>
            </div>
            <!-- Overview Section -->
            <section id="section-overview" class="section-content p-8 space-y-8">
                <!-- Top Focus: Weather + Second Widget (Comics or Music Player) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Weather Widget (Large) - Always visible -->
                    <div data-widget="weather" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-weather-border, #0e7490);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold" style="color: var(--skin-accent);">üå°Ô∏è Weather</h3>
                            <div class="flex gap-2">
                                <button onclick="useCurrentLocation()" class="px-3 py-2 rounded text-xs" style="background-color: var(--skin-secondary); color: var(--skin-text-primary);">Use Current</button>
                            </div>
                        </div>
                        <div class="flex gap-3 mb-3">
                            <input id="weather-search-input" type="text" placeholder="Search city or place..." class="flex-1 px-3 py-2 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                            <button onclick="searchWeather()" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-secondary); color: var(--skin-text-primary);">Search</button>
                        </div>
                        <div id="weather-search-results" class="mb-3 text-sm" style="color: var(--skin-text-muted);"></div>
                        <div class="mb-3">
                            <div class="text-xs mb-2" style="color: var(--skin-text-muted);">Quick picks:</div>
                            <div class="flex flex-wrap gap-2">
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(45.5152,-122.6784,'Portland, OR')">Portland, OR</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(51.5072,-0.1276,'London, UK')">London</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(35.6762,139.6503,'Tokyo, JP')">Tokyo</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(-33.8688,151.2093,'Sydney, AU')">Sydney</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(48.8566,2.3522,'Paris, FR')">Paris</button>
                                <button class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" onclick="selectWeatherLocation(40.7128,-74.0060,'New York, US')">New York</button>
                            </div>
                        </div>
                        <div id="weather-display" style="color: var(--skin-text-secondary);">Loading...</div>
                        <div id="weather-forecast" class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2"></div>
                        <div id="weather-alerts" class="mt-4"></div>
                    </div>

                    <!-- Comics Widget (Roger) -->
                    <div data-widget="comics" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-comics-border, #ea580c);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold" style="color: var(--skin-accent);">üìö Comics</h3>
                            <select id="comic-select" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                                <option value="garfield">Garfield</option>
                                <option value="calvin">Calvin & Hobbes</option>
                                <option value="peanuts">Peanuts</option>
                                <option value="favorites">Favorites</option>
                            </select>
                        </div>
                        <div id="garfield" class="text-sm min-h-64" style="color: var(--skin-text-secondary);">Loading...</div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="reloadComic()" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">Reload</button>
                            <button onclick="showComicsArchive()" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-primary-dark); color: var(--skin-text-primary);">üìö Archive</button>
                        </div>
                    </div>

                    <!-- Music Player Widget (Dracula) -->
                    <div data-widget="music_player" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-accent, #dc2626);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold" style="color: var(--skin-accent);">üéµ Music Player</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="showMusicView('station')" id="btn-station-view" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üìª Station</button>
                                <button onclick="showMusicView('favorites')" id="btn-favorites-view" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">‚ù§Ô∏è Favorites</button>
                                <button onclick="showMusicView('search')" id="btn-search-view" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">üîç Search</button>
                                <button onclick="closeEmbeddedPlayer()" id="close-player-btn" class="px-3 py-1 rounded text-xs hidden" style="background-color: var(--skin-accent); color: white;">‚úï Close</button>
                            </div>
                        </div>
                        
                        <!-- Embedded YouTube Player -->
                        <div id="embedded-player" class="hidden mb-4">
                            <div class="relative w-full" style="padding-bottom: 56.25%;">
                                <iframe id="youtube-iframe" class="absolute top-0 left-0 w-full h-full rounded" 
                                    src="" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                                </iframe>
                            </div>
                            <div id="player-track-info" class="mt-2 text-sm" style="color: var(--skin-text-secondary);"></div>
                        </div>
                        
                        <!-- Station View -->
                        <div id="station-view">
                            <div class="mb-4">
                                <label class="text-sm" style="color: var(--skin-text-muted);">Last.fm Station:</label>
                                <select id="lastfm-station" class="w-full px-3 py-2 rounded text-sm mt-2" style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);">
                                    <option value="90s_alternative">üé∏ 90's Alternative Rock</option>
                                    <option value="gothic_rock">ü¶á Gothic Rock</option>
                                    <option value="darkwave">üåô Darkwave</option>
                                    <option value="musicals">üé≠ Musical Theater</option>
                                    <option value="industrial">‚öôÔ∏è Industrial</option>
                                    <option value="shoegaze">üëü Shoegaze</option>
                                </select>
                            </div>
                            
                            <!-- Playback Controls -->
                            <div class="flex items-center gap-2 mb-4 p-2 rounded" style="background-color: var(--skin-bg-tertiary);">
                                <button onclick="playPreviousTrack()" class="px-3 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary);" title="Previous">‚èÆÔ∏è</button>
                                <button onclick="playCurrentTrack()" id="play-pause-btn" class="px-4 py-1 rounded text-sm font-bold" style="background-color: var(--skin-primary);" title="Play">‚ñ∂Ô∏è</button>
                                <button onclick="playNextTrack()" class="px-3 py-1 rounded text-sm" style="background-color: var(--skin-bg-primary);" title="Next">‚è≠Ô∏è</button>
                                <div class="flex-1 text-center text-xs" style="color: var(--skin-text-muted);">
                                    <span id="track-position">Track 0/0</span>
                                </div>
                                <label class="flex items-center gap-1 text-xs cursor-pointer" style="color: var(--skin-text-muted);">
                                    <input type="checkbox" id="auto-advance" checked class="rounded" onchange="savePlayerSettings()">
                                    Auto
                                </label>
                            </div>
                            
                            <div id="now-playing" class="text-sm mb-4" style="color: var(--skin-text-secondary);">
                                <div class="flex items-center gap-3">
                                    <div class="w-16 h-16 rounded" style="background-color: var(--skin-bg-tertiary);"></div>
                                    <div>
                                        <div class="font-semibold">Select a station to begin</div>
                                        <div class="text-xs" style="color: var(--skin-text-muted);">Your 90's alternative vibes await</div>
                                    </div>
                                </div>
                            </div>
                            <div id="recent-tracks" class="space-y-2 text-sm" style="color: var(--skin-text-muted);">
                                <div class="text-xs uppercase tracking-wide mb-2">Recent Tracks</div>
                                <div class="italic">Play something to see recent tracks...</div>
                            </div>
                        </div>
                        
                        <!-- Favorites View -->
                        <div id="favorites-view" class="hidden">
                            <div id="favorites-list" class="space-y-2 text-sm" style="color: var(--skin-text-muted);">
                                <div class="text-xs uppercase tracking-wide mb-2">‚ù§Ô∏è Your Favorite Tracks</div>
                                <div class="italic">Loading favorites...</div>
                            </div>
                        </div>
                        
                        <!-- Search View -->
                        <div id="search-view" class="hidden">
                            <div class="mb-4">
                                <label class="text-sm" style="color: var(--skin-text-muted);">Search for music genres/tags:</label>
                                <div class="flex gap-2 mt-2">
                                    <input type="text" id="station-search" placeholder="e.g., synthwave, post-punk, indie..." 
                                        class="flex-1 px-3 py-2 rounded text-sm" 
                                        style="background-color: var(--skin-bg-primary); border: 1px solid var(--skin-border-primary); color: var(--skin-text-secondary);"
                                        onkeypress="if(event.key==='Enter') searchStations()">
                                    <button onclick="searchStations()" class="px-4 py-2 rounded text-sm" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üîç</button>
                                </div>
                            </div>
                            <div id="search-results" class="space-y-2 text-sm" style="color: var(--skin-text-muted);">
                                <div class="text-xs uppercase tracking-wide mb-2">üîç Search Results</div>
                                <div class="italic">Search for genres, artists, or music styles...</div>
                            </div>
                            <div class="mt-4 pt-4" style="border-top: 1px solid var(--skin-border-primary);">
                                <div class="text-xs uppercase tracking-wide mb-2" style="color: var(--skin-text-muted);">üìª Your Saved Stations</div>
                                <div id="custom-stations" class="space-y-2">
                                    <div class="italic text-xs" style="color: var(--skin-text-muted);">No custom stations yet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Jokes & Quote -->
                <div data-widget="jokes_quote" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div data-widget="jokes" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-jokes-border, #9333ea);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-primary-light);">üòÑ Jokes</h3>
                            <button onclick="readJokes()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="jokes" class="text-sm" style="color: var(--skin-text-secondary);">Loading...</div>
                    </div>
                    <div data-widget="quote" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-quote-border, #4f46e5);">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-secondary-light);">‚ú® Quote</h3>
                            <button onclick="readQuote()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-secondary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="quote" class="text-sm italic" style="color: var(--skin-text-secondary);">Loading...</div>
                    </div>
                </div>

                <!-- eBay Auctions Section (Roger) -->
                <div data-widget="ebay" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 2px solid var(--skin-ebay-border, #eab308);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-accent);">
                            <i class="fas fa-gavel mr-2"></i>eBay Auction Finds
                        </h3>
                        <button onclick="loadEbayAuctions()" class="px-4 py-2 rounded-lg text-sm" style="background-color: var(--skin-accent); color: var(--skin-bg-primary);">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <p class="text-sm mb-4" style="color: var(--skin-text-muted);">üíª Retro laptops & gaming systems ending soon with great prices</p>
                    <div id="ebay-auctions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center py-8 col-span-full" style="color: var(--skin-text-muted);">Loading retro tech auctions...</div>
                    </div>
                </div>

                <!-- Dark News Section (Dracula) - Horror, Fantasy, 90s Music -->
                <div data-widget="dark_news" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-news-border, #dc2626);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-accent);">
                            <i class="fas fa-moon mr-2"></i>Dark News Feed
                        </h3>
                        <button onclick="loadDarkNews()" class="px-4 py-2 rounded-lg text-sm" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="loadDarkNews('horror')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">üßõ Horror</button>
                        <button onclick="loadDarkNews('fantasy')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">üêâ Fantasy</button>
                        <button onclick="loadDarkNews('90s_music')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">üé∏ 90's Music</button>
                        <button onclick="loadDarkNews('gothic')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);">ü¶á Gothic</button>
                    </div>
                    <div id="dark-news-list" class="space-y-3">
                        <div class="text-center py-8" style="color: var(--skin-text-muted);">Loading dark news...</div>
                    </div>
                </div>

                <!-- Art Communities (Dracula) -->
                <div data-widget="art_communities" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-communities-border, #9333ea);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-primary);">
                            <i class="fas fa-palette mr-2"></i>Art Communities
                        </h3>
                        <button onclick="loadArtCommunities()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">Refresh</button>
                    </div>
                    <div id="art-communities-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a href="https://reddit.com/r/Art" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé® r/Art</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Art and artists</div>
                        </a>
                        <a href="https://reddit.com/r/DigitalArt" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üíª r/DigitalArt</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Digital creation</div>
                        </a>
                        <a href="https://reddit.com/r/creepy" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üëª r/creepy</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Dark and creepy art</div>
                        </a>
                        <a href="https://reddit.com/r/ImaginaryMonsters" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üê≤ r/ImaginaryMonsters</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Fantasy creatures</div>
                        </a>
                    </div>
                </div>

                <!-- Music Communities (Dracula) -->
                <div data-widget="music_communities" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 2px solid var(--skin-communities-border, #9333ea);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--skin-primary);">
                            <i class="fas fa-music mr-2"></i>Music Communities
                        </h3>
                        <button onclick="loadMusicCommunities()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">Refresh</button>
                    </div>
                    <div id="music-communities-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a href="https://reddit.com/r/90sAlternative" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé∏ r/90sAlternative</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">90's alternative rock</div>
                        </a>
                        <a href="https://reddit.com/r/goth" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">ü¶á r/goth</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Goth music & culture</div>
                        </a>
                        <a href="https://reddit.com/r/musicals" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé≠ r/musicals</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Musical theater</div>
                        </a>
                        <a href="https://reddit.com/r/singing" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                            <div class="font-semibold" style="color: var(--skin-text-primary);">üé§ r/singing</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Singing tips & feedback</div>
                        </a>
                    </div>
                </div>

                <!-- Calm Radar / Anxiety Feed -->
                    

                <!-- Roger Home Content - Modular Widgets Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div data-widget="parts_search" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">üîß Parts Search</h3>
                        <div id="parts" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="history_fact" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">üìú History Fact</h3>
                        <div id="history" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="starwars" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">‚≠ê Star Wars</h3>
                        <div id="starwars" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="communities" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--skin-text-secondary);">üöÄ Communities</h3>
                        <div id="communities" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <div data-widget="roger_quotes" class="widget-container bg-gray-800 rounded-lg p-6" style="border: 1px solid var(--skin-border-primary);">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-text-secondary);">ü§ñ Roger Quotes</h3>
                            <button onclick="readRogerQuote()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="roger-quotes" class="text-sm" style="color: var(--skin-text-muted);">Loading...</div>
                    </div>
                    <!-- Demon Quote Widget - Shows skin-specific quotes -->
                    <div data-widget="dracula_quotes" class="widget-container bg-gray-800 rounded-lg p-6 hidden" style="border: 1px solid var(--skin-border-primary);">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold" style="color: var(--skin-text-secondary);">üòà Demon's Wisdom</h3>
                            <button onclick="readDraculaQuote()" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">üîä Read</button>
                        </div>
                        <div id="dracula-quotes" class="text-sm italic" style="color: var(--skin-text-muted);">Loading chaotic wisdom...</div>
                    </div>
                </div>
            </section>

            <!-- Tasks Section -->
            <section id="section-tasks" data-widget="tasks" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Tasks</div>
                    <div class="text-xs text-gray-300">Smart tasks from calendar and email</div>
                </div>
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">Tasks</h2>
                        <div class="flex gap-2">
                            <button onclick="generateSmartTasks(true)" class="px-3 py-2 bg-blue-700 hover:bg-blue-600 rounded text-sm">Generate Smart Tasks</button>
                            <label class="flex items-center gap-2 text-xs text-gray-300">
                                <input id="include-email" type="checkbox" class="accent-blue-500"> Include Email
                            </label>
                        </div>
                    </div>
                    <div id="tasks-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-gray-400 col-span-full text-center py-8">Loading tasks...</div>
                    </div>
                </div>
            </section>

            <!-- Weather Section -->
            <section id="section-weather" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Weather</div>
                    <div class="text-xs text-gray-300">Local station data, conditions, forecast and alerts</div>
                </div>
                
                <!-- Local Weather Station (Ambient Weather) -->
                <div id="ambient-weather-section" data-widget="ambient_weather" class="bg-gray-800 rounded-lg border border-green-600 p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-green-300">üè† Local Weather Station</h3>
                        <button onclick="loadAmbientWeather()" class="px-3 py-2 bg-green-700 hover:bg-green-600 rounded text-xs">Refresh</button>
                    </div>
                    <div id="ambient-weather-display" class="text-gray-200">Loading local station data...</div>
                </div>
                
                <!-- General Weather -->
                <div class="bg-gray-800 rounded-lg border border-cyan-700 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-cyan-300">üå°Ô∏è Weather</h3>
                        <div class="flex gap-2">
                            <button onclick="useCurrentLocation()" class="px-3 py-2 bg-cyan-700 hover:bg-cyan-600 rounded text-xs">Use Current</button>
                        </div>
                    </div>
                    <div class="flex gap-3 mb-3">
                        <input id="weather-search-input-2" type="text" placeholder="Search city or place..." class="flex-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded text-sm text-gray-200 placeholder-gray-500">
                        <button onclick="searchWeatherTo('weather-search-input-2','weather-search-results-2')" class="px-3 py-2 bg-cyan-700 hover:bg-cyan-600 rounded text-sm">Search</button>
                    </div>
                    <div id="weather-search-results-2" class="mb-3 text-sm text-gray-400"></div>
                    <div id="weather-display-2" class="text-gray-200">Loading...</div>
                    <div id="weather-forecast-2" class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2"></div>
                    <div id="weather-alerts-2" class="mt-4"></div>
                </div>
            </section>

            <!-- Calendar Section -->
            <section id="section-calendar" data-widget="calendar" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Calendar</div>
                    <div class="text-xs text-gray-300">Today's schedule and upcoming events</div>
                </div>
                
                <!-- Week Overview (Small) -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold text-gray-300">This Week</h4>
                        <div class="flex gap-2">
                            <button onclick="navigateCalendarWeek(-1)" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">‚Üê Prev</button>
                            <button onclick="navigateCalendarWeek(0)" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Today</button>
                            <button onclick="navigateCalendarWeek(1)" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Next ‚Üí</button>
                        </div>
                    </div>
                    <div id="calendar-week-view" class="grid grid-cols-7 gap-1 text-center text-xs">
                        <!-- Week days populated by JS -->
                    </div>
                </div>
                
                <!-- Day View with Timeline -->
                <div class="bg-gray-800 rounded-lg border border-green-600 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 id="calendar-day-title" class="text-2xl font-bold text-green-300">
                            <i class="fas fa-calendar-alt mr-2"></i>Today
                        </h3>
                        <div class="flex gap-2 items-center">
                            <button onclick="stopAllAudio()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" title="Stop voice announcements">üîá Mute</button>
                            <button onclick="readUpcomingEvents()" class="px-3 py-1 bg-green-700 hover:bg-green-600 rounded text-xs">üîä Read Events</button>
                        </div>
                    </div>
                    
                    <!-- Upcoming Events List -->
                    <div class="mb-4 p-3 bg-gray-900 rounded border border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">üìã Upcoming</h4>
                        <div id="calendar-upcoming" class="space-y-2 text-sm">
                            <!-- Upcoming events populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Day Timeline View -->
                    <div id="calendar-day-view" class="relative bg-gray-900 rounded border border-green-700 min-h-96 overflow-y-auto" style="max-height: 500px;">
                        <!-- Timeline populated by JS -->
                    </div>
                </div>
            </section>

            <!-- News Section -->
            <section id="section-news" data-widget="news" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">News</div>
                    <div class="text-xs text-gray-300">Curated updates and supportive tips</div>
                </div>
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">News</h2>
                        <div class="flex gap-2">
                            <select id="news-filter" onchange="loadNews()" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded text-sm text-gray-200">
                                <option value="all">All</option>
                                <option value="oregon">Oregon</option>
                                <option value="starwars">Star Wars</option>
                                <option value="startrek">Star Trek</option>
                                <!-- Dark/Gothic categories - shown when Demon theme active -->
                                <option value="horror" class="dark-news-option">üßõ Horror</option>
                                <option value="gothic" class="dark-news-option">ü¶á Gothic</option>
                                <option value="fantasy" class="dark-news-option">üêâ Fantasy</option>
                                <option value="90s_music" class="dark-news-option">üé∏ 90s Music</option>
                            </select>
                            <button onclick="loadNews()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Refresh</button>
                        </div>
                    </div>
                    <div id="news-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-gray-400 col-span-full text-center py-8">Loading news...</div>
                    </div>
                    <div data-widget="calm_tips" class="mt-6">
                        <h3 class="text-lg font-semibold text-emerald-300 mb-2"><i class="fas fa-heart mr-2"></i>Calm Tips</h3>
                        <div id="calm-tips" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-gray-400 col-span-full text-center py-6">Loading calm tips...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Home Assistant Section -->
            <section id="section-homeassistant" class="section-content hidden p-8">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">üè† Home Assistant</div>
                    <div class="text-xs text-gray-300">Smart home control center</div>
                </div>
                <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden" style="height: calc(100vh - 200px);">
                    <div class="flex items-center justify-between p-3 border-b border-gray-700 bg-gray-900/50">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-home text-cyan-400"></i>
                            <span class="font-semibold">Home Assistant</span>
                            <span id="ha-connection-status" class="text-xs px-2 py-0.5 rounded bg-gray-700">Connecting...</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="refreshHomeAssistant()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <a href="http://homeassistant.home:8123" target="_blank" class="px-3 py-1 bg-cyan-600 hover:bg-cyan-700 rounded text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>Open Full UI
                            </a>
                        </div>
                    </div>
                    <iframe 
                        id="ha-iframe" 
                        src="http://homeassistant.home:8123/lovelace/0" 
                        class="w-full h-full border-0"
                        onload="document.getElementById('ha-connection-status').textContent = 'Connected'; document.getElementById('ha-connection-status').className = 'text-xs px-2 py-0.5 rounded bg-green-700';"
                        onerror="document.getElementById('ha-connection-status').textContent = 'Offline'; document.getElementById('ha-connection-status').className = 'text-xs px-2 py-0.5 rounded bg-red-700';"
                    ></iframe>
                </div>
                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4" id="ha-quick-controls">
                    <button onclick="haQuickAction('lights')" class="p-4 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 text-center">
                        <i class="fas fa-lightbulb text-2xl text-yellow-400 mb-2"></i>
                        <div class="text-sm">Lights</div>
                    </button>
                    <button onclick="haQuickAction('climate')" class="p-4 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 text-center">
                        <i class="fas fa-thermometer-half text-2xl text-cyan-400 mb-2"></i>
                        <div class="text-sm">Climate</div>
                    </button>
                    <button onclick="haQuickAction('media')" class="p-4 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 text-center">
                        <i class="fas fa-tv text-2xl text-purple-400 mb-2"></i>
                        <div class="text-sm">Media</div>
                    </button>
                    <button onclick="haQuickAction('security')" class="p-4 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 text-center">
                        <i class="fas fa-shield-alt text-2xl text-green-400 mb-2"></i>
                        <div class="text-sm">Security</div>
                    </button>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section-content hidden p-8 pb-24">
                <div class="mb-4">
                    <div class="text-3xl font-extrabold text-white drop-shadow">Settings</div>
                    <div class="text-xs text-gray-300">Personalize your dashboard</div>
                </div>
                <div id="settings-container" class="space-y-8">
                    <div class="text-gray-400">Loading settings...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <!-- Voice Settings Modal -->
    <div id="voice-settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-8 max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="voice-settings-title" class="text-2xl font-bold text-purple-300">ü§ñ Voice Settings</h2>
                <button onclick="closeVoiceSettings()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="voice-settings-content" class="space-y-6">Loading...</div>
        </div>
    </div>

    <!-- Garfield Archive Modal -->
    <div id="garfield-archive-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg border border-orange-600 p-8 max-w-4xl w-full max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-orange-300"><i class="fas fa-archive mr-2"></i>Garfield Archive</h2>
                <button onclick="closeGarfieldArchive()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="garfield-archive-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">Loading...</div>
        </div>
    </div>

    <!-- Comic Viewer Modal -->
    <div id="comic-viewer-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-lg border border-orange-600 p-6 max-w-5xl w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 id="comic-viewer-title" class="text-2xl font-bold text-orange-300">Comic Viewer</h2>
                    <p id="comic-viewer-date" class="text-sm text-gray-400 mt-1"></p>
                </div>
                <button onclick="closeComicViewer()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <!-- Comic Image with Navigation -->
            <div class="flex-1 flex items-center justify-center relative mb-4">
                <button onclick="previousComic()" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-lg shadow-lg z-10">
                    <i class="fas fa-chevron-left text-xl"></i>
                </button>
                
                <div id="comic-viewer-image-container" class="max-w-full max-h-[60vh] flex items-center justify-center">
                    <img id="comic-viewer-image" src="" alt="Comic" class="max-w-full max-h-full object-contain rounded-lg">
                </div>
                
                <button onclick="nextComic()" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-lg shadow-lg z-10">
                    <i class="fas fa-chevron-right text-xl"></i>
                </button>
            </div>
            
            <!-- Controls -->
            <div class="flex items-center justify-between gap-4 pt-4 border-t border-gray-700">
                <!-- Like/Dislike -->
                <div class="flex gap-3">
                    <button onclick="likeComic()" id="comic-like-btn" class="px-4 py-2 bg-green-700 hover:bg-green-600 rounded-lg flex items-center gap-2">
                        <i class="fas fa-thumbs-up"></i>
                        <span>Like</span>
                    </button>
                    <button onclick="dislikeComic()" id="comic-dislike-btn" class="px-4 py-2 bg-red-700 hover:bg-red-600 rounded-lg flex items-center gap-2">
                        <i class="fas fa-thumbs-down"></i>
                        <span>Dislike</span>
                    </button>
                </div>
                
                <!-- Info and Actions -->
                <div class="flex gap-3">
                    <span id="comic-viewer-counter" class="text-gray-400 text-sm self-center"></span>
                    <button onclick="openComicSource()" class="px-4 py-2 bg-orange-700 hover:bg-orange-600 rounded-lg flex items-center gap-2">
                        <i class="fas fa-external-link-alt"></i>
                        <span>View Source</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Picker Modal -->
    <div id="avatar-picker-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg border border-purple-500/50 p-6 max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" style="color: var(--skin-primary-light);"><i class="fas fa-user-circle mr-2"></i>Choose Avatar</h2>
                <button onclick="closeAvatarPicker()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="text-sm text-gray-400 mb-4">Select an avatar for your assistant. This choice is saved for your dashboard.</div>
            <div id="avatar-picker-grid" class="grid grid-cols-3 md:grid-cols-4 gap-4 overflow-y-auto flex-1">
                <!-- Avatars will be loaded here -->
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700 text-center">
                <button onclick="closeAvatarPicker()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/dashboard.js?v=6"></script>
    <script src="/static/leads_modern.js?v=6"></script>
    <script src="/static/trust_layer_ui.js?v=2"></script>
    <script src="/static/provider_manager.js?v=2"></script>

    <script>
        // Backgrounds
        const BACKGROUNDS = [
            { key: 'bg1', type: 'image', value: '/static/backgrounds/photo-1472457897821-70d3819a0e24.avif' },
            { key: 'bg2', type: 'image', value: '/static/backgrounds/photo-1618336753974-aae8e04506aa.avif' },
            { key: 'bg3', type: 'image', value: '/static/backgrounds/premium_photo-1721254102757-6ac520920e0a.avif' }
        ];

        function applyBackground(bg) {
            const layer = document.getElementById('app-bg');
            if (!layer) return;
            if (bg.type === 'gradient') {
                layer.style.backgroundImage = bg.value;
            } else {
                layer.style.backgroundImage = `url('${bg.value}')`;
            }
        }

        function setBackgroundByKey(key) {
            const idx = BACKGROUNDS.findIndex(b => b.key === key);
            const bg = idx >= 0 ? BACKGROUNDS[idx] : BACKGROUNDS[0];
            try { localStorage.setItem('dashboard_bg_key', bg.key); } catch {}
            const select = document.getElementById('bg-select');
            if (select) select.value = bg.key;
            applyBackground(bg);
        }

        function cycleBackground(dir = 1) {
            const current = (localStorage.getItem('dashboard_bg_key') || BACKGROUNDS[0].key);
            const idx = BACKGROUNDS.findIndex(b => b.key === current);
            const next = (idx + dir + BACKGROUNDS.length) % BACKGROUNDS.length;
            setBackgroundByKey(BACKGROUNDS[next].key);
        }

        function setBackgroundUrl(url) {
            if (!url) return;
            const bg = { key: 'custom-url', type: 'image', value: url };
            try { localStorage.setItem('dashboard_bg_custom', url); localStorage.setItem('dashboard_bg_key', bg.key); } catch {}
            const select = document.getElementById('bg-select');
            if (select) select.value = 'custom-url';
            const layer = document.getElementById('app-bg');
            if (layer) layer.style.backgroundImage = `url('${url}')`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('bg-select');
            const prev = document.getElementById('bg-prev');
            const next = document.getElementById('bg-next');
            const urlInput = document.getElementById('bg-url');
            const urlBtn = document.getElementById('bg-url-set');
            // Inject custom-url option if present
            try {
                const custom = localStorage.getItem('dashboard_bg_custom');
                if (custom && select && ![...select.options].some(o => o.value === 'custom-url')) {
                    const opt = document.createElement('option');
                    opt.value = 'custom-url'; opt.textContent = 'Custom URL';
                    select.appendChild(opt);
                }
            } catch {}
            if (select) {
                select.addEventListener('change', () => {
                    const v = select.value;
                    if (v === 'custom-url') {
                        const saved = localStorage.getItem('dashboard_bg_custom');
                        if (saved) setBackgroundUrl(saved);
                    } else {
                        setBackgroundByKey(v);
                    }
                });
            }
            if (prev) prev.addEventListener('click', () => cycleBackground(-1));
            if (next) next.addEventListener('click', () => cycleBackground(1));
            if (urlBtn) urlBtn.addEventListener('click', () => setBackgroundUrl(urlInput.value.trim()));
            
            // DON'T set background here - let skin system handle it after load
            // This prevents the old hardcoded backgrounds from being applied before skin loads
            
            // Initialize skin system (this will set backgrounds from skin config)
            initializeSkin();
        });

        // =====================================================
        // SKIN/THEME SYSTEM
        // =====================================================
        
        let currentSkin = null;
        let availableSkins = [];
        
        async function loadAvailableSkins() {
            // Fetch available skins from API and populate dropdowns
            try {
                const response = await fetch('/api/skins');
                const data = await response.json();
                if (data.success && data.skins) {
                    availableSkins = data.skins;
                    populateSkinDropdowns();
                }
            } catch (error) {
                console.error('Error loading skins:', error);
            }
        }
        
        function populateSkinDropdowns() {
            const skinSelectors = ['skin-select', 'skin-select-header'];
            const skinEmojis = {
                'roger': 'ü§ñ',
                'dracula': 'üòà',
                'alice': 'üê∞',
                'jedi': '‚öîÔ∏è'
            };
            
            skinSelectors.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                // Clear existing options
                select.innerHTML = '';
                
                // Add options for each available skin
                availableSkins.forEach(skin => {
                    const option = document.createElement('option');
                    option.value = skin.name;
                    const emoji = skinEmojis[skin.name] || 'üé®';
                    option.textContent = `${emoji} ${skin.display_name}`;
                    select.appendChild(option);
                });
            });
        }
        
        async function initializeSkin() {
            // Load available skins first
            await loadAvailableSkins();
            
            // Load saved skin preference or get active from server
            const savedSkin = localStorage.getItem('dashboard_skin') || 'roger';
            await switchSkin(savedSkin, false);
            
            // Update skin selector
            const skinSelect = document.getElementById('skin-select');
            if (skinSelect) {
                skinSelect.value = savedSkin;
            }
            
            console.log('‚úÖ Skin system initialized');
        }
        
        async function switchSkin(skinName, animate = true) {
            try {
                console.log(`üé® Switching to skin: ${skinName}`);
                
                // Fetch skin config from server
                const response = await fetch(`/api/skins/switch/${skinName}`, { method: 'POST' });
                const data = await response.json();
                
                if (!data.success) {
                    console.error('Failed to switch skin:', data.error);
                    return;
                }
                
                currentSkin = data.skin;
                console.log('üì¶ Skin data received:', JSON.stringify(currentSkin.dashboard?.widgets || {}, null, 2));
                localStorage.setItem('dashboard_skin', skinName);
                
                // Apply the skin (colors, avatar, widgets visibility)
                applySkin(currentSkin, animate);
                
                // Reload data for newly visible widgets
                initializeDataLoaders();
                
                console.log(`‚úÖ Skin applied: ${currentSkin.display_name}`);
                
            } catch (error) {
                console.error('Error switching skin:', error);
            }
        }
        
        function applySkin(skin, animate = true) {
            if (!skin) return;
            
            // Update CSS variables
            const cssVars = skin.css_variables || {};
            const root = document.documentElement;
            for (const [key, value] of Object.entries(cssVars)) {
                root.style.setProperty(key, value);
            }
            
            // Update page title
            document.getElementById('page-title').textContent = `${skin.display_name} - Personal Assistant`;
            
            // Update assistant avatar - check for user override first
            const avatar = document.getElementById('assistant-avatar');
            if (avatar) {
                const avatarOverride = localStorage.getItem('dashboard_avatar_override');
                if (avatarOverride) {
                    avatar.src = avatarOverride;
                } else if (skin.avatar) {
                    avatar.src = skin.avatar;
                }
                avatar.alt = skin.display_name;
            }
            
            // Update assistant name
            const nameEl = document.getElementById('assistant-name');
            if (nameEl) {
                nameEl.textContent = skin.display_name;
            }
            
            // Update assistant link in sidebar (both top link and nav button)
            const assistantLink = document.getElementById('assistant-link');
            if (assistantLink && skin.assistant) {
                assistantLink.href = skin.assistant.url || '/assistant';
                assistantLink.textContent = `Open ${skin.display_name}`;
            }
            
            // Update assistant nav link in sidebar
            const navLink = document.getElementById('assistant-nav-link');
            if (navLink && skin.assistant) {
                navLink.href = skin.assistant.url || '/assistant';
            }
            const navName = document.getElementById('assistant-nav-name');
            if (navName) {
                navName.textContent = `${skin.display_name} Assistant`;
            }
            // Update nav icon based on skin
            const navIcon = document.getElementById('assistant-nav-icon');
            if (navIcon) {
                // Use skin-specific icon if available
                const iconClass = skin.name === 'demon' || skin.name === 'dracula' ? 'fas fa-ghost' : 
                                  skin.name === 'alice' ? 'fas fa-rabbit' :
                                  skin.name === 'jedi' ? 'fas fa-jedi' : 'fas fa-robot';
                navIcon.className = iconClass + ' mr-2';
            }
            
            // Update header title with tagline
            const headerTitle = document.getElementById('header-title');
            if (headerTitle && skin.tagline) {
                headerTitle.textContent = skin.tagline;
            }
            
            // Update ALL skin selectors (sidebar and header)
            const skinSelectors = ['skin-select', 'skin-select-header'];
            skinSelectors.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) sel.value = skin.name;
            });
            
            // Update backgrounds dropdown if skin has backgrounds
            if (skin.backgrounds && skin.backgrounds.length > 0) {
                updateBackgroundOptions(skin.backgrounds);
            }
            
            // MODULAR WIDGET SYSTEM - Show/hide widgets based on user preferences + skin
            applyModuleVisibility();
            
            // Update news filter options based on theme
            updateNewsFilterOptions(skin.name);
            
            // Update navigation if skin has custom nav
            if (skin.navigation && skin.navigation.length > 0) {
                // Could update nav labels/icons here
            }
            
            // Apply animation effect
            if (animate) {
                document.body.style.opacity = '0.8';
                setTimeout(() => {
                    document.body.style.opacity = '1';
                }, 150);
            }
            
            console.log(`üé® Theme applied: ${skin.display_name} - Colors and widgets updated!`);
        }
        
        // Update news filter options based on current theme
        function updateNewsFilterOptions(themeName) {
            const filter = document.getElementById('news-filter');
            if (!filter) return;
            
            const darkOptions = filter.querySelectorAll('.dark-news-option');
            const isDarkTheme = themeName === 'dracula' || themeName === 'demon';
            
            darkOptions.forEach(opt => {
                opt.style.display = isDarkTheme ? '' : 'none';
            });
            
            // If switching away from dark theme and a dark filter was selected, reset to 'all'
            if (!isDarkTheme && ['horror', 'gothic', 'fantasy', '90s_music'].includes(filter.value)) {
                filter.value = 'all';
                loadNews();
            }
            
            console.log(`üì∞ News filters updated for ${themeName} theme`);
        }
        
        // Widget visibility management - integrates module registry with skin config
        function applyWidgetVisibility(skin) {
            // Deprecated - use applyModuleVisibility() instead
            // This is kept for backwards compatibility
            applyModuleVisibility();
        }
        
        // Load Dracula-specific quote
        async function loadDraculaQuote() {
            const el = document.getElementById('dracula-quotes');
            if (!el || !currentSkin) return;
            
            const quote = getSkinQuote('random_quotes') || getSkinQuote('greetings');
            if (quote) {
                el.innerHTML = `<p class="italic">"${quote}"</p>`;
            }
        }
        
        // Read Dracula quote aloud
        async function readDraculaQuote() {
            const el = document.getElementById('dracula-quotes');
            if (!el) return;
            const text = el.innerText;
            await speakText(text);
        }
        
        // Dark news loader for Dracula theme - fetches from real news API
        async function loadDarkNews(category = 'all') {
            const list = document.getElementById('dark-news-list');
            if (!list) return;
            
            list.innerHTML = '<div class="text-center py-4" style="color: var(--skin-text-muted);">Loading dark news...</div>';
            
            try {
                // Fetch from real news API with dark category filters
                const categories = category === 'all' ? ['horror', 'gothic', 'fantasy', '90s_music'] : [category];
                let allArticles = [];
                
                for (const cat of categories) {
                    const resp = await fetch(`/api/news?filter=${encodeURIComponent(cat)}`);
                    const data = await resp.json();
                    if (data.articles) {
                        allArticles.push(...data.articles.map(a => ({
                            title: a.title,
                            source: a.source || 'Unknown',
                            link: a.url || '#',
                            category: cat
                        })));
                    }
                }
                
                // Deduplicate by title
                const seen = new Set();
                const uniqueArticles = allArticles.filter(a => {
                    if (seen.has(a.title)) return false;
                    seen.add(a.title);
                    return true;
                });
                
                if (uniqueArticles.length === 0) {
                    list.innerHTML = '<div class="text-center py-4" style="color: var(--skin-text-muted);">No dark news found... Try the News section filters instead.</div>';
                    return;
                }
                
                // Add category icons
                const catIcons = { horror: 'üßõ', gothic: 'ü¶á', fantasy: 'üêâ', '90s_music': 'üé∏' };
                
                list.innerHTML = uniqueArticles.slice(0, 12).map(item => `
                    <a href="${item.link}" target="_blank" class="block p-3 rounded hover:opacity-80" style="background-color: var(--skin-bg-tertiary);">
                        <div class="font-semibold" style="color: var(--skin-text-primary);">${catIcons[item.category] || 'üì∞'} ${item.title}</div>
                        <div class="text-xs" style="color: var(--skin-text-muted);">${item.source}</div>
                    </a>
                `).join('');
            } catch (e) {
                console.error('Dark news error:', e);
                list.innerHTML = '<div class="text-center py-4" style="color: var(--skin-text-muted);">Error loading news. Try the News section.</div>';
            }
        }
        
        // Music player - Last.fm integration
        let currentStation = null;
        let currentPlaylist = [];
        let currentTrackIndex = 0;
        let isPlaying = false;
        
        // Load saved player state
        function loadPlayerState() {
            const state = JSON.parse(localStorage.getItem('musicPlayerState') || '{}');
            return state;
        }
        
        // Save player state
        function savePlayerState() {
            const station = document.getElementById('lastfm-station')?.value || '90s_alternative';
            const state = loadPlayerState();
            state[station] = {
                trackIndex: currentTrackIndex,
                timestamp: Date.now()
            };
            localStorage.setItem('musicPlayerState', JSON.stringify(state));
        }
        
        // Save player settings (auto-advance, etc)
        function savePlayerSettings() {
            const autoAdvance = document.getElementById('auto-advance')?.checked ?? true;
            localStorage.setItem('musicAutoAdvance', autoAdvance);
        }
        
        // Load player settings
        function loadPlayerSettings() {
            const autoAdvance = localStorage.getItem('musicAutoAdvance');
            if (autoAdvance !== null) {
                const checkbox = document.getElementById('auto-advance');
                if (checkbox) checkbox.checked = autoAdvance === 'true';
            }
        }
        
        // Get/save custom stations
        function getCustomStations() {
            return JSON.parse(localStorage.getItem('customMusicStations') || '[]');
        }
        
        function saveCustomStation(tag, name) {
            const stations = getCustomStations();
            if (!stations.find(s => s.tag === tag)) {
                stations.push({ tag, name, addedAt: Date.now() });
                localStorage.setItem('customMusicStations', JSON.stringify(stations));
            }
            loadCustomStations();
        }
        
        function removeCustomStation(tag) {
            let stations = getCustomStations();
            stations = stations.filter(s => s.tag !== tag);
            localStorage.setItem('customMusicStations', JSON.stringify(stations));
            loadCustomStations();
        }
        
        function loadCustomStations() {
            const container = document.getElementById('custom-stations');
            const stations = getCustomStations();
            
            if (!container) return;
            
            if (stations.length === 0) {
                container.innerHTML = '<div class="italic text-xs" style="color: var(--skin-text-muted);">No custom stations yet</div>';
                return;
            }
            
            container.innerHTML = stations.map(s => `
                <div class="flex items-center gap-2 p-2 rounded" style="background-color: var(--skin-bg-tertiary);">
                    <button onclick="playCustomStation('${s.tag}')" class="px-2 py-1 rounded text-xs" style="background-color: var(--skin-primary);">‚ñ∂Ô∏è</button>
                    <div class="flex-1">
                        <div class="text-sm" style="color: var(--skin-text-primary);">${s.name}</div>
                        <div class="text-xs" style="color: var(--skin-text-muted);">${s.tag}</div>
                    </div>
                    <button onclick="removeCustomStation('${s.tag}')" class="px-2 py-1 text-xs" style="color: var(--skin-accent);">‚úï</button>
                </div>
            `).join('');
        }
        
        function playCustomStation(tag) {
            showMusicView('station');
            loadMusicStation(tag);
        }
        
        // Update track position display
        function updateTrackPosition() {
            const positionEl = document.getElementById('track-position');
            if (positionEl && currentPlaylist.length > 0) {
                positionEl.textContent = `Track ${currentTrackIndex + 1}/${currentPlaylist.length}`;
            }
        }
        
        // Play controls
        function playCurrentTrack() {
            if (currentPlaylist.length > 0 && currentTrackIndex < currentPlaylist.length) {
                const track = currentPlaylist[currentTrackIndex];
                playTrackInPlayer(track.artist, track.name);
                savePlayerState();
            }
        }
        
        function playNextTrack() {
            if (currentTrackIndex < currentPlaylist.length - 1) {
                currentTrackIndex++;
                playCurrentTrack();
                updateTrackPosition();
                highlightCurrentTrack();
            }
        }
        
        function playPreviousTrack() {
            if (currentTrackIndex > 0) {
                currentTrackIndex--;
                playCurrentTrack();
                updateTrackPosition();
                highlightCurrentTrack();
            }
        }
        
        function highlightCurrentTrack() {
            // Remove previous highlights
            document.querySelectorAll('.track-item').forEach(el => {
                el.style.border = 'none';
            });
            // Highlight current
            const currentEl = document.querySelector(`.track-item[data-index="${currentTrackIndex}"]`);
            if (currentEl) {
                currentEl.style.border = '2px solid var(--skin-primary)';
            }
        }

        async function loadMusicStation(stationId = null) {
            const station = stationId || document.getElementById('lastfm-station')?.value || '90s_alternative';
            const nowPlaying = document.getElementById('now-playing');
            const recentTracks = document.getElementById('recent-tracks');
            
            if (nowPlaying) {
                nowPlaying.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 rounded flex items-center justify-center text-2xl animate-pulse" style="background-color: var(--skin-bg-tertiary);">üéµ</div>
                        <div>
                            <div class="font-semibold">Loading ${station.replace(/_/g, ' ')}...</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">Fetching tracks from Last.fm</div>
                        </div>
                    </div>
                `;
            }
            
            try {
                const response = await fetch(`/api/music/station/${station}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    currentStation = data.data;
                    // Store playlist
                    currentPlaylist = data.data.tracks || [];
                    
                    // Restore position from saved state
                    const state = loadPlayerState();
                    const savedState = state[station];
                    if (savedState && savedState.trackIndex < currentPlaylist.length) {
                        currentTrackIndex = savedState.trackIndex;
                    } else {
                        currentTrackIndex = 0;
                    }
                    
                    displayMusicStation(data.data);
                    updateTrackPosition();
                } else {
                    displayMusicError(data.error || 'Failed to load station');
                }
            } catch (error) {
                console.error('Music station error:', error);
                displayMusicError('Connection error');
            }
        }
        
        let currentlyPlayingTrack = null;
        
        function displayMusicStation(data) {
            const nowPlaying = document.getElementById('now-playing');
            const recentTracks = document.getElementById('recent-tracks');
            
            if (nowPlaying && data.tracks && data.tracks.length > 0) {
                // Use saved position
                currentlyPlayingTrack = data.tracks[currentTrackIndex] || data.tracks[0];
                displayNowPlaying(currentlyPlayingTrack);
            }
            
            if (recentTracks && data.tracks && data.tracks.length > 0) {
                recentTracks.innerHTML = `
                    <div class="text-xs uppercase tracking-wide mb-2" style="color: var(--skin-text-muted);">Playlist - ${data.tag} (${data.tracks.length} tracks)</div>
                    ${data.tracks.map((track, idx) => {
                        const artistEsc = track.artist.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const nameEsc = track.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const imageEsc = (track.image || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const urlEsc = (track.url || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const isCurrentTrack = idx === currentTrackIndex;
                        return `
                        <div class="track-item flex items-center gap-2 p-2 rounded hover:opacity-80" data-index="${idx}" style="background-color: var(--skin-bg-tertiary); ${isCurrentTrack ? 'border: 2px solid var(--skin-primary);' : ''}">
                            <button onclick="event.stopPropagation(); selectTrackByIndex(${idx})" class="w-8 h-8 rounded overflow-hidden flex-shrink-0 flex items-center justify-center hover:scale-110 transition-transform" style="background-color: ${isCurrentTrack ? 'var(--skin-accent)' : 'var(--skin-primary)'};" title="Play">
                                ${isCurrentTrack ? 'üîä' : '‚ñ∂Ô∏è'}
                            </button>
                            <div class="flex-1 min-w-0 cursor-pointer" onclick="selectTrackByIndex(${idx})">
                                <div class="text-sm truncate" style="color: var(--skin-text-primary);">${track.name}</div>
                                <div class="text-xs truncate" style="color: var(--skin-text-muted);">${track.artist}</div>
                            </div>
                            <button onclick="event.stopPropagation(); toggleFavoriteTrack('${artistEsc}', '${nameEsc}', '${imageEsc}', '${urlEsc}', this)" class="px-2 py-1 text-sm hover:scale-110 transition-transform" title="Add to Favorites">
                                ü§ç
                            </button>
                        </div>
                    `}).join('')}
                `;
            }
        }
        
        function selectTrackByIndex(index) {
            currentTrackIndex = index;
            if (currentPlaylist[index]) {
                currentlyPlayingTrack = currentPlaylist[index];
                displayNowPlaying(currentlyPlayingTrack);
                playTrackInPlayer(currentlyPlayingTrack.artist, currentlyPlayingTrack.name);
                updateTrackPosition();
                highlightCurrentTrack();
                savePlayerState();
            }
        }
        
        function displayNowPlaying(track) {
            const nowPlaying = document.getElementById('now-playing');
            if (!nowPlaying || !track) return;
            
            // Escape quotes for onclick handlers
            const artistEsc = track.artist.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const nameEsc = track.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            nowPlaying.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-16 h-16 rounded overflow-hidden relative group cursor-pointer" style="background-color: var(--skin-bg-tertiary);" onclick="playOnYouTube('${artistEsc}', '${nameEsc}')">
                        ${track.image ? `<img src="${track.image}" class="w-full h-full object-cover" alt="${track.name}">` : '<div class="w-full h-full flex items-center justify-center text-2xl">üéµ</div>'}
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="text-2xl">‚ñ∂Ô∏è</span>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold truncate" style="color: var(--skin-text-primary);">${track.name}</div>
                        <div class="text-sm truncate" style="color: var(--skin-text-secondary);">${track.artist}</div>
                        <div class="text-xs" style="color: var(--skin-text-muted);">${track.listeners ? Number(track.listeners).toLocaleString() + ' listeners' : 'Click to play'}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleFavorite('${artistEsc}', '${nameEsc}', '${track.image || ''}', '${track.url || ''}')" id="fav-btn-now-playing" class="px-3 py-2 rounded text-sm" style="background-color: var(--skin-bg-tertiary); color: var(--skin-text-secondary);" title="Add to Favorites">
                            ü§ç
                        </button>
                        <button onclick="playOnYouTube('${artistEsc}', '${nameEsc}')" class="px-4 py-2 rounded text-sm font-bold" style="background-color: #ff0000; color: white;" title="Play Now">
                            ‚ñ∂Ô∏è Play
                        </button>
                    </div>
                </div>
            `;
            // Check if this track is already favorited
            checkIfFavorite(track.artist, track.name);
        }
        
        // Track favorites cache
        let favoritesCache = {};
        
        async function checkIfFavorite(artist, name) {
            try {
                const response = await fetch(`/api/music/favorites/check?track_name=${encodeURIComponent(name)}&artist_name=${encodeURIComponent(artist)}`);
                const data = await response.json();
                const btn = document.getElementById('fav-btn-now-playing');
                if (btn) {
                    btn.innerHTML = data.is_favorite ? '‚ù§Ô∏è' : 'ü§ç';
                    btn.title = data.is_favorite ? 'Remove from Favorites' : 'Add to Favorites';
                }
                favoritesCache[`${artist}-${name}`] = data.is_favorite;
            } catch (e) {
                console.error('Error checking favorite:', e);
            }
        }
        
        async function toggleFavorite(artist, name, image, url) {
            const key = `${artist}-${name}`;
            const isFavorite = favoritesCache[key];
            const station = document.getElementById('lastfm-station')?.value || '90s_alternative';
            
            try {
                if (isFavorite) {
                    // Remove from favorites
                    await fetch(`/api/music/favorites?track_name=${encodeURIComponent(name)}&artist_name=${encodeURIComponent(artist)}`, { method: 'DELETE' });
                    favoritesCache[key] = false;
                } else {
                    // Add to favorites
                    await fetch('/api/music/favorites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            track_name: name,
                            artist_name: artist,
                            image_url: image,
                            lastfm_url: url,
                            station: station
                        })
                    });
                    favoritesCache[key] = true;
                }
                
                // Update button
                const btn = document.getElementById('fav-btn-now-playing');
                if (btn) {
                    btn.innerHTML = favoritesCache[key] ? '‚ù§Ô∏è' : 'ü§ç';
                    btn.title = favoritesCache[key] ? 'Remove from Favorites' : 'Add to Favorites';
                }
            } catch (e) {
                console.error('Error toggling favorite:', e);
            }
        }
        
        function showMusicView(view) {
            const stationView = document.getElementById('station-view');
            const favoritesView = document.getElementById('favorites-view');
            const searchView = document.getElementById('search-view');
            const btnStation = document.getElementById('btn-station-view');
            const btnFavorites = document.getElementById('btn-favorites-view');
            const btnSearch = document.getElementById('btn-search-view');
            
            // Hide all views
            stationView?.classList.add('hidden');
            favoritesView?.classList.add('hidden');
            searchView?.classList.add('hidden');
            
            // Reset all buttons
            [btnStation, btnFavorites, btnSearch].forEach(btn => {
                if (btn) {
                    btn.style.backgroundColor = 'var(--skin-bg-tertiary)';
                    btn.style.color = 'var(--skin-text-secondary)';
                }
            });
            
            if (view === 'station') {
                stationView?.classList.remove('hidden');
                if (btnStation) {
                    btnStation.style.backgroundColor = 'var(--skin-primary)';
                    btnStation.style.color = 'var(--skin-text-primary)';
                }
                loadMusicStation();
            } else if (view === 'favorites') {
                favoritesView?.classList.remove('hidden');
                if (btnFavorites) {
                    btnFavorites.style.backgroundColor = 'var(--skin-primary)';
                    btnFavorites.style.color = 'var(--skin-text-primary)';
                }
                loadFavorites();
            } else if (view === 'search') {
                searchView?.classList.remove('hidden');
                if (btnSearch) {
                    btnSearch.style.backgroundColor = 'var(--skin-primary)';
                    btnSearch.style.color = 'var(--skin-text-primary)';
                }
                loadCustomStations();
            }
        }
        
        // Search for new stations
        async function searchStations() {
            const searchInput = document.getElementById('station-search');
            const resultsDiv = document.getElementById('search-results');
            const query = searchInput?.value?.trim();
            
            if (!query || !resultsDiv) return;
            
            resultsDiv.innerHTML = `
                <div class="text-xs uppercase tracking-wide mb-2">üîç Searching...</div>
                <div class="italic">Looking for "${query}"...</div>
            `;
            
            try {
                // Search Last.fm for this tag
                const response = await fetch(`/api/music/station/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.tracks && data.data.tracks.length > 0) {
                    resultsDiv.innerHTML = `
                        <div class="text-xs uppercase tracking-wide mb-2">üîç Results for "${query}" (${data.data.tracks.length} tracks)</div>
                        <div class="mb-3 p-2 rounded flex items-center justify-between" style="background-color: var(--skin-primary); color: var(--skin-text-primary);">
                            <span>Found ${data.data.tracks.length} tracks!</span>
                            <div class="flex gap-2">
                                <button onclick="saveCustomStation('${query}', '${query.charAt(0).toUpperCase() + query.slice(1)}')" class="px-3 py-1 rounded text-xs" style="background-color: var(--skin-bg-primary); color: var(--skin-text-primary);">üíæ Save Station</button>
                                <button onclick="playCustomStation('${query}')" class="px-3 py-1 rounded text-xs" style="background-color: #ff0000; color: white;">‚ñ∂Ô∏è Play Now</button>
                            </div>
                        </div>
                        ${data.data.tracks.slice(0, 5).map(track => `
                            <div class="flex items-center gap-2 p-2 rounded" style="background-color: var(--skin-bg-tertiary);">
                                <div class="w-8 h-8 rounded overflow-hidden flex-shrink-0" style="background-color: var(--skin-bg-primary);">
                                    ${track.image ? `<img src="${track.image}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-sm">üéµ</div>'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm truncate" style="color: var(--skin-text-primary);">${track.name}</div>
                                    <div class="text-xs truncate" style="color: var(--skin-text-muted);">${track.artist}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${data.data.tracks.length > 5 ? `<div class="text-xs text-center mt-2" style="color: var(--skin-text-muted);">...and ${data.data.tracks.length - 5} more tracks</div>` : ''}
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="text-xs uppercase tracking-wide mb-2">üîç Search Results</div>
                        <div class="text-center py-4" style="color: var(--skin-text-muted);">
                            <div class="text-2xl mb-2">üîç</div>
                            <div>No results for "${query}"</div>
                            <div class="text-xs mt-1">Try different keywords like "synthwave", "post-punk", "ambient"...</div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Search error:', e);
                resultsDiv.innerHTML = `
                    <div class="text-xs uppercase tracking-wide mb-2">üîç Search Results</div>
                    <div class="text-center py-4" style="color: var(--skin-accent);">Error searching. Try again.</div>
                `;
            }
        }
        
        async function loadFavorites() {
            const favoritesList = document.getElementById('favorites-list');
            if (!favoritesList) return;
            
            favoritesList.innerHTML = `
                <div class="text-xs uppercase tracking-wide mb-2">‚ù§Ô∏è Your Favorite Tracks</div>
                <div class="italic">Loading favorites...</div>
            `;
            
            try {
                const response = await fetch('/api/music/favorites');
                const data = await response.json();
                
                // API returns 'tracks' not 'favorites'
                const favorites = data.tracks || data.favorites || [];
                
                if (data.success && favorites.length > 0) {
                    favoritesList.innerHTML = `
                        <div class="text-xs uppercase tracking-wide mb-2">‚ù§Ô∏è Your Favorite Tracks (${favorites.length})</div>
                        ${favorites.map(fav => {
                            const artistEsc = fav.artist_name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const nameEsc = fav.track_name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `
                            <div class="flex items-center gap-2 p-2 rounded" style="background-color: var(--skin-bg-tertiary);">
                                <button onclick="playOnYouTube('${artistEsc}', '${nameEsc}')" class="w-8 h-8 rounded flex-shrink-0 flex items-center justify-center hover:scale-110 transition-transform" style="background-color: #ff0000;" title="Play">
                                    ‚ñ∂Ô∏è
                                </button>
                                <div class="w-10 h-10 rounded overflow-hidden flex-shrink-0" style="background-color: var(--skin-bg-primary);">
                                    ${fav.image_url ? `<img src="${fav.image_url}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-sm">üéµ</div>'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm truncate" style="color: var(--skin-text-primary);">${fav.track_name}</div>
                                    <div class="text-xs truncate" style="color: var(--skin-text-muted);">${fav.artist_name}</div>
                                </div>
                                <button onclick="removeFavorite('${artistEsc}', '${nameEsc}')" class="px-2 py-1 rounded text-xs hover:opacity-80" style="color: var(--skin-accent);" title="Remove">
                                    ‚ùå
                                </button>
                            </div>
                        `}).join('')}
                    `;
                } else {
                    favoritesList.innerHTML = `
                        <div class="text-xs uppercase tracking-wide mb-2">‚ù§Ô∏è Your Favorite Tracks</div>
                        <div class="text-center py-8" style="color: var(--skin-text-muted);">
                            <div class="text-4xl mb-2">üíî</div>
                            <div>No favorites yet</div>
                            <div class="text-xs mt-1">Click the ü§ç button on any track to save it</div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error loading favorites:', e);
                favoritesList.innerHTML = `
                    <div class="text-xs uppercase tracking-wide mb-2">‚ù§Ô∏è Your Favorite Tracks</div>
                    <div class="text-center py-4" style="color: var(--skin-accent);">Error loading favorites</div>
                `;
            }
        }
        
        async function removeFavorite(artist, name) {
            try {
                await fetch(`/api/music/favorites?track_name=${encodeURIComponent(name)}&artist_name=${encodeURIComponent(artist)}`, { method: 'DELETE' });
                favoritesCache[`${artist}-${name}`] = false;
                loadFavorites(); // Reload the list
            } catch (e) {
                console.error('Error removing favorite:', e);
            }
        }
        
        async function toggleFavoriteTrack(artist, name, image, url, btn) {
            const key = `${artist}-${name}`;
            const isFavorite = favoritesCache[key];
            const station = document.getElementById('lastfm-station')?.value || '90s_alternative';
            
            try {
                if (isFavorite) {
                    await fetch(`/api/music/favorites?track_name=${encodeURIComponent(name)}&artist_name=${encodeURIComponent(artist)}`, { method: 'DELETE' });
                    favoritesCache[key] = false;
                    if (btn) btn.innerHTML = 'ü§ç';
                } else {
                    await fetch('/api/music/favorites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            track_name: name,
                            artist_name: artist,
                            image_url: image,
                            lastfm_url: url,
                            station: station
                        })
                    });
                    favoritesCache[key] = true;
                    if (btn) btn.innerHTML = '‚ù§Ô∏è';
                }
            } catch (e) {
                console.error('Error toggling favorite:', e);
            }
        }
        
        function selectTrack(track) {
            // Find index in playlist
            const idx = currentPlaylist.findIndex(t => t.name === track.name && t.artist === track.artist);
            if (idx >= 0) {
                selectTrackByIndex(idx);
            } else {
                // Not in current playlist, just play it
                currentlyPlayingTrack = track;
                displayNowPlaying(track);
                playTrackInPlayer(track.artist, track.name);
            }
        }
        
        function playOnYouTube(artist, name) {
            playTrackInPlayer(artist, name);
        }
        
        // Track current video duration for auto-advance
        let currentVideoDuration = 0;
        let autoAdvanceTimer = null;
        
        async function playTrackInPlayer(artist, name) {
            const iframe = document.getElementById('youtube-iframe');
            const playerDiv = document.getElementById('embedded-player');
            const closeBtn = document.getElementById('close-player-btn');
            const trackInfo = document.getElementById('player-track-info');
            
            if (!iframe || !playerDiv) return;
            
            // Clear any existing auto-advance timer
            if (autoAdvanceTimer) {
                clearTimeout(autoAdvanceTimer);
                autoAdvanceTimer = null;
            }
            
            // Show loading state
            playerDiv.classList.remove('hidden');
            closeBtn?.classList.remove('hidden');
            isPlaying = true;
            updatePlayPauseButton();
            
            if (trackInfo) {
                trackInfo.innerHTML = `<strong>üîç Searching:</strong> ${name} - ${artist}...`;
            }
            iframe.src = '';
            
            try {
                // Search YouTube via our API
                const response = await fetch(`/api/music/youtube/search?track_name=${encodeURIComponent(name)}&artist_name=${encodeURIComponent(artist)}`);
                const data = await response.json();
                
                if (data.success && data.video_id) {
                    // Play the video with enablejsapi for potential future API use
                    iframe.src = `https://www.youtube.com/embed/${data.video_id}?autoplay=1&enablejsapi=1`;
                    
                    // Parse duration and set auto-advance timer
                    if (data.duration && document.getElementById('auto-advance')?.checked) {
                        const durationMs = parseDuration(data.duration);
                        if (durationMs > 0) {
                            currentVideoDuration = durationMs;
                            // Add 3 seconds buffer for video loading
                            autoAdvanceTimer = setTimeout(() => {
                                autoAdvanceToNext();
                            }, durationMs + 3000);
                        }
                    }
                    
                    if (trackInfo) {
                        const autoStatus = document.getElementById('auto-advance')?.checked ? '‚è≠Ô∏è Auto-advance ON' : '';
                        trackInfo.innerHTML = `<strong>üéµ Now Playing:</strong> ${data.title} <span style="color: var(--skin-text-muted);">‚Ä¢ ${data.channel} ‚Ä¢ ${data.duration || ''}</span> <span class="text-xs" style="color: var(--skin-primary);">${autoStatus}</span>`;
                    }
                } else {
                    if (trackInfo) {
                        trackInfo.innerHTML = `<strong style="color: var(--skin-accent);">‚ö†Ô∏è Not found:</strong> ${name} - ${artist}. <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(artist + ' ' + name)}" target="_blank" style="text-decoration: underline;">Search manually</a>`;
                    }
                    // If not found and auto-advance is on, skip to next track after 3 seconds
                    if (document.getElementById('auto-advance')?.checked) {
                        autoAdvanceTimer = setTimeout(() => {
                            autoAdvanceToNext();
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('YouTube search error:', error);
                if (trackInfo) {
                    trackInfo.innerHTML = `<strong style="color: var(--skin-accent);">‚ö†Ô∏è Error:</strong> Could not search YouTube`;
                }
            }
        }
        
        // Parse duration string like "3:45" or "1:02:30" to milliseconds
        function parseDuration(durationStr) {
            if (!durationStr) return 0;
            const parts = durationStr.split(':').map(Number);
            if (parts.length === 2) {
                return (parts[0] * 60 + parts[1]) * 1000;
            } else if (parts.length === 3) {
                return (parts[0] * 3600 + parts[1] * 60 + parts[2]) * 1000;
            }
            return 0;
        }
        
        function autoAdvanceToNext() {
            if (!document.getElementById('auto-advance')?.checked) return;
            
            if (currentTrackIndex < currentPlaylist.length - 1) {
                playNextTrack();
            } else {
                // End of playlist - optionally loop or stop
                console.log('End of playlist reached');
                isPlaying = false;
                updatePlayPauseButton();
            }
        }
        
        function updatePlayPauseButton() {
            const btn = document.getElementById('play-pause-btn');
            if (btn) {
                btn.innerHTML = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                btn.title = isPlaying ? 'Pause' : 'Play';
            }
        }
        
        function closeEmbeddedPlayer() {
            const iframe = document.getElementById('youtube-iframe');
            const playerDiv = document.getElementById('embedded-player');
            const closeBtn = document.getElementById('close-player-btn');
            
            // Clear auto-advance timer
            if (autoAdvanceTimer) {
                clearTimeout(autoAdvanceTimer);
                autoAdvanceTimer = null;
            }
            
            if (iframe) iframe.src = '';
            playerDiv?.classList.add('hidden');
            closeBtn?.classList.add('hidden');
            isPlaying = false;
            updatePlayPauseButton();
        }

        function displayMusicError(error) {
            const nowPlaying = document.getElementById('now-playing');
            if (nowPlaying) {
                nowPlaying.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 rounded flex items-center justify-center text-2xl" style="background-color: var(--skin-bg-tertiary);">‚ö†Ô∏è</div>
                        <div>
                            <div class="font-semibold" style="color: var(--skin-accent);">Music Unavailable</div>
                            <div class="text-xs" style="color: var(--skin-text-muted);">${error}</div>
                            <div class="text-xs mt-1" style="color: var(--skin-text-muted);">Set LASTFM_API_KEY in .env to enable</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function toggleMusicPlayer() {
            loadMusicStation();
        }
        
        // Auto-load when station selection changes and initialize settings
        document.addEventListener('DOMContentLoaded', () => {
            const stationSelect = document.getElementById('lastfm-station');
            if (stationSelect) {
                stationSelect.addEventListener('change', () => {
                    currentTrackIndex = 0; // Reset position for new station
                    loadMusicStation();
                });
            }
            
            // Load player settings
            loadPlayerSettings();
            
            // Add custom stations to the dropdown
            const customStations = getCustomStations();
            if (stationSelect && customStations.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ Custom Stations ‚îÄ‚îÄ';
                stationSelect.appendChild(separator);
                
                customStations.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.tag;
                    opt.textContent = `‚≠ê ${s.name}`;
                    stationSelect.appendChild(opt);
                });
            }
        });
        
        // Art/Music communities loaders (placeholders)
        function loadArtCommunities() {
            console.log('Art communities loaded');
        }
        
        function loadMusicCommunities() {
            console.log('Music communities loaded');
        }
        
        function updateBackgroundOptions(backgrounds) {
            const bgSelect = document.getElementById('bg-select');
            if (!bgSelect) return;
            
            // Remember current selection
            const currentKey = localStorage.getItem('dashboard_bg_key') || 'bg1';
            
            // Clear existing options
            bgSelect.innerHTML = '';
            
            // Clear and rebuild BACKGROUNDS array from skin config
            BACKGROUNDS.length = 0;
            
            // Add new options from skin
            backgrounds.forEach((bg, index) => {
                const key = `bg${index + 1}`;
                const option = document.createElement('option');
                option.value = key;
                option.textContent = bg.name || `Background ${index + 1}`;
                bgSelect.appendChild(option);
                
                // Add to BACKGROUNDS array
                BACKGROUNDS.push({
                    key: key,
                    type: 'image',
                    value: `/static/backgrounds/${bg.file}`
                });
            });
            
            // Add custom URL option
            const customOption = document.createElement('option');
            customOption.value = 'custom-url';
            customOption.textContent = 'Custom URL';
            bgSelect.appendChild(customOption);
            
            console.log('üñºÔ∏è Updated backgrounds:', BACKGROUNDS);
            
            // Re-bind change handler (in case it was lost)
            bgSelect.onchange = function() {
                const v = bgSelect.value;
                console.log('üñºÔ∏è Background selected:', v);
                if (v === 'custom-url') {
                    const saved = localStorage.getItem('dashboard_bg_custom');
                    if (saved) setBackgroundUrl(saved);
                } else {
                    setBackgroundByKey(v);
                }
            };
            
            // Restore previous selection if valid, otherwise use first
            if (currentKey === 'custom-url') {
                const customUrl = localStorage.getItem('dashboard_bg_custom');
                if (customUrl) {
                    bgSelect.value = 'custom-url';
                    setBackgroundUrl(customUrl);
                } else if (BACKGROUNDS.length > 0) {
                    setBackgroundByKey('bg1');
                }
            } else if (BACKGROUNDS.some(b => b.key === currentKey)) {
                bgSelect.value = currentKey;
                setBackgroundByKey(currentKey);
            } else if (BACKGROUNDS.length > 0) {
                setBackgroundByKey('bg1');
            }
        }
        
        function getSkinQuote(category = 'random_quotes') {
            if (!currentSkin || !currentSkin.quotes) return null;
            const quotes = currentSkin.quotes[category] || currentSkin.quotes.random_quotes || [];
            if (quotes.length === 0) return null;
            return quotes[Math.floor(Math.random() * quotes.length)];
        }
        
        // Get skin-specific greeting
        function getSkinGreeting() {
            return getSkinQuote('greetings') || currentSkin?.signature_phrase || 'Hello!';
        }

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-gray-700', 'text-white');
                link.classList.add('text-gray-300');
            });

            const section = document.getElementById(`section-${sectionName}`);
            if (section) {
                section.classList.remove('hidden');
                // Load section-specific data
                if (sectionName === 'calendar') {
                    loadFamilyCalendar();
                } else if (sectionName === 'weather') {
                    // Load local weather station first
                    loadAmbientWeather();
                    // Then load general weather
                    try {
                        const saved = JSON.parse(localStorage.getItem('weather_selected') || 'null');
                        if (saved && saved.lat && saved.lon) {
                            loadWeather(saved.lat, saved.lon, saved.name || null);
                            // mirror to weather section elements
                            mirrorWeatherToSection();
                        } else {
                            useCurrentLocation();
                            mirrorWeatherToSection();
                        }
                    } catch {
                        loadWeather();
                        mirrorWeatherToSection();
                    }
                } else if (sectionName === 'news') {
                    loadNews();
                    loadCalmTips();
                } else if (sectionName === 'settings') {
                    loadSettings();
                } else if (sectionName === 'overview') {
                    // Ensure overview content is fresh when switching back
                    reloadComic();
                    loadJokes();
                    loadQuote();
                    loadEbayAuctions();
                }
                if (typeof event !== 'undefined' && event && event.target) {
                    const navLink = event.target.closest('.nav-link');
                    if (navLink) {
                        navLink.classList.add('bg-gray-700', 'text-white');
                        navLink.classList.remove('text-gray-300');
                    }
                }
            }
        }

        function mirrorWeatherToSection() {
            // Copy overview weather content to standalone section
            const srcDisplay = document.getElementById('weather-display');
            const srcForecast = document.getElementById('weather-forecast');
            const srcAlerts = document.getElementById('weather-alerts');
            const dstDisplay = document.getElementById('weather-display-2');
            const dstForecast = document.getElementById('weather-forecast-2');
            const dstAlerts = document.getElementById('weather-alerts-2');
            if (srcDisplay && dstDisplay) dstDisplay.innerHTML = srcDisplay.innerHTML;
            if (srcForecast && dstForecast) dstForecast.innerHTML = srcForecast.innerHTML;
            if (srcAlerts && dstAlerts) dstAlerts.innerHTML = srcAlerts.innerHTML;
        }

        // Roger voice controls
        async function toggleWakeWord() {
            try {
                const current = await (await fetch('/api/voice/settings')).json();
                const v = current.voice || {};
                const newVal = !v.wake_word_enabled;
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wake_word_enabled: newVal })
                });
                const name = currentSkin?.identity?.display_name || 'Assistant';
                const wakeWords = currentSkin?.identity?.wake_words?.join('" or "') || 'the wake word';
                const btn = document.getElementById('wake-word-btn');
                
                if (newVal) {
                    // Update button to show listening state
                    if (btn) {
                        btn.innerHTML = 'üé§ Listening...';
                        btn.classList.add('animate-pulse');
                    }
                    // Show visual notification with the wake words
                    showToast(`${name} is now listening! Say "${wakeWords}" to activate.`, 'success');
                    // Also speak acknowledgment
                    speakText(`I'm listening. Say ${wakeWords.split('" or "')[0]} followed by your command.`);
                } else {
                    // Update button to show disabled state
                    if (btn) {
                        btn.innerHTML = 'üé§ Listen';
                        btn.classList.remove('animate-pulse');
                    }
                    showToast(`${name} wake word listening disabled.`, 'info');
                }
            } catch (e) {
                console.error('Wake word toggle failed', e);
            }
        }

        // Toast notification helper
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-purple-600',
                warning: 'bg-yellow-600'
            };
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg z-50 max-w-sm animate-fade-in`;
            toast.innerHTML = `<div class="flex items-center gap-2"><span>${message}</span></div>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Global audio stop - stops all voice/audio playback
        let currentAudioElement = null;
        function stopAllAudio() {
            // Stop any playing audio elements
            document.querySelectorAll('audio').forEach(a => {
                a.pause();
                a.currentTime = 0;
            });
            // Stop current audio element if tracked
            if (currentAudioElement) {
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
                currentAudioElement = null;
            }
            // Call API to stop any server-side audio generation
            fetch('/api/voice/stop', { method: 'POST' }).catch(() => {});
            // Visual feedback
            const muteBtn = document.getElementById('mute-btn');
            if (muteBtn) {
                muteBtn.textContent = '‚úì Muted';
                setTimeout(() => { muteBtn.textContent = 'üîá Mute'; }, 1500);
            }
            console.log('All audio stopped');
        }

        // Speak text using AI voice - plays in browser (not server)
        async function speakText(text, style = null) {
            if (!text) return;
            style = style || currentSkin?.voice?.style || 'droid';
            try {
                const response = await fetch('/api/voice/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, style })
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const audio = new Audio(URL.createObjectURL(blob));
                    currentAudioElement = audio;
                    audio.play();
                } else {
                    console.error('Voice generation failed');
                }
            } catch (e) {
                console.error('Speak error:', e);
            }
        }

        async function promptSpeak() {
            const assistantName = currentSkin?.identity?.display_name || 'Assistant';
            const text = prompt(`Ask ${assistantName}:`);
            if (!text) return;
            await speakText(text);
        }

        // Voice Settings
        function openVoiceSettings() {
            document.getElementById('voice-settings-modal').classList.remove('hidden');
            // Update modal title based on current skin
            const title = document.getElementById('voice-settings-title');
            if (title && currentSkin) {
                const icon = currentSkin.name === 'dracula' ? 'üòà' : 'ü§ñ';
                const name = currentSkin.identity?.display_name || 'Assistant';
                title.innerHTML = `${icon} ${name} Voice Settings`;
            }
            loadVoiceSettings();
        }

        function closeVoiceSettings() {
            document.getElementById('voice-settings-modal').classList.add('hidden');
        }

        // =====================================================
        // AVATAR PICKER SYSTEM
        // =====================================================
        const AVAILABLE_AVATARS = [
            { file: 'alice.gif', name: 'Alice (Animated)' },
            { file: 'alice.svg', name: 'Alice' },
            { file: 'demon-slayer.gif', name: 'Demon Slayer' },
            { file: 'demon.jpg', name: 'Demon' },
            { file: 'demon1.gif', name: 'Demon (Fire)' },
            { file: 'demon2.gif', name: 'Demon (Dark)' },
            { file: 'dracula.svg', name: 'Dracula' },
            { file: 'obi-wan.gif', name: 'Obi-Wan (Animated)' },
            { file: 'obi-wan2.webp', name: 'Obi-Wan (Alt)' },
            { file: 'obi-wan3.gif', name: 'Obi-Wan (Classic)' },
            { file: 'obiwan.svg', name: 'Obi-Wan' },
            { file: 'rogr.gif', name: 'Roger (Battle Droid)' }
        ];

        function openAvatarPicker() {
            const modal = document.getElementById('avatar-picker-modal');
            const grid = document.getElementById('avatar-picker-grid');
            
            // Build avatar grid
            grid.innerHTML = AVAILABLE_AVATARS.map(avatar => `
                <div class="cursor-pointer group" onclick="selectAvatar('${avatar.file}')">
                    <div class="relative rounded-lg overflow-hidden border-2 border-gray-700 hover:border-purple-500 transition-all">
                        <img src="/assets/images/${avatar.file}" alt="${avatar.name}" 
                             class="w-full aspect-square object-cover group-hover:scale-110 transition-transform">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end">
                            <span class="p-2 text-xs text-white font-medium">${avatar.name}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function closeAvatarPicker() {
            document.getElementById('avatar-picker-modal').classList.add('hidden');
        }

        async function selectAvatar(filename) {
            const avatarPath = `/assets/images/${filename}`;
            
            // Update UI immediately
            const avatar = document.getElementById('assistant-avatar');
            if (avatar) {
                avatar.src = avatarPath;
            }
            
            // Save to server (per-user preference)
            try {
                const skinName = localStorage.getItem('dashboard_skin') || 'roger';
                await fetch('/api/settings/avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        skin: skinName,
                        avatar: avatarPath 
                    })
                });
                console.log(`‚úÖ Avatar changed to ${filename}`);
            } catch (e) {
                console.error('Failed to save avatar:', e);
            }
            
            // Also save to localStorage as backup
            localStorage.setItem('dashboard_avatar_override', avatarPath);
            
            closeAvatarPicker();
        }

        // =====================================================
        // HOME ASSISTANT INTEGRATION
        // =====================================================
        function refreshHomeAssistant() {
            const iframe = document.getElementById('ha-iframe');
            if (iframe) {
                iframe.src = iframe.src;
            }
        }

        function haQuickAction(action) {
            const iframe = document.getElementById('ha-iframe');
            if (!iframe) return;
            
            const routes = {
                'lights': '/lovelace/lights',
                'climate': '/lovelace/climate', 
                'media': '/lovelace/media',
                'security': '/lovelace/security'
            };
            
            // Try to navigate within the iframe
            const route = routes[action] || '/lovelace/0';
            iframe.src = `http://homeassistant.home:8123${route}`;
        }

        async function loadVoiceSettings() {
            const content = document.getElementById('voice-settings-content');
            try {
                const resp = await fetch('/api/voice/settings');
                const data = await resp.json();
                if (data && data.voice) {
                    const s = data.voice;
                    const availableStyles = data.available_styles || [];
                    const currentSkinInfo = data.current_skin || {};
                    
                    // Build style options dynamically from API
                    let styleOptions = '';
                    if (availableStyles.length > 0) {
                        styleOptions = availableStyles.map(style => {
                            const icons = {
                                'clean': 'üîä',
                                'droid': 'ü§ñ',
                                'radio': 'üìª',
                                'pa_system': 'üì¢',
                                'demon': 'üòà',
                                'gothic': 'ü¶á'
                            };
                            const icon = icons[style.id] || 'üé§';
                            const isSelected = s.default_style === style.id ? 'selected' : '';
                            const isSkinDefault = currentSkinInfo.default_style === style.id ? ' (Skin Default)' : '';
                            return `<option value="${style.id}" ${isSelected}>${icon} ${style.name}${isSkinDefault}</option>`;
                        }).join('');
                    } else {
                        // Fallback if API doesn't return styles
                        styleOptions = `
                            <option value="droid" ${s.default_style === 'droid' ? 'selected' : ''}>ü§ñ Droid (Battle Droid)</option>
                            <option value="demon" ${s.default_style === 'demon' ? 'selected' : ''}>üòà Demon (Dark & Ethereal)</option>
                            <option value="gothic" ${s.default_style === 'gothic' ? 'selected' : ''}>ü¶á Gothic (Theatrical)</option>
                            <option value="radio" ${s.default_style === 'radio' ? 'selected' : ''}>üìª Radio</option>
                            <option value="pa_system" ${s.default_style === 'pa_system' ? 'selected' : ''}>üì¢ PA System</option>
                            <option value="clean" ${s.default_style === 'clean' ? 'selected' : ''}>üîä Clean (No Effects)</option>
                        `;
                    }
                    
                    // Show current skin info
                    const skinInfo = currentSkinInfo.display_name ? 
                        `<div class="mb-4 p-3 bg-gray-700/50 rounded-lg border border-gray-600">
                            <p class="text-sm text-gray-300">Current Assistant: <span class="text-purple-300 font-semibold">${currentSkinInfo.display_name}</span></p>
                            <p class="text-xs text-gray-400 mt-1">Signature: "${currentSkinInfo.signature_phrase}"</p>
                        </div>` : '';
                    
                    // Skin-aware labels
                    const isDemon = currentSkinInfo.name === 'dracula';
                    const sampleLabel = isDemon ? 'üé¨ Authentic Demon Samples' : 'üé¨ Authentic Voice Samples';
                    const sampleDesc = isDemon ? 'Use pre-recorded demonic audio for signature phrases' : 'Use pre-recorded audio for signature phrases';
                    const sarcasmLabel = isDemon ? 'üíÄ Random Dark Humor' : 'ü§ñ Random Sarcasm';
                    const sarcasmDesc = isDemon ? 'Add occasional demonic quips' : 'Add occasional sarcastic comments';
                    
                    content.innerHTML = `
                        <div class="space-y-4">
                            ${skinInfo}
                            <div>
                                <label class="block text-sm font-semibold mb-2">Voice Style</label>
                                <select id="voice-style" onchange="updateVoiceSetting('style')" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                                    ${styleOptions}
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Each style applies different audio effects to the voice</p>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">${sampleLabel}</label>
                                    <p class="text-xs text-gray-400">${sampleDesc}</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="use-authentic" ${s.use_authentic_samples !== false ? 'checked' : ''} onchange="updateVoiceSetting('authentic')" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">${sarcasmLabel}</label>
                                    <p class="text-xs text-gray-400">${sarcasmDesc}</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="use-sarcasm" ${s.sarcasm_enabled ? 'checked' : ''} onchange="updateVoiceSetting('sarcasm')" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Speed: <span id="speed-value">${(s.speed || 0.75).toFixed(2)}</span>x</label>
                                <input type="range" id="voice-speed" min="0.5" max="1.5" step="0.05" value="${s.speed || 0.75}" oninput="document.getElementById('speed-value').textContent = this.value" onchange="updateVoiceSetting('speed')" class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Pitch: <span id="pitch-value">${(s.pitch || 0.85).toFixed(2)}</span>x</label>
                                <input type="range" id="voice-pitch" min="0.5" max="1.5" step="0.05" value="${s.pitch || 0.85}" oninput="document.getElementById('pitch-value').textContent = this.value" onchange="updateVoiceSetting('pitch')" class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Sarcasm Chance: <span id="sarcasm-chance-value">${Math.round((s.sarcasm_chance || 0.4) * 100)}</span>%</label>
                                <input type="range" id="voice-sarcasm-chance" min="0" max="100" step="5" value="${Math.round((s.sarcasm_chance || 0.4) * 100)}" oninput="document.getElementById('sarcasm-chance-value').textContent = this.value" onchange="updateVoiceSetting('sarcasm_chance')" class="w-full">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveVoiceSettings()" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold">Save Settings</button>
                                <button onclick="testVoice()" id="test-voice-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-semibold">üîä Test</button>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error loading voice settings:', e);
                content.innerHTML = '<div class="text-red-400">Error loading settings</div>';
            }
        }

        async function updateVoiceSetting(field) {
            const speed = parseFloat(document.getElementById('voice-speed')?.value || 0.75);
            const pitch = parseFloat(document.getElementById('voice-pitch')?.value || 0.85);
            const style = document.getElementById('voice-style')?.value || 'droid';
            const useAuthentic = document.getElementById('use-authentic')?.checked !== false;
            const sarcasmEnabled = document.getElementById('use-sarcasm')?.checked || false;
            const sarcasmChance = (parseInt(document.getElementById('voice-sarcasm-chance')?.value || 40)) / 100;

            if (field === 'speed') {
                document.getElementById('speed-value').textContent = speed.toFixed(2);
            }
            if (field === 'pitch') {
                document.getElementById('pitch-value').textContent = pitch.toFixed(2);
            }
            if (field === 'sarcasm_chance') {
                document.getElementById('sarcasm-chance-value').textContent = Math.round(sarcasmChance * 100);
            }

            try {
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        default_style: style,
                        speed: speed,
                        pitch: pitch,
                        use_authentic_samples: useAuthentic,
                        sarcasm_enabled: sarcasmEnabled,
                        sarcasm_chance: sarcasmChance
                    })
                });
            } catch (e) {
                console.error('Error updating voice setting:', e);
            }
        }

        async function saveVoiceSettings() {
            try {
                const style = document.getElementById('voice-style')?.value || 'droid';
                const speed = parseFloat(document.getElementById('voice-speed')?.value || 0.75);
                const pitch = parseFloat(document.getElementById('voice-pitch')?.value || 0.85);
                const useAuthentic = document.getElementById('use-authentic')?.checked !== false;
                const sarcasmEnabled = document.getElementById('use-sarcasm')?.checked || false;
                const sarcasmChance = (parseInt(document.getElementById('voice-sarcasm-chance')?.value || 40)) / 100;
                
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        default_style: style,
                        speed: speed,
                        pitch: pitch,
                        use_authentic_samples: useAuthentic,
                        sarcasm_enabled: sarcasmEnabled,
                        sarcasm_chance: sarcasmChance
                    })
                });
                closeVoiceSettings();
            } catch (e) {
                console.error('Save voice settings error:', e);
                alert('Failed to save settings');
            }
        }

        async function testVoice() {
            const testBtn = document.getElementById('test-voice-btn') || document.getElementById('settings-test-voice-btn');
            if (testBtn) testBtn.disabled = true;
            try {
                // Get the selected style from the dropdown (or use skin default)
                const selectedStyle = document.getElementById('voice-style')?.value || 
                                     document.getElementById('settings-voice-style')?.value;
                
                const style = selectedStyle || currentSkin?.voice?.style || 'droid';
                const message = currentSkin?.identity?.signature_phrase || 'Voice system operational.';
                
                // Use speakText to play in browser
                await speakText(message, style);
            } catch (e) {
                console.error('Voice test error:', e);
                alert('Voice test failed: ' + e.message);
            } finally {
                if (testBtn) testBtn.disabled = false;
            }
        }

        // Read functions for voice
        async function readJokes() {
            const jokesEl = document.getElementById('jokes');
            if (!jokesEl) return;
            const text = jokesEl.innerText || 'No jokes loaded';
            await speakText(text);
        }

        async function readQuote() {
            const quoteEl = document.getElementById('quote');
            if (!quoteEl) return;
            const text = quoteEl.innerText || 'No quote loaded';
            await speakText(text);
        }

        async function readRogerQuote() {
            // This function reads the assistant's quote widget (works for any skin)
            const el = document.getElementById('roger-quotes') || document.getElementById('dracula-quotes');
            if (!el) return;
            const text = el.innerText || 'No quote loaded';
            await speakText(text);
        }

        // OAuth Connect Functions
        function connectGoogle() {
            window.open('/auth/google', 'google_oauth', 'width=500,height=600,popup=yes');
        }

        function connectMicrosoft() {
            window.open('/auth/microsoft', 'microsoft_oauth', 'width=500,height=600,popup=yes');
        }

        function connectProton() {
            // Proton uses Bridge - show configuration modal
            alert('Proton Bridge Setup:\n\n1. Install Proton Mail Bridge on your system\n2. Log in to the Bridge application\n3. Configure IMAP/SMTP credentials in credentials.yaml\n\nSee PROVIDER_SETUP.md for detailed instructions.');
        }
        
        // iCloud Calendar Functions
        async function saveICloudCalendarUrl() {
            const url = document.getElementById('icloud-calendar-url')?.value?.trim();
            const status = document.getElementById('icloud-calendar-status');
            
            if (!url) {
                if (status) status.innerHTML = '<span class="text-red-400">Please enter a calendar URL</span>';
                return;
            }
            
            // Save to localStorage for persistence
            localStorage.setItem('icloud_calendar_url', url);
            
            // Also save to server
            try {
                const resp = await fetch('/api/settings/icloud-calendar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                const data = await resp.json();
                
                if (data.success) {
                    if (status) status.innerHTML = '<span class="text-green-400">‚úì Calendar URL saved!</span>';
                    // Reload calendar
                    loadFamilyCalendar();
                } else {
                    if (status) status.innerHTML = `<span class="text-red-400">Error: ${data.error}</span>`;
                }
            } catch (e) {
                // Even if server save fails, localStorage is saved
                if (status) status.innerHTML = '<span class="text-yellow-400">Saved locally (server save failed)</span>';
            }
        }
        
        async function testICloudCalendar() {
            const url = document.getElementById('icloud-calendar-url')?.value?.trim();
            const status = document.getElementById('icloud-calendar-status');
            
            if (!url) {
                if (status) status.innerHTML = '<span class="text-red-400">Please enter a calendar URL first</span>';
                return;
            }
            
            if (status) status.innerHTML = '<span class="text-blue-400">Testing connection...</span>';
            
            try {
                const resp = await fetch('/api/calendar/family/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                const data = await resp.json();
                
                if (data.success) {
                    if (status) status.innerHTML = `<span class="text-green-400">‚úì Connected! Found ${data.event_count || 0} upcoming events</span>`;
                } else {
                    if (status) status.innerHTML = `<span class="text-red-400">Connection failed: ${data.error}</span>`;
                }
            } catch (e) {
                if (status) status.innerHTML = `<span class="text-red-400">Error testing: ${e.message}</span>`;
            }
        }

        // Settings Page Loader
        async function loadSettings() {
            const container = document.getElementById('settings-container');
            if (!container) return;
            
            try {
                // Fetch voice settings and auth status
                const voiceResp = await fetch('/api/voice/settings');
                const voiceData = await voiceResp.json();
                const v = voiceData.voice || {};
                
                // Check auth status for each provider
                let googleStatus = { authenticated: false };
                let microsoftStatus = { authenticated: false };
                let protonStatus = { authenticated: false };
                
                try {
                    const gResp = await fetch('/api/auth/google/status');
                    googleStatus = await gResp.json();
                } catch (e) { console.log('Google auth check skipped'); }
                
                try {
                    const mResp = await fetch('/api/auth/microsoft/status');
                    microsoftStatus = await mResp.json();
                } catch (e) { console.log('Microsoft auth check skipped'); }
                
                try {
                    const pResp = await fetch('/api/auth/proton/status');
                    protonStatus = await pResp.json();
                } catch (e) { console.log('Proton auth check skipped'); }
                
                // Get saved preferences from localStorage
                const bgKey = localStorage.getItem('dashboard_bg_key') || 'bg1';
                const weatherLoc = JSON.parse(localStorage.getItem('weather_selected') || '{}');
                
                container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Settings</h2>
                    
                    <!-- Connected Accounts -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-link mr-2"></i>Connected Accounts</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <img src="https://www.google.com/favicon.ico" class="w-5 h-5" alt="Google">
                                        <span class="font-semibold">Google</span>
                                    </div>
                                    <span class="text-xs ${googleStatus.authenticated ? 'text-green-400' : 'text-gray-500'}">${googleStatus.authenticated ? '‚úì Connected' : 'Not connected'}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">Gmail, Calendar, Drive</p>
                                <button onclick="connectGoogle()" class="w-full px-3 py-2 ${googleStatus.authenticated ? 'bg-green-700 hover:bg-green-600' : 'bg-blue-600 hover:bg-blue-700'} rounded text-sm">
                                    ${googleStatus.authenticated ? '‚úì Reconnect' : 'Connect Google'}
                                </button>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <img src="https://www.microsoft.com/favicon.ico" class="w-5 h-5" alt="Microsoft">
                                        <span class="font-semibold">Microsoft 365</span>
                                    </div>
                                    <span class="text-xs ${microsoftStatus.authenticated ? 'text-green-400' : 'text-gray-500'}">${microsoftStatus.authenticated ? '‚úì Connected' : 'Not connected'}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">Outlook, OneDrive, Teams</p>
                                <button onclick="connectMicrosoft()" class="w-full px-3 py-2 ${microsoftStatus.authenticated ? 'bg-green-700 hover:bg-green-600' : 'bg-blue-600 hover:bg-blue-700'} rounded text-sm">
                                    ${microsoftStatus.authenticated ? '‚úì Reconnect' : 'Connect Microsoft'}
                                </button>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">üîí</span>
                                        <span class="font-semibold">Proton</span>
                                    </div>
                                    <span class="text-xs ${protonStatus.authenticated ? 'text-green-400' : 'text-gray-500'}">${protonStatus.authenticated ? '‚úì Connected' : 'Not connected'}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">ProtonMail via Bridge</p>
                                <button onclick="connectProton()" class="w-full px-3 py-2 ${protonStatus.authenticated ? 'bg-green-700 hover:bg-green-600' : 'bg-purple-600 hover:bg-purple-700'} rounded text-sm">
                                    ${protonStatus.authenticated ? '‚úì Reconnect' : 'Connect Proton'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- iCloud Calendar -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-calendar-alt mr-2"></i>iCloud Family Calendar</h3>
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <p class="text-sm text-gray-400 mb-3">Connect your iCloud Family Calendar to see shared events.</p>
                            <div class="text-xs text-gray-500 mb-3">
                                <strong>How to get your calendar URL:</strong>
                                <ol class="list-decimal ml-4 mt-1 space-y-1">
                                    <li>Go to <a href="https://www.icloud.com/calendar" target="_blank" class="text-blue-400 underline">iCloud.com/calendar</a></li>
                                    <li>Click the Share icon next to your calendar</li>
                                    <li>Enable "Public Calendar"</li>
                                    <li>Copy the webcal:// URL and paste below</li>
                                </ol>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="icloud-calendar-url" placeholder="webcal://p123-caldav.icloud.com/..." 
                                    class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded text-sm text-gray-200"
                                    value="${localStorage.getItem('icloud_calendar_url') || ''}">
                                <button onclick="saveICloudCalendarUrl()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">Save</button>
                                <button onclick="testICloudCalendar()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm">Test</button>
                            </div>
                            <div id="icloud-calendar-status" class="text-xs mt-2 text-gray-500"></div>
                        </div>
                    </div>
                    
                    <!-- Appearance -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-palette mr-2"></i>Appearance</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Background Theme</label>
                                <div class="text-sm text-gray-400 mb-2">Current: ${bgKey}</div>
                                <div class="flex gap-2">
                                    <button onclick="setBackgroundByKey('bg1')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Theme 1</button>
                                    <button onclick="setBackgroundByKey('bg2')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Theme 2</button>
                                    <button onclick="setBackgroundByKey('bg3')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">Theme 3</button>
                                </div>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Default Weather Location</label>
                                <div class="text-sm text-gray-400">${weatherLoc.name || 'Not set - using current location'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Module Settings -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-th-large mr-2"></i>Dashboard Modules</h3>
                        <p class="text-sm text-gray-400 mb-4">Enable or disable modules for your dashboard. Modules marked with ü§ñ are Roger-themed, üòà are Demon-themed.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${Object.values(MODULE_REGISTRY).map(mod => {
                                const enabled = isModuleEnabled(mod.id);
                                const themeIcon = mod.themes.includes('roger') && mod.themes.includes('dracula') ? 'üåç' :
                                                  mod.themes.includes('roger') ? 'ü§ñ' : 'üòà';
                                return `
                                    <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-lg">${mod.icon}</span>
                                                <span class="font-semibold text-sm">${mod.name}</span>
                                                <span class="text-xs" title="${mod.themes.join(', ')}">${themeIcon}</span>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleModule('${mod.id}')" class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                            </label>
                                        </div>
                                        <p class="text-xs text-gray-500">${mod.description}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="resetModulesToThemeDefaults()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">Reset to Theme Defaults</button>
                            <button onclick="enableAllModules()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">Enable All</button>
                            <button onclick="disableAllModules()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm">Disable All</button>
                        </div>
                    </div>
                    
                    <!-- Module Preferences -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-sliders-h mr-2"></i>Module Preferences</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            
                            <!-- Comics Preferences -->
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-lg">üì∞</span>
                                    <span class="font-semibold">Comics</span>
                                </div>
                                <label class="block text-sm mb-2">Default Comic Strip</label>
                                <select id="pref-default-comic" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" onchange="saveModulePref('default_comic', this.value)">
                                    <option value="garfield" ${localStorage.getItem('default_comic') === 'garfield' || !localStorage.getItem('default_comic') ? 'selected' : ''}>üê± Garfield</option>
                                    <option value="calvin" ${localStorage.getItem('default_comic') === 'calvin' ? 'selected' : ''}>üìö Calvin & Hobbes</option>
                                    <option value="peanuts" ${localStorage.getItem('default_comic') === 'peanuts' ? 'selected' : ''}>üêï Peanuts</option>
                                </select>
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-sm">Auto-rotate daily</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pref-comic-rotate" ${localStorage.getItem('comic_auto_rotate') === 'true' ? 'checked' : ''} onchange="saveModulePref('comic_auto_rotate', this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Music Preferences -->
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-lg">üéµ</span>
                                    <span class="font-semibold">Music Player</span>
                                </div>
                                <label class="block text-sm mb-2">Last.fm Username</label>
                                <input type="text" id="pref-lastfm-user" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm mb-2" 
                                    value="${localStorage.getItem('lastfm_username') || ''}" 
                                    placeholder="Your Last.fm username"
                                    onchange="saveModulePref('lastfm_username', this.value)">
                                <label class="block text-sm mb-2">Default Genre</label>
                                <select id="pref-music-genre" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" onchange="saveModulePref('default_genre', this.value)">
                                    <option value="alternative" ${localStorage.getItem('default_genre') === 'alternative' || !localStorage.getItem('default_genre') ? 'selected' : ''}>üé∏ Alternative</option>
                                    <option value="rock" ${localStorage.getItem('default_genre') === 'rock' ? 'selected' : ''}>ü§ò Rock</option>
                                    <option value="electronic" ${localStorage.getItem('default_genre') === 'electronic' ? 'selected' : ''}>üéπ Electronic</option>
                                    <option value="metal" ${localStorage.getItem('default_genre') === 'metal' ? 'selected' : ''}>üé∏ Metal</option>
                                    <option value="goth" ${localStorage.getItem('default_genre') === 'goth' ? 'selected' : ''}>ü¶á Goth/Darkwave</option>
                                    <option value="90s" ${localStorage.getItem('default_genre') === '90s' ? 'selected' : ''}>üìº 90s Hits</option>
                                </select>
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-sm">Autoplay on load</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pref-music-autoplay" ${localStorage.getItem('music_autoplay') === 'true' ? 'checked' : ''} onchange="saveModulePref('music_autoplay', this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Weather Preferences -->
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-lg">üå°Ô∏è</span>
                                    <span class="font-semibold">Weather</span>
                                </div>
                                <label class="block text-sm mb-2">Temperature Units</label>
                                <select id="pref-weather-units" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" onchange="saveModulePref('weather_units', this.value)">
                                    <option value="imperial" ${localStorage.getItem('weather_units') === 'imperial' || !localStorage.getItem('weather_units') ? 'selected' : ''}>üá∫üá∏ Fahrenheit</option>
                                    <option value="metric" ${localStorage.getItem('weather_units') === 'metric' ? 'selected' : ''}>üåç Celsius</option>
                                </select>
                                <label class="block text-sm mt-3 mb-2">Default Location</label>
                                <input type="text" id="pref-weather-location" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" 
                                    value="${localStorage.getItem('weather_location') || ''}" 
                                    placeholder="City, State or ZIP code"
                                    onchange="saveModulePref('weather_location', this.value)">
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-sm">Show humidity</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pref-weather-humidity" ${localStorage.getItem('weather_show_humidity') !== 'false' ? 'checked' : ''} onchange="saveModulePref('weather_show_humidity', this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- News Preferences -->
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-lg">üì∞</span>
                                    <span class="font-semibold">News Feed</span>
                                </div>
                                <label class="block text-sm mb-2">Default Category</label>
                                <select id="pref-news-category" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" onchange="saveModulePref('news_category', this.value)">
                                    <option value="all" ${localStorage.getItem('news_category') === 'all' || !localStorage.getItem('news_category') ? 'selected' : ''}>üì∞ All News</option>
                                    <option value="tech" ${localStorage.getItem('news_category') === 'tech' ? 'selected' : ''}>üíª Technology</option>
                                    <option value="gaming" ${localStorage.getItem('news_category') === 'gaming' ? 'selected' : ''}>üéÆ Gaming</option>
                                    <option value="science" ${localStorage.getItem('news_category') === 'science' ? 'selected' : ''}>üî¨ Science</option>
                                    <option value="music" ${localStorage.getItem('news_category') === 'music' ? 'selected' : ''}>üéµ Music</option>
                                </select>
                                <label class="block text-sm mt-3 mb-2">Articles per page</label>
                                <select id="pref-news-count" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" onchange="saveModulePref('news_count', this.value)">
                                    <option value="5" ${localStorage.getItem('news_count') === '5' ? 'selected' : ''}>5 articles</option>
                                    <option value="10" ${localStorage.getItem('news_count') === '10' || !localStorage.getItem('news_count') ? 'selected' : ''}>10 articles</option>
                                    <option value="20" ${localStorage.getItem('news_count') === '20' ? 'selected' : ''}>20 articles</option>
                                </select>
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-sm">Show calm tips</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pref-news-calm" ${localStorage.getItem('news_show_calm') !== 'false' ? 'checked' : ''} onchange="saveModulePref('news_show_calm', this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- eBay Preferences -->
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-lg">üõí</span>
                                    <span class="font-semibold">eBay Auctions</span>
                                </div>
                                <label class="block text-sm mb-2">Search Keywords</label>
                                <input type="text" id="pref-ebay-keywords" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm mb-2" 
                                    value="${localStorage.getItem('ebay_keywords') || 'vintage electronics, retro computers'}" 
                                    placeholder="vintage electronics, retro computers"
                                    onchange="saveModulePref('ebay_keywords', this.value)">
                                <label class="block text-sm mb-2">Max Price ($)</label>
                                <input type="number" id="pref-ebay-maxprice" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" 
                                    value="${localStorage.getItem('ebay_maxprice') || '100'}" 
                                    placeholder="100"
                                    onchange="saveModulePref('ebay_maxprice', this.value)">
                            </div>
                            
                            <!-- Calendar Preferences -->
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-lg">üìÖ</span>
                                    <span class="font-semibold">Calendar</span>
                                </div>
                                <label class="block text-sm mb-2">Default View</label>
                                <select id="pref-calendar-view" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" onchange="saveModulePref('calendar_view', this.value)">
                                    <option value="week" ${localStorage.getItem('calendar_view') === 'week' || !localStorage.getItem('calendar_view') ? 'selected' : ''}>üìÖ Week View</option>
                                    <option value="month" ${localStorage.getItem('calendar_view') === 'month' ? 'selected' : ''}>üìÜ Month View</option>
                                    <option value="list" ${localStorage.getItem('calendar_view') === 'list' ? 'selected' : ''}>üìã List View</option>
                                </select>
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-sm">Show week numbers</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pref-calendar-weeknums" ${localStorage.getItem('calendar_show_weeknums') === 'true' ? 'checked' : ''} onchange="saveModulePref('calendar_show_weeknums', this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-sm">24-hour time</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pref-calendar-24h" ${localStorage.getItem('calendar_24h') === 'true' ? 'checked' : ''} onchange="saveModulePref('calendar_24h', this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Comics Settings -->
                    <div class="mb-8" id="comics-settings-section">
                        <h3 class="text-lg font-semibold text-orange-300 mb-4"><i class="fas fa-book-open mr-2"></i>Comics Management</h3>
                        <div id="comics-settings-content" class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <div class="text-gray-400">Loading comics settings...</div>
                        </div>
                    </div>
                    
                    <!-- Voice Settings -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-microphone mr-2"></i>${currentSkin?.identity?.display_name || 'Assistant'} Voice Settings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Voice Style</label>
                                <select id="settings-voice-style" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mb-3">
                                    <option value="clean" ${v.default_style === 'clean' ? 'selected' : ''}>üîä Clean (No Effects)</option>
                                    <option value="droid" ${v.default_style === 'droid' ? 'selected' : ''}>ü§ñ Droid (Battle Droid)</option>
                                    <option value="demon" ${v.default_style === 'demon' ? 'selected' : ''}>üòà Demon (Dark & Ethereal)</option>
                                    <option value="gothic" ${v.default_style === 'gothic' ? 'selected' : ''}>ü¶á Gothic (Theatrical)</option>
                                    <option value="radio" ${v.default_style === 'radio' ? 'selected' : ''}>üìª Radio</option>
                                    <option value="pa_system" ${v.default_style === 'pa_system' ? 'selected' : ''}>üì¢ PA System</option>
                                </select>
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm">${currentSkin?.name === 'dracula' ? 'Authentic Demon Samples' : 'Authentic Voice Samples'}</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="settings-authentic" ${v.use_authentic_samples !== false ? 'checked' : ''} class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <span class="text-sm">Random ${currentSkin?.name === 'dracula' ? 'Dark Humor' : 'Sarcasm'}</span>
                                        <div class="text-xs text-gray-500">${currentSkin?.identity?.display_name || 'Assistant'} adds occasional ${currentSkin?.name === 'dracula' ? 'demonic quips' : 'sarcastic comments'}</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="settings-sarcasm" ${v.sarcasm_enabled ? 'checked' : ''} class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                                <label class="block text-sm font-semibold mb-2">Speed: <span id="settings-speed-value">${(v.speed || 0.75).toFixed(2)}</span>x</label>
                                <input type="range" id="settings-voice-speed" min="0.5" max="1.5" step="0.05" value="${v.speed || 0.75}" oninput="document.getElementById('settings-speed-value').textContent = this.value" class="w-full mb-3">
                                <label class="block text-sm font-semibold mb-2">Pitch: <span id="settings-pitch-value">${(v.pitch || 0.85).toFixed(2)}</span>x</label>
                                <input type="range" id="settings-voice-pitch" min="0.5" max="1.5" step="0.05" value="${v.pitch || 0.85}" oninput="document.getElementById('settings-pitch-value').textContent = this.value" class="w-full mb-3">
                                <label class="block text-sm font-semibold mb-2">Sarcasm Chance: <span id="settings-sarcasm-value">${Math.round((v.sarcasm_chance || 0.4) * 100)}</span>%</label>
                                <input type="range" id="settings-sarcasm-chance" min="0" max="100" step="5" value="${Math.round((v.sarcasm_chance || 0.4) * 100)}" oninput="document.getElementById('settings-sarcasm-value').textContent = this.value" class="w-full">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="saveSettingsVoice()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">Save Voice Settings</button>
                            <button onclick="testVoice()" id="settings-test-voice-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">üîä Test Voice</button>
                        </div>
                    </div>
                    
                    <!-- Data & Privacy -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-database mr-2"></i>Data & Privacy</h3>
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <div class="font-semibold">Clear Local Cache</div>
                                    <div class="text-xs text-gray-500">Remove cached data and preferences</div>
                                </div>
                                <button onclick="if(confirm('Clear all local data?')){localStorage.clear();location.reload();}" class="px-3 py-2 bg-red-700 hover:bg-red-600 rounded text-sm">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Keys & Integrations -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-key mr-2"></i>API Keys & Integrations</h3>
                        <div id="api-keys-container" class="space-y-4">
                            <div class="text-gray-400">Loading configuration...</div>
                        </div>
                    </div>
                    
                    <!-- About -->
                    <div>
                        <h3 class="text-lg font-semibold text-purple-300 mb-4"><i class="fas fa-info-circle mr-2"></i>About</h3>
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <div class="text-sm text-gray-300">${currentSkin?.identity?.display_name || 'R0-GR'} Personal Dashboard</div>
                            <div class="text-xs text-gray-500 mt-1">A Buildly Labs project</div>
                            <div class="text-xs text-gray-500 mt-1">Voice: Piper TTS with ${currentSkin?.name === 'dracula' ? 'ethereal demon' : 'custom droid'} effects</div>
                        </div>
                    </div>
                `;
                
                // Load API keys section
                loadApiKeysSection();
                
                // Load comics settings section
                loadComicsSettings();
                
            } catch (e) {
                console.error('Settings load error:', e);
                container.innerHTML = '<div class="text-red-400">Error loading settings</div>';
            }
        }
        
        // Load API Keys section
        async function loadApiKeysSection() {
            const container = document.getElementById('api-keys-container');
            if (!container) return;
            
            try {
                const resp = await fetch('/api/config');
                const data = await resp.json();
                
                if (!data.success) {
                    container.innerHTML = '<div class="text-red-400">Error loading configuration</div>';
                    return;
                }
                
                const grouped = data.grouped || {};
                
                // Category icons and display names
                const categoryMeta = {
                    'integrations': { icon: 'fa-plug', name: 'Service Integrations' },
                    'ai': { icon: 'fa-brain', name: 'AI Configuration' },
                    'server': { icon: 'fa-server', name: 'Server Settings' },
                    'backup': { icon: 'fa-cloud-upload-alt', name: 'Backup & Git' },
                    'general': { icon: 'fa-cog', name: 'General' }
                };
                
                let html = '';
                
                for (const [category, configs] of Object.entries(grouped)) {
                    const meta = categoryMeta[category] || { icon: 'fa-cog', name: category };
                    
                    html += `
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4 mb-4">
                            <h4 class="text-sm font-semibold text-purple-300 mb-3">
                                <i class="fas ${meta.icon} mr-2"></i>${meta.name}
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    `;
                    
                    for (const config of configs) {
                        const inputType = config.is_sensitive ? 'password' : 'text';
                        const statusIcon = config.has_value ? '‚úì' : '';
                        const statusClass = config.has_value ? 'text-green-400' : 'text-gray-500';
                        
                        html += `
                            <div class="flex flex-col">
                                <label class="text-xs text-gray-400 mb-1 flex items-center justify-between">
                                    <span>${config.display_name || config.key}</span>
                                    <span class="${statusClass} text-xs">${statusIcon}</span>
                                </label>
                                <div class="flex gap-2">
                                    <input type="${inputType}" 
                                           id="config-${config.key.replace(/\./g, '-')}"
                                           data-config-key="${config.key}"
                                           placeholder="${config.is_sensitive && config.has_value ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : (config.description || '')}"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm placeholder-gray-500">
                                    ${config.is_sensitive ? `
                                        <button onclick="toggleConfigVisibility('${config.key.replace(/\./g, '-')}')" 
                                                class="px-2 bg-gray-700 hover:bg-gray-600 rounded text-sm" title="Show/Hide">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    ` : ''}
                                </div>
                                ${config.description ? `<div class="text-xs text-gray-500 mt-1">${config.description}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="flex gap-2 mt-4">
                        <button onclick="saveApiKeys()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">
                            <i class="fas fa-save mr-2"></i>Save API Keys
                        </button>
                        <button onclick="loadApiKeysSection()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                            <i class="fas fa-sync mr-2"></i>Refresh
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Error loading API keys:', e);
                container.innerHTML = '<div class="text-red-400">Error loading API keys configuration</div>';
            }
        }
        
        function toggleConfigVisibility(keyId) {
            const input = document.getElementById('config-' + keyId);
            if (input) {
                input.type = input.type === 'password' ? 'text' : 'password';
            }
        }
        
        async function saveApiKeys() {
            try {
                const inputs = document.querySelectorAll('[data-config-key]');
                const configs = {};
                
                inputs.forEach(input => {
                    const key = input.dataset.configKey;
                    const value = input.value.trim();
                    // Only include if user entered a value (not just placeholder)
                    if (value && value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                        configs[key] = value;
                    }
                });
                
                if (Object.keys(configs).length === 0) {
                    alert('No changes to save. Enter values in the fields you want to update.');
                    return;
                }
                
                const resp = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ configs })
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    alert(`Saved ${data.updated.length} configuration(s) successfully!`);
                    loadApiKeysSection(); // Refresh to show updated status
                } else {
                    alert('Error saving: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error saving API keys:', e);
                alert('Error saving API keys: ' + e.message);
            }
        }

        // Save module preference to localStorage
        function saveModulePref(key, value) {
            try {
                if (typeof value === 'boolean') {
                    localStorage.setItem(key, value.toString());
                } else {
                    localStorage.setItem(key, value);
                }
                console.log('Saved preference:', key, '=', value);
            } catch (e) {
                console.error('Error saving preference:', e);
            }
        }

        // Comics Settings Functions
        async function loadComicsSettings() {
            const content = document.getElementById('comics-settings-content');
            if (!content) return;
            
            try {
                const resp = await fetch('/api/settings/comics');
                const data = await resp.json();
                
                if (!data.success) {
                    content.innerHTML = '<div class="text-red-400">Error loading comics settings</div>';
                    return;
                }
                
                const comics = data.comics || {};
                
                let comicsHtml = '';
                Object.entries(comics).forEach(([id, comic]) => {
                    const borderClass = comic.archive_count > 0 ? 'border-gray-700' : 'border-yellow-700/50';
                    const sourceIcon = comic.source === 'archive' ? 'üìÇ' : 'üåê';
                    const sourceText = comic.source === 'gocomics' ? 'GoComics' : 'Local Archive';
                    const customText = comic.custom ? ' ‚Ä¢ Custom' : '';
                    const archiveCountClass = comic.archive_count > 0 ? 'text-green-400' : 'text-yellow-400';
                    const archiveCount = comic.archive_count || 0;
                    const noArchiveBadge = comic.archive_count === 0 ? '<span class="text-xs text-yellow-400 bg-yellow-900/30 px-2 py-1 rounded">No archive</span>' : '';
                    const archiveChecked = comic.archive_enabled !== false ? 'checked' : '';
                    const enabledChecked = comic.enabled !== false ? 'checked' : '';
                    const removeBtn = comic.custom ? '<button data-comic-id="'+id+'" onclick="removeComic(this.dataset.comicId)" class="px-2 py-1 bg-red-700 hover:bg-red-600 rounded text-xs" title="Remove comic"><i class="fas fa-trash"></i></button>' : '';
                    
                    comicsHtml += '<div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg border '+borderClass+' hover:border-gray-600">' +
                        '<div class="flex items-center gap-3">' +
                            '<span class="text-lg">'+sourceIcon+'</span>' +
                            '<div>' +
                                '<div class="font-semibold text-gray-200">'+comic.name+'</div>' +
                                '<div class="text-xs text-gray-500">'+sourceText+customText+' ‚Ä¢ <span class="'+archiveCountClass+'">'+archiveCount+' archived</span></div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-4">' +
                            noArchiveBadge +
                            '<div class="flex items-center gap-2">' +
                                '<span class="text-xs text-gray-400">Archive</span>' +
                                '<label class="relative inline-flex items-center cursor-pointer">' +
                                    '<input type="checkbox" id="archive-'+id+'" '+archiveChecked+' onchange="updateComicSetting(this.id.replace(\'archive-\',\'\'), \'archive_enabled\', this.checked)" class="sr-only peer">' +
                                    '<div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-600"></div>' +
                                '</label>' +
                            '</div>' +
                            '<div class="flex items-center gap-2">' +
                                '<span class="text-xs text-gray-400">Show</span>' +
                                '<label class="relative inline-flex items-center cursor-pointer">' +
                                    '<input type="checkbox" id="enabled-'+id+'" '+enabledChecked+' onchange="updateComicSetting(this.id.replace(\'enabled-\',\'\'), \'enabled\', this.checked)" class="sr-only peer">' +
                                    '<div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>' +
                                '</label>' +
                            '</div>' +
                            removeBtn +
                        '</div>' +
                    '</div>';
                });
                
                content.innerHTML = 
                    '<div class="mb-6 p-4 bg-gray-800 rounded-lg border border-orange-600">' +
                        '<h4 class="text-sm font-semibold text-orange-300 mb-3"><i class="fas fa-plus-circle mr-2"></i>Add Comic from GoComics</h4>' +
                        '<div class="flex gap-2">' +
                            '<input type="url" id="new-comic-url" placeholder="https://www.gocomics.com/comic-name" class="flex-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded text-sm text-gray-200 placeholder-gray-500">' +
                            '<button onclick="addComicFromUrl()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded text-sm whitespace-nowrap"><i class="fas fa-plus mr-1"></i>Add</button>' +
                        '</div>' +
                        '<div class="text-xs text-gray-500 mt-2">Paste a GoComics URL to add a new comic strip</div>' +
                        '<div id="add-comic-status" class="text-xs mt-2 hidden"></div>' +
                    '</div>' +
                    '<div class="space-y-3">' +
                        '<div class="text-sm font-semibold text-gray-300 mb-2">Manage Comics</div>' +
                        comicsHtml +
                    '</div>' +
                    '<div class="mt-4 text-xs text-gray-500">' +
                        '<i class="fas fa-info-circle mr-1"></i>' +
                        '<strong>Show:</strong> Display comic in the dropdown. ' +
                        '<strong>Archive:</strong> Save comics to your local archive as they are viewed.' +
                    '</div>';
            } catch (e) {
                console.error('Error loading comics settings:', e);
                content.innerHTML = '<div class="text-red-400">Error loading comics settings</div>';
            }
        }

        async function updateComicSetting(comicId, field, value) {
            try {
                const resp = await fetch('/api/settings/comics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        comics: {
                            [comicId]: { [field]: value }
                        }
                    })
                });
                const data = await resp.json();
                if (!data.success) {
                    console.error('Failed to update comic setting:', data.error);
                }
                // Refresh the comic dropdown
                updateComicDropdown();
            } catch (e) {
                console.error('Error updating comic setting:', e);
            }
        }

        async function addComicFromUrl() {
            const input = document.getElementById('new-comic-url');
            const status = document.getElementById('add-comic-status');
            const url = input?.value?.trim();
            
            if (!url) {
                status.innerHTML = '<span class="text-red-400">Please enter a URL</span>';
                status.classList.remove('hidden');
                return;
            }
            
            status.innerHTML = '<span class="text-gray-400">Adding comic...</span>';
            status.classList.remove('hidden');
            
            try {
                const resp = await fetch('/api/settings/comics/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await resp.json();
                
                if (data.success) {
                    status.innerHTML = '<span class="text-green-400">‚úì ' + data.message + '</span>';
                    input.value = '';
                    loadComicsSettings();  // Refresh the list
                    updateComicDropdown();  // Update dropdown
                } else {
                    status.innerHTML = '<span class="text-red-400">‚úó ' + data.error + '</span>';
                }
            } catch (e) {
                console.error('Error adding comic:', e);
                status.innerHTML = '<span class="text-red-400">Error adding comic</span>';
            }
        }

        async function removeComic(comicId) {
            if (!confirm('Remove this comic from your list?')) return;
            
            try {
                const resp = await fetch('/api/settings/comics/' + comicId, {
                    method: 'DELETE'
                });
                const data = await resp.json();
                
                if (data.success) {
                    loadComicsSettings();  // Refresh the list
                    updateComicDropdown();  // Update dropdown
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                console.error('Error removing comic:', e);
                alert('Error removing comic');
            }
        }

        function updateComicDropdown() {
            // Refresh the comic dropdown on the main page
            const select = document.getElementById('comic-select');
            if (select) {
                // Trigger a refresh by simulating the widget is enabled
                reloadComic();
            }
        }

        async function saveSettingsVoice() {
            try {
                const style = document.getElementById('settings-voice-style')?.value || 'droid';
                const speed = parseFloat(document.getElementById('settings-voice-speed')?.value || 0.75);
                const pitch = parseFloat(document.getElementById('settings-voice-pitch')?.value || 0.85);
                const useAuthentic = document.getElementById('settings-authentic')?.checked !== false;
                const sarcasmEnabled = document.getElementById('settings-sarcasm')?.checked || false;
                const sarcasmChance = (parseInt(document.getElementById('settings-sarcasm-chance')?.value || 40)) / 100;
                
                await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        default_style: style,
                        speed: speed,
                        pitch: pitch,
                        use_authentic_samples: useAuthentic,
                        sarcasm_enabled: sarcasmEnabled,
                        sarcasm_chance: sarcasmChance
                    })
                });
                alert('Voice settings saved!');
            } catch (e) {
                console.error('Save voice settings error:', e);
                alert('Failed to save settings');
            }
        }

        // Comics
        // Load enabled comics into dropdown
        async function loadComicDropdown() {
            try {
                const resp = await fetch('/api/settings/comics');
                const data = await resp.json();
                console.log('üìö Comics API response:', data);
                
                const sel = document.getElementById('comic-select');
                if (!sel) {
                    console.error('Comic select element not found!');
                    return;
                }
                
                if (data.success && data.comics) {
                    // Get current selection
                    const currentValue = sel.value;
                    
                    // Build options for enabled comics
                    let options = '';
                    Object.entries(data.comics).forEach(([key, comic]) => {
                        console.log(`  Comic ${key}:`, comic);
                        // Check both 'show' and 'enabled' properties
                        if (comic.show !== false && comic.enabled !== false) {
                            const name = comic.name || key.charAt(0).toUpperCase() + key.slice(1);
                            options += `<option value="${key}">${name}</option>`;
                            console.log(`    ‚úÖ Added ${key} to dropdown`);
                        } else {
                            console.log(`    ‚ùå Skipped ${key} (show=${comic.show}, enabled=${comic.enabled})`);
                        }
                    });
                    options += '<option value="favorites">Favorites</option>';
                    
                    console.log(`üìã Total options built: ${options.split('</option>').length - 1}`);
                    sel.innerHTML = options;
                    
                    // Restore selection if still available
                    if (currentValue && Array.from(sel.options).some(opt => opt.value === currentValue)) {
                        sel.value = currentValue;
                    }
                } else {
                    console.error('Comics API failed or returned no comics:', data);
                    // Fallback to defaults
                    sel.innerHTML = `
                        <option value="garfield">Garfield</option>
                        <option value="bloomcounty">Bloom County</option>
                        <option value="calvin">Calvin & Hobbes</option>
                        <option value="peanuts">Peanuts</option>
                        <option value="favorites">Favorites</option>
                    `;
                }
            } catch (e) {
                console.error('Error loading comic dropdown:', e);
                // Fallback to defaults on error
                const sel = document.getElementById('comic-select');
                if (sel) {
                    sel.innerHTML = `
                        <option value="garfield">Garfield</option>
                        <option value="bloomcounty">Bloom County</option>
                        <option value="calvin">Calvin & Hobbes</option>
                        <option value="peanuts">Peanuts</option>
                        <option value="favorites">Favorites</option>
                    `;
                }
            }
        }

        async function reloadComic() {
            const display = document.getElementById('garfield');
            const sel = document.getElementById('comic-select');
            const choice = sel ? sel.value : 'garfield';
            if (!display) return;
            display.innerHTML = '<div class="animate-pulse text-gray-400">Loading comic...</div>';
            try {
                let url = '';
                if (choice === 'favorites') {
                    display.innerHTML = '<div class="text-sm text-gray-300">Use the Archive button to browse favorites.</div>';
                    return;
                }
                // Dynamic URL for any comic
                if (choice === 'garfield') {
                    url = '/api/comics/garfield/random';
                } else if (choice === 'calvin') {
                    url = '/api/comics/calvin/daily';
                } else if (choice === 'peanuts') {
                    url = '/api/comics/peanuts';
                } else {
                    // Try generic comic endpoint for other comics
                    url = `/api/comics/${choice}/daily`;
                }
                const resp = await fetch(url);
                const data = await resp.json();
                const comic = data.comic || data;
                const image = comic.image_url || data.image_url;
                const link = (comic.link || data.page_url || '#');
                if (image) {
                    // Make comic clickable to open viewer
                    display.innerHTML = `
                        <div onclick="openComicViewer('${comic.title || choice}', '${image}', '${link}', '${comic.date || ''}')" class="cursor-pointer hover:opacity-90 transition-opacity">
                            <img src="${image}" alt="Comic" class="w-full rounded-lg border border-orange-600 max-h-64 object-contain bg-gray-900">
                            <p class="text-xs text-center text-gray-400 mt-2"><i class="fas fa-expand mr-1"></i>Click to view full size</p>
                        </div>`;
                } else {
                    display.innerHTML = '<div class="text-gray-400">No comic available.</div>';
                }
            } catch (e) {
                console.error('Comic error:', e);
                display.innerHTML = '<div class="text-red-400">Error loading comic.</div>';
            }
        }

        async function showComicsArchive() {
            const modal = document.getElementById('garfield-archive-modal');
            const content = document.getElementById('garfield-archive-content');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">Loading...</div>';
            try {
                const resp = await fetch('/api/comics/favorites');
                const data = await resp.json();
                if (data.success && data.favorites && data.favorites.length > 0) {
                    content.innerHTML = data.favorites.map(comic => `
                        <div class="bg-gray-900 rounded-lg border border-orange-600 overflow-hidden cursor-pointer hover:opacity-90 transition-opacity" onclick="openComicViewer('${comic.title || 'Comic'}', '${comic.image_url}', '${comic.link || '#'}', '${comic.date || ''}')">
                            <img src="${comic.image_url}" alt="Comic" class="w-full h-40 object-cover">
                            <div class="p-2 text-xs text-orange-300">${comic.date || ''}</div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">No favorites yet</div>';
                }
            } catch (e) {
                console.error('Archive error:', e);
            }
        }

        function closeGarfieldArchive() {
            document.getElementById('garfield-archive-modal').classList.add('hidden');
        }

        // =====================================================
        // COMIC VIEWER MODAL
        // =====================================================
        let currentComicData = {
            title: '',
            imageUrl: '',
            sourceLink: '',
            date: '',
            index: 0,
            totalComics: 1,
            comicList: []
        };

        function openComicViewer(title, imageUrl, sourceLink, date) {
            currentComicData = {
                title: title || 'Comic',
                imageUrl: imageUrl,
                sourceLink: sourceLink,
                date: date || '',
                index: 0,
                totalComics: 1,
                comicList: [{ title, imageUrl, sourceLink, date }]
            };
            updateComicViewer();
            document.getElementById('comic-viewer-modal').classList.remove('hidden');
        }

        function closeComicViewer() {
            document.getElementById('comic-viewer-modal').classList.add('hidden');
        }

        function updateComicViewer() {
            document.getElementById('comic-viewer-title').textContent = currentComicData.title;
            document.getElementById('comic-viewer-date').textContent = currentComicData.date;
            document.getElementById('comic-viewer-image').src = currentComicData.imageUrl;
            document.getElementById('comic-viewer-counter').textContent = `${currentComicData.index + 1} / ${currentComicData.totalComics}`;
            
            // Update like/dislike button states
            updateComicLikeButtons();
        }

        function updateComicLikeButtons() {
            const likeBtn = document.getElementById('comic-like-btn');
            const dislikeBtn = document.getElementById('comic-dislike-btn');
            
            // Get saved preferences
            const prefs = JSON.parse(localStorage.getItem('comic_preferences') || '{}');
            const currentPref = prefs[currentComicData.imageUrl];
            
            // Reset styles
            likeBtn.className = 'px-4 py-2 rounded-lg flex items-center gap-2';
            dislikeBtn.className = 'px-4 py-2 rounded-lg flex items-center gap-2';
            
            if (currentPref === 'like') {
                likeBtn.className += ' bg-green-600 ring-2 ring-green-400';
                dislikeBtn.className += ' bg-red-700 hover:bg-red-600';
            } else if (currentPref === 'dislike') {
                likeBtn.className += ' bg-green-700 hover:bg-green-600';
                dislikeBtn.className += ' bg-red-600 ring-2 ring-red-400';
            } else {
                likeBtn.className += ' bg-green-700 hover:bg-green-600';
                dislikeBtn.className += ' bg-red-700 hover:bg-red-600';
            }
        }

        function likeComic() {
            const prefs = JSON.parse(localStorage.getItem('comic_preferences') || '{}');
            const current = prefs[currentComicData.imageUrl];
            
            // Toggle like
            if (current === 'like') {
                delete prefs[currentComicData.imageUrl];
            } else {
                prefs[currentComicData.imageUrl] = 'like';
            }
            
            localStorage.setItem('comic_preferences', JSON.stringify(prefs));
            updateComicLikeButtons();
            
            // Visual feedback
            showToast('üëç Comic preference saved!');
        }

        function dislikeComic() {
            const prefs = JSON.parse(localStorage.getItem('comic_preferences') || '{}');
            const current = prefs[currentComicData.imageUrl];
            
            // Toggle dislike
            if (current === 'dislike') {
                delete prefs[currentComicData.imageUrl];
            } else {
                prefs[currentComicData.imageUrl] = 'dislike';
            }
            
            localStorage.setItem('comic_preferences', JSON.stringify(prefs));
            updateComicLikeButtons();
            
            // Visual feedback
            showToast('üëé Comic preference saved!');
        }

        function nextComic() {
            if (currentComicData.index < currentComicData.totalComics - 1) {
                currentComicData.index++;
                const comic = currentComicData.comicList[currentComicData.index];
                currentComicData.imageUrl = comic.imageUrl;
                currentComicData.title = comic.title;
                currentComicData.sourceLink = comic.sourceLink;
                currentComicData.date = comic.date;
                updateComicViewer();
            }
        }

        function previousComic() {
            if (currentComicData.index > 0) {
                currentComicData.index--;
                const comic = currentComicData.comicList[currentComicData.index];
                currentComicData.imageUrl = comic.imageUrl;
                currentComicData.title = comic.title;
                currentComicData.sourceLink = comic.sourceLink;
                currentComicData.date = comic.date;
                updateComicViewer();
            }
        }

        function openComicSource() {
            if (currentComicData.sourceLink && currentComicData.sourceLink !== '#') {
                window.open(currentComicData.sourceLink, '_blank');
            }
        }

        function showToast(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-gray-800 border border-orange-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // eBay Auctions
        async function loadEbayAuctions() {
            const list = document.getElementById('ebay-auctions-list');
            if (!list) return;
            list.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8 animate-pulse">Scanning eBay for deals...</div>';
            try {
                const resp = await fetch('/api/ebay/auctions?category=retro_tech');
                const data = await resp.json();
                console.log('eBay response:', data);
                if (data.success && data.auctions && data.auctions.length > 0) {
                    list.innerHTML = data.auctions.map(auction => `
                        <div class="bg-gray-900 rounded-lg border border-yellow-600 overflow-hidden flex flex-col">
                            <img src="${auction.image_url}" alt="${auction.title}" class="w-full h-40 object-cover">
                            <div class="p-3 flex-1 flex flex-col">
                                <h4 class="font-semibold text-yellow-300 line-clamp-2 text-sm mb-2">${auction.title}</h4>
                                <div class="flex justify-between items-center mb-3 mt-auto">
                                    <span class="text-lg font-bold text-green-300">$${auction.current_price}</span>
                                    <span class="text-xs text-gray-400">${auction.time_left}</span>
                                </div>
                                <a href="${auction.link}" target="_blank" class="block w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-sm text-center font-semibold">View</a>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">üîç No auctions found right now. eBay\'s structure may have changed.</div>';
                }
            } catch (e) {
                console.error('eBay error:', e);
                list.innerHTML = '<div class="col-span-full text-red-400 text-center py-8">Error loading auctions</div>';
            }
        }

        // Weather
        async function loadWeather(lat = null, lon = null, name = null) {
            const display = document.getElementById('weather-display');
            const forecastBox = document.getElementById('weather-forecast');
            const alertsBox = document.getElementById('weather-alerts');
            try {
                const qs = new URLSearchParams();
                if (lat !== null && lon !== null) {
                    qs.set('lat', lat);
                    qs.set('lon', lon);
                }
                if (name) qs.set('location', name);
                const resp = await fetch(`/api/weather${qs.toString() ? '?' + qs.toString() : ''}`);
                const data = await resp.json();
                const w = data;
                if (w && (w.temperature || w.description)) {
                    display.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="text-5xl font-extrabold text-cyan-300">${w.temperature || ''}</div>
                                <div class="text-sm text-gray-400">${w.description || 'No data'}</div>
                                <div class="text-xs text-gray-500 mt-1">Feels like ${w.feels_like || ''}</div>
                                <div class="text-xs text-gray-500 mt-1">Wind: ${w.wind_speed ?? ''} mph</div>
                                <div class="text-xs text-gray-500 mt-1">Humidity: ${w.humidity ?? ''}%</div>
                                <div class="text-xs text-gray-500 mt-1">Location: ${w.location || (name || 'Unknown')}</div>
                            </div>
                        </div>
                    `;

                    // Forecast
                    if (Array.isArray(w.forecast)) {
                        forecastBox.innerHTML = w.forecast.map(f => `
                            <div class="bg-gray-900 rounded border border-cyan-700 p-2 text-xs text-gray-300">
                                <div class="font-semibold text-cyan-300">${f.day || ''}</div>
                                <div class="text-gray-400">${f.high} / ${f.low}</div>
                                <div class="text-gray-500">${f.condition || ''}</div>
                            </div>
                        `).join('');
                    } else {
                        forecastBox.innerHTML = '';
                    }

                    // Alerts
                    if (Array.isArray(w.alerts) && w.alerts.length) {
                        alertsBox.innerHTML = `
                            <div class="text-sm font-semibold text-red-300 mb-2">Severe Weather Alerts</div>
                            ${w.alerts.map(a => `
                                <div class="bg-gray-900 rounded border border-red-700 p-3 mb-2">
                                    <div class="text-red-300 font-semibold text-sm">${a.event || 'Alert'} (${a.severity || ''})</div>
                                    <div class="text-xs text-gray-400">${a.start || ''} ‚Üí ${a.end || ''}</div>
                                    <div class="text-xs text-gray-300 mt-1">${a.description || ''}</div>
                                    <div class="text-xs text-gray-500 mt-1">Source: ${a.source || ''}</div>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        alertsBox.innerHTML = '';
                    }
                }
            } catch (e) {
                console.error('Weather error:', e);
                display.innerHTML = '<div class="text-sm text-red-400">Error loading weather</div>';
                forecastBox.innerHTML = '';
                alertsBox.innerHTML = '';
            }
        }

        // Ambient Weather (Local Station)
        async function loadAmbientWeather() {
            const display = document.getElementById('ambient-weather-display');
            if (!display) return;
            
            try {
                const resp = await fetch('/api/weather/ambient');
                const data = await resp.json();
                
                if (!data.success) {
                    if (!data.configured) {
                        display.innerHTML = `
                            <div class="bg-gray-900 rounded border border-yellow-600 p-4">
                                <div class="text-yellow-400 font-semibold mb-2">‚ö†Ô∏è Ambient Weather Not Configured</div>
                                <div class="text-sm text-gray-400 mb-3">To connect your local weather station:</div>
                                <ol class="text-xs text-gray-400 list-decimal ml-4 space-y-1">
                                    <li>Go to <a href="https://ambientweather.net/account" target="_blank" class="text-cyan-400 underline">ambientweather.net/account</a></li>
                                    <li>Create an API Key and Application Key</li>
                                    <li>Add both keys to config/credentials.yaml under ambient_weather</li>
                                </ol>
                            </div>
                        `;
                    } else {
                        display.innerHTML = `<div class="text-red-400">${data.error || 'Error loading station data'}</div>`;
                    }
                    return;
                }
                
                const w = data.data;
                const windDir = w.wind_direction_cardinal || '';
                const lastUpdate = w.timestamp ? new Date(w.timestamp).toLocaleTimeString() : '';
                
                display.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Main Temperature -->
                        <div class="bg-gray-900 rounded border border-green-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Outdoor</div>
                            <div class="text-4xl font-extrabold text-green-300">${w.temperature_display || w.temperature + '¬∞F'}</div>
                            <div class="text-sm text-gray-400">Feels like ${w.feels_like_display || (w.feels_like ? w.feels_like + '¬∞F' : '--')}</div>
                            <div class="text-xs text-gray-500 mt-2">Humidity: ${w.humidity}%</div>
                            <div class="text-xs text-gray-500">Dew Point: ${w.dew_point ? w.dew_point.toFixed(1) + '¬∞F' : '--'}</div>
                        </div>
                        
                        <!-- Indoor -->
                        ${w.temperature_indoor ? `
                        <div class="bg-gray-900 rounded border border-blue-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Indoor</div>
                            <div class="text-3xl font-bold text-blue-300">${w.temperature_indoor}¬∞F</div>
                            <div class="text-xs text-gray-500 mt-2">Humidity: ${w.humidity_indoor || '--'}%</div>
                        </div>
                        ` : ''}
                        
                        <!-- Wind -->
                        <div class="bg-gray-900 rounded border border-cyan-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Wind</div>
                            <div class="text-2xl font-bold text-cyan-300">${w.wind_speed || 0} mph ${windDir}</div>
                            <div class="text-xs text-gray-400">Gusts: ${w.wind_gust || 0} mph</div>
                            <div class="text-xs text-gray-500 mt-2">Max Today: ${w.max_daily_gust || 0} mph</div>
                        </div>
                        
                        <!-- Pressure -->
                        <div class="bg-gray-900 rounded border border-purple-700 p-4">
                            <div class="text-xs text-gray-500 mb-1">Pressure</div>
                            <div class="text-xl font-bold text-purple-300">${w.pressure_display || (w.pressure_relative ? w.pressure_relative.toFixed(2) + ' inHg' : '--')}</div>
                        </div>
                        
                        <!-- Rain -->
                        <div class="bg-gray-900 rounded border border-blue-600 p-4">
                            <div class="text-xs text-gray-500 mb-1">Rain</div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div><span class="text-gray-400">Hourly:</span> <span class="text-blue-300">${w.rain_hourly || 0}"</span></div>
                                <div><span class="text-gray-400">Daily:</span> <span class="text-blue-300">${w.rain_daily || 0}"</span></div>
                                <div><span class="text-gray-400">Weekly:</span> <span class="text-blue-300">${w.rain_weekly || 0}"</span></div>
                                <div><span class="text-gray-400">Monthly:</span> <span class="text-blue-300">${w.rain_monthly || 0}"</span></div>
                            </div>
                        </div>
                        
                        <!-- UV / Solar -->
                        ${w.uv_index !== undefined || w.solar_radiation !== undefined ? `
                        <div class="bg-gray-900 rounded border border-yellow-600 p-4">
                            <div class="text-xs text-gray-500 mb-1">UV / Solar</div>
                            ${w.uv_index !== undefined ? `<div class="text-xl font-bold text-yellow-300">UV ${w.uv_index}</div>` : ''}
                            ${w.solar_radiation !== undefined ? `<div class="text-xs text-gray-400">Solar: ${w.solar_radiation} W/m¬≤</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- Air Quality -->
                        ${w.pm25 !== undefined || w.aqi_pm25 !== undefined ? `
                        <div class="bg-gray-900 rounded border border-orange-600 p-4">
                            <div class="text-xs text-gray-500 mb-1">Air Quality</div>
                            ${w.aqi_pm25 !== undefined ? `<div class="text-xl font-bold text-orange-300">AQI ${w.aqi_pm25}</div>` : ''}
                            ${w.pm25 !== undefined ? `<div class="text-xs text-gray-400">PM2.5: ${w.pm25} ¬µg/m¬≥</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Station Info -->
                    <div class="mt-4 text-xs text-gray-500 flex justify-between">
                        <span>üì° ${w.station_name || 'Weather Station'} ${w.station_location ? '‚Ä¢ ' + w.station_location : ''}</span>
                        <span>Updated: ${lastUpdate}</span>
                    </div>
                `;
            } catch (e) {
                console.error('Ambient weather error:', e);
                display.innerHTML = '<div class="text-red-400">Error loading local weather station</div>';
            }
        }

        async function searchWeather() {
            const q = document.getElementById('weather-search-input').value.trim();
            const results = document.getElementById('weather-search-results');
            if (!q) { results.innerHTML = ''; return; }
            try {
                const resp = await fetch(`/api/weather/search?q=${encodeURIComponent(q)}`);
                const data = await resp.json();
                if (data.success && Array.isArray(data.results)) {
                    results.innerHTML = data.results.map(r => `
                        <button class="block w-full text-left px-3 py-2 bg-gray-900 hover:bg-gray-700 rounded border border-gray-700 mb-2"
                            onclick="selectWeatherLocation(${r.latitude},${r.longitude},'${r.name}, ${r.country}')">
                            <span class="text-gray-200">${r.name}</span>
                            <span class="text-gray-500">${r.country}</span>
                        </button>
                    `).join('');
                } else {
                    results.innerHTML = '<div class="text-xs text-gray-500">No matches</div>';
                }
            } catch (e) {
                console.error('Weather search error:', e);
            }
        }

        async function searchWeatherTo(inputId, resultsId) {
            const q = document.getElementById(inputId).value.trim();
            const results = document.getElementById(resultsId);
            if (!q) { results.innerHTML = ''; return; }
            try {
                const resp = await fetch(`/api/weather/search?q=${encodeURIComponent(q)}`);
                const data = await resp.json();
                if (data.success && Array.isArray(data.results)) {
                    results.innerHTML = data.results.map(r => `
                        <button class="block w-full text-left px-3 py-2 bg-gray-900 hover:bg-gray-700 rounded border border-gray-700 mb-2"
                            onclick="selectWeatherLocation(${r.latitude},${r.longitude},'${r.name}, ${r.country}')">
                            <span class="text-gray-200">${r.name}</span>
                            <span class="text-gray-500">${r.country}</span>
                        </button>
                    `).join('');
                } else {
                    results.innerHTML = '<div class="text-xs text-gray-500">No matches</div>';
                }
            } catch (e) {
                console.error('Weather search error:', e);
            }
        }

        // News
        async function loadNews() {
            const filterSel = document.getElementById('news-filter');
            const filter = filterSel ? filterSel.value : 'all';
            const list = document.getElementById('news-list');
            try {
                const resp = await fetch(`/api/news?filter=${encodeURIComponent(filter)}`);
                const data = await resp.json();
                const articles = data.articles || [];
                if (!articles.length) {
                    list.innerHTML = '<div class="text-gray-400 col-span-full text-center py-8">No news available</div>';
                    return;
                }
                list.innerHTML = articles.map(a => `
                    <div class="bg-gray-900 rounded border border-gray-700 p-4">
                        <a href="${a.url}" target="_blank" class="text-gray-200 hover:text-white font-semibold">${a.title}</a>
                        <div class="text-xs text-gray-500 mt-1">${a.source || ''} ‚Ä¢ ${a.published_at || ''}</div>
                        <div class="text-sm text-gray-400 mt-2">${a.description || ''}</div>
                        <div class="text-xs text-gray-600 mt-2">${a.category || ''}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('News error:', e);
                list.innerHTML = '<div class="text-red-400 col-span-full text-center py-8">Error loading news</div>';
            }
        }

        // Calm Tips (from anxiety feed, supportive only)
        async function loadCalmTips() {
            const tips = document.getElementById('calm-tips');
            try {
                const resp = await fetch('/api/feeds/anxiety');
                const data = await resp.json();
                const articles = (data.articles || []).filter(a => {
                    const t = (a.title || '').toLowerCase();
                    return t.includes('tips') || t.includes('how to') || t.includes('ways to') || t.includes('manage') || t.includes('cope');
                }).slice(0, 6);
                if (!articles.length) {
                    tips.innerHTML = '<div class="text-gray-400 col-span-full text-center py-6">No tips right now</div>';
                    return;
                }
                tips.innerHTML = articles.map(a => `
                    <div class="bg-gray-900 rounded border border-emerald-700 p-3">
                        <a href="${a.link}" target="_blank" class="text-emerald-300 hover:text-emerald-200 font-semibold text-sm line-clamp-2">${a.title}</a>
                        <div class="text-xs text-emerald-200/70 mt-1">${a.date || ''}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Calm tips error:', e);
                tips.innerHTML = '<div class="text-gray-400 col-span-full text-center py-6">Error loading tips</div>';
            }
        }

        // Tasks
        async function loadTasks() {
            const list = document.getElementById('tasks-list');
            try {
                const r = await fetch('/api/tasks');
                const d = await r.json();
                const tasks = d.tasks || [];
                if (!tasks.length) {
                    list.innerHTML = '<div class="text-gray-400 col-span-full text-center py-8">No tasks yet</div>';
                    return;
                }
                list.innerHTML = tasks.map(t => `
                    <div class="bg-gray-900 rounded border border-gray-700 p-4">
                        <div class="font-semibold text-gray-200">${t.title}</div>
                        <div class="text-xs text-gray-500 mt-1">${t.category || ''} ‚Ä¢ ${t.priority || ''}</div>
                        ${t.due_date ? `<div class=\"text-xs text-gray-500 mt-1\">Due: ${t.due_date}</div>` : ''}
                        ${t.source_url ? `<a href=\"${t.source_url}\" target=\"_blank\" class=\"text-xs text-blue-300 hover:underline mt-2 inline-block\">View source</a>` : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error('Tasks error', e);
                list.innerHTML = '<div class="text-red-400 col-span-full text-center py-8">Error loading tasks</div>';
            }
        }

        async function generateSmartTasks(includeCalendarDefault) {
            const includeEmail = document.getElementById('include-email')?.checked || false;
            try {
                const r = await fetch('/api/tasks/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ include_notes: true, include_calendar: includeCalendarDefault, include_email: includeEmail })
                });
                const d = await r.json();
                loadTasks();
            } catch (e) {
                console.error('Generate tasks error', e);
            }
        }

        function selectWeatherLocation(lat, lon, name) {
            try {
                localStorage.setItem('weather_selected', JSON.stringify({lat, lon, name}));
            } catch {}
            loadWeather(lat, lon, name);
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) { return; }
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                loadWeather(latitude, longitude, 'Current Location');
            }, () => {
                // Fallback: load default
                loadWeather();
            });
        }

        // Calm Radar / Anxiety Feed - DISABLED (no HTML element present)
        // Function removed to prevent execution errors
        // Jokes
        async function loadJokes() {
            const el = document.getElementById('jokes');
            if (!el) return;
            try {
                const r = await fetch('/api/joke');
                const d = await r.json();
                console.log('Joke loaded:', d.joke);
                if (d.joke) {
                    el.innerHTML = `<div class="text-sm text-gray-300">${d.joke}</div>`;
                }
            } catch (e) { console.error('Jokes error', e); }
        }

        // Quote
        async function loadQuote() {
            const el = document.getElementById('quote');
            if (!el) return;
            try {
                const r = await fetch('/api/quote');
                const d = await r.json();
                console.log('Quote loaded:', d.quote);
                if (d.quote) {
                    el.innerHTML = `<div class="text-sm text-gray-300 italic">"${d.quote}"</div>`;
                }
            } catch (e) { console.error('Quote error', e); }
        }

        // Comics: handled above; keep only the change listener here
        document.addEventListener('change', (ev) => {
            const t = ev.target;
            if (t && t.id === 'comic-select') reloadComic();
        });

        function setAnxietyPref(id, value) {
            const prefs = JSON.parse(localStorage.getItem('anxiety_prefs') || '{}');
            prefs[id] = value;
            localStorage.setItem('anxiety_prefs', JSON.stringify(prefs));
        }

        // ================================
        // UNIFIED CALENDAR SYSTEM
        // ================================
        let calendarEvents = [];
        let calendarWeekOffset = 0;
        
        // Load all calendar events (primary + family)
        async function loadUnifiedCalendar() {
            try {
                // Fetch both calendars
                const [primaryResp, familyResp] = await Promise.all([
                    fetch('/api/calendar').catch(() => ({ json: () => ({ events: [] }) })),
                    fetch('/api/calendar/family').catch(() => ({ json: () => ({ events: [] }) }))
                ]);
                
                const primaryData = await primaryResp.json();
                const familyData = await familyResp.json();
                
                // Combine events with source tags
                calendarEvents = [];
                
                if (primaryData.events) {
                    primaryData.events.forEach(e => {
                        calendarEvents.push({ ...e, source: 'primary', color: 'green' });
                    });
                }
                
                if (familyData.success && familyData.events) {
                    familyData.events.forEach(e => {
                        calendarEvents.push({ ...e, source: 'family', color: 'blue' });
                    });
                }
                
                // Sort by start time
                calendarEvents.sort((a, b) => new Date(a.start_time || a.start) - new Date(b.start_time || b.start));
                
                // Render views
                renderWeekView();
                renderDayView();
                renderUpcomingEvents();
                
            } catch (e) {
                console.error('Calendar load error:', e);
            }
        }
        
        // Render mini week view
        function renderWeekView() {
            const container = document.getElementById('calendar-week-view');
            if (!container) return;
            
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + (calendarWeekOffset * 7));
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateStr = date.toDateString();
                const isToday = date.toDateString() === today.toDateString();
                
                // Count events for this day
                const dayEvents = calendarEvents.filter(e => {
                    const eventDate = new Date(e.start_time || e.start);
                    return eventDate.toDateString() === dateStr;
                });
                
                const hasEvents = dayEvents.length > 0;
                const bgColor = isToday ? 'bg-green-700' : (hasEvents ? 'bg-gray-700' : 'bg-gray-800');
                const borderColor = isToday ? 'border-green-500' : 'border-gray-600';
                
                html += `
                    <div onclick="jumpToDate('${date.toISOString()}')" class="p-2 ${bgColor} rounded border ${borderColor} cursor-pointer hover:bg-gray-600 transition">
                        <div class="text-gray-400">${days[i]}</div>
                        <div class="${isToday ? 'text-white font-bold' : 'text-gray-300'}">${date.getDate()}</div>
                        ${hasEvents ? `<div class="text-xs text-green-400">${dayEvents.length} event${dayEvents.length > 1 ? 's' : ''}</div>` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Render day timeline view
        function renderDayView() {
            const container = document.getElementById('calendar-day-view');
            const title = document.getElementById('calendar-day-title');
            if (!container) return;
            
            const today = new Date();
            const currentHour = today.getHours();
            const currentMinute = today.getMinutes();
            
            if (title) {
                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                title.innerHTML = `<i class="fas fa-calendar-alt mr-2"></i>${today.toLocaleDateString('en-US', options)}`;
            }
            
            // Get today's events
            const todayStr = today.toDateString();
            const todayEvents = calendarEvents.filter(e => {
                const eventDate = new Date(e.start_time || e.start);
                return eventDate.toDateString() === todayStr;
            });
            
            // Build hour timeline (6 AM to 11 PM)
            let html = '<div class="relative">';
            
            for (let hour = 6; hour <= 23; hour++) {
                const isPast = hour < currentHour;
                const isCurrent = hour === currentHour;
                const hourLabel = hour === 0 ? '12 AM' : hour < 12 ? `${hour} AM` : hour === 12 ? '12 PM' : `${hour - 12} PM`;
                
                html += `
                    <div class="flex border-b border-gray-700 ${isPast ? 'opacity-50' : ''}">
                        <div class="w-16 px-2 py-2 text-xs text-gray-500 flex-shrink-0">${hourLabel}</div>
                        <div class="flex-1 min-h-12 relative px-2 py-1" id="hour-${hour}">
                `;
                
                // Add events that start in this hour
                todayEvents.forEach(event => {
                    const eventTime = new Date(event.start_time || event.start);
                    if (eventTime.getHours() === hour) {
                        const colorClass = event.color === 'blue' ? 'bg-blue-700 border-blue-500' : 'bg-green-700 border-green-500';
                        const sourceIcon = event.source === 'family' ? 'üë®‚Äçüë©‚Äçüëß' : 'üìÖ';
                        html += `
                            <div class="mb-1 p-2 ${colorClass} rounded border text-xs">
                                <div class="font-semibold text-white">${sourceIcon} ${event.title}</div>
                                <div class="text-gray-300">${eventTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</div>
                            </div>
                        `;
                    }
                });
                
                html += '</div></div>';
            }
            
            // Add current time indicator
            if (currentHour >= 6 && currentHour <= 23) {
                const topPercent = ((currentHour - 6) * 60 + currentMinute) / (18 * 60) * 100;
                html += `
                    <div class="absolute left-0 right-0 flex items-center pointer-events-none" style="top: ${topPercent}%;">
                        <div class="w-16 text-right pr-1">
                            <span class="bg-red-600 text-white text-xs px-1 rounded">${today.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</span>
                        </div>
                        <div class="flex-1 border-t-2 border-red-500"></div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            if (todayEvents.length === 0) {
                html = '<div class="p-8 text-center text-gray-500">No events scheduled for today</div>' + html;
            }
            
            container.innerHTML = html;
            
            // Scroll to current time
            setTimeout(() => {
                const currentTimeEl = container.querySelector(`#hour-${currentHour}`);
                if (currentTimeEl) {
                    currentTimeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        // Render upcoming events list
        function renderUpcomingEvents() {
            const container = document.getElementById('calendar-upcoming');
            if (!container) return;
            
            const now = new Date();
            const upcoming = calendarEvents.filter(e => {
                const eventTime = new Date(e.start_time || e.start);
                return eventTime > now;
            }).slice(0, 5);
            
            if (upcoming.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-xs">No upcoming events</div>';
                return;
            }
            
            container.innerHTML = upcoming.map(event => {
                const eventTime = new Date(event.start_time || event.start);
                const timeStr = eventTime.toLocaleString('en-US', { 
                    weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' 
                });
                const colorClass = event.color === 'blue' ? 'text-blue-300 border-blue-700' : 'text-green-300 border-green-700';
                const sourceIcon = event.source === 'family' ? 'üë®‚Äçüë©‚Äçüëß' : 'üìÖ';
                
                return `
                    <div class="flex items-center gap-2 p-2 bg-gray-800 rounded border ${colorClass.split(' ')[1]}">
                        <span>${sourceIcon}</span>
                        <div class="flex-1">
                            <div class="font-semibold ${colorClass.split(' ')[0]}">${event.title}</div>
                            <div class="text-xs text-gray-400">${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Navigate week view
        function navigateCalendarWeek(offset) {
            if (offset === 0) {
                calendarWeekOffset = 0;
            } else {
                calendarWeekOffset += offset;
            }
            renderWeekView();
        }
        
        // Jump to specific date
        function jumpToDate(isoDate) {
            // For now, just show alert - could expand to show that day's events
            const date = new Date(isoDate);
            alert(`Events for ${date.toLocaleDateString()}: ${calendarEvents.filter(e => new Date(e.start_time || e.start).toDateString() === date.toDateString()).map(e => e.title).join(', ') || 'None'}`);
        }
        
        // Read upcoming events aloud
        async function readUpcomingEvents() {
            const now = new Date();
            const upcoming = calendarEvents.filter(e => {
                const eventTime = new Date(e.start_time || e.start);
                return eventTime > now;
            }).slice(0, 3);
            
            if (upcoming.length === 0) {
                const text = "You have no upcoming events.";
                await speakText(text);
                return;
            }
            
            const eventDescriptions = upcoming.map(e => {
                const time = new Date(e.start_time || e.start);
                const timeStr = time.toLocaleString('en-US', { weekday: 'short', hour: 'numeric', minute: '2-digit' });
                return `${e.title} on ${timeStr}`;
            });
            
            const text = `You have ${upcoming.length} upcoming event${upcoming.length > 1 ? 's' : ''}. ${eventDescriptions.join('. ')}.`;
            await speakText(text);
        }
        
        // Helper to speak text - plays audio response
        async function speakText(text) {
            const style = currentSkin?.voice?.style || 'droid';
            try {
                const response = await fetch('/api/voice/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, style })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);
                    audio.onended = () => URL.revokeObjectURL(audioUrl);
                    await audio.play();
                } else {
                    console.error('Voice API error:', response.status);
                    // Fallback to browser TTS
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        speechSynthesis.speak(utterance);
                    }
                }
            } catch (e) {
                console.error('Speak error:', e);
                // Fallback to browser TTS
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            }
        }
        
        // Legacy function for backwards compatibility
        async function loadFamilyCalendar() {
            // Now handled by loadUnifiedCalendar
            await loadUnifiedCalendar();
        }

        // Roger Home Content
        async function loadRogerHome() {
            try {
                const resp = await fetch('/api/roger_home');
                const data = await resp.json();
                console.log('Roger Home loaded:', data);
                if (!data.ok) return;
                const c = data.content || {};

                // Parts
                const partsEl = document.getElementById('parts');
                if (partsEl && c.parts_search_terms) {
                    partsEl.innerHTML = `
                        <div class="space-y-2">
                            ${c.parts_search_terms.slice(0, 3).map(t => `<div class="text-xs text-gray-300">üîç ${t}</div>`).join('')}
                            ${c.parts_tips ? `<div class="text-xs text-gray-400 mt-2">${c.parts_tips[0]}</div>` : ''}
                        </div>`;
                }

                // History
                const historyEl = document.getElementById('history');
                if (historyEl && c.history_fact) {
                    historyEl.innerHTML = `<div class="text-sm text-gray-300">${c.history_fact}</div>`;
                }

                // Star Wars
                const starwarsEl = document.getElementById('starwars');
                if (starwarsEl && c.starwars_fact) {
                    starwarsEl.innerHTML = `<div class="text-sm text-gray-300">${c.starwars_fact}</div>`;
                }

                // Communities
                const commEl = document.getElementById('communities');
                if (commEl && Array.isArray(c.subreddit_suggestions)) {
                    commEl.innerHTML = c.subreddit_suggestions.slice(0, 3).map(s => `
                        <div class="mb-2">
                            <a href="https://reddit.com/r/${s.subreddit}" target="_blank" class="text-purple-300 hover:underline text-sm">r/${s.subreddit}</a>
                            <div class="text-xs text-gray-500">${s.tip}</div>
                        </div>
                    `).join('');
                }

                // Roger Quotes
                const rogerQuotesEl = document.getElementById('roger-quotes');
                if (rogerQuotesEl && c.positive_quote) {
                    rogerQuotesEl.innerHTML = `<div class="text-sm text-gray-300 italic">"${c.positive_quote}"</div>`;
                }
            } catch (e) {
                console.error('Roger home error:', e);
            }
        }

        // Initialize data loaders - MODULAR based on skin config
        function initializeDataLoaders() {
            console.log('üöÄ INITIALIZING DATA LOADERS');
            
            // Always load weather
            loadWeather();
            
            // Check which widgets are enabled for current skin
            const widgets = currentSkin?.dashboard?.widgets || {};
            
            // Load data for enabled widgets only
            if (isWidgetEnabled('jokes')) loadJokes();
            if (isWidgetEnabled('quote')) loadQuote();
            if (isWidgetEnabled('comics')) {
                loadComicDropdown().then(() => reloadComic());
            }
            if (isWidgetEnabled('ebay')) loadEbayAuctions();
            if (isWidgetEnabled('roger_quotes') || isWidgetEnabled('communities') || 
                isWidgetEnabled('starwars') || isWidgetEnabled('parts_search') || 
                isWidgetEnabled('history_fact')) {
                loadRogerHome();
            }
            
            // Load Dracula-specific widgets
            if (isWidgetEnabled('dark_news')) loadDarkNews();
            if (isWidgetEnabled('dracula_quotes')) loadDraculaQuote();
            if (isWidgetEnabled('music_player')) {
                // Initialize music player with Last.fm data
                console.log('üéµ Music player widget enabled - loading station');
                loadMusicStation();
            }
            
            // loadAnxietyFeed();  // Commented out - HTML element 'anxiety-list' not present
            
            console.log('üöÄ ALL RELEVANT DATA LOADERS CALLED');
        }
        
        // Helper to check if widget is enabled - integrates with MODULE_REGISTRY
        function isWidgetEnabled(widgetName) {
            // First check the skin config from API
            if (currentSkin && currentSkin.dashboard && currentSkin.dashboard.widgets) {
                const widget = currentSkin.dashboard.widgets[widgetName];
                if (widget !== undefined) {
                    return widget.enabled === true;
                }
            }
            
            // Fall back to MODULE_REGISTRY + localStorage settings (isModuleEnabled from head script)
            if (typeof isModuleEnabled === 'function') {
                return isModuleEnabled(widgetName);
            }
            
            // Final fallback: check MODULE_REGISTRY directly
            if (typeof MODULE_REGISTRY !== 'undefined' && MODULE_REGISTRY[widgetName]) {
                return MODULE_REGISTRY[widgetName].defaultEnabled !== false;
            }
            
            return true; // Default to enabled if no config found
        }

        // Page initialization is handled by initializeSkin() which is called from DOMContentLoaded
        // initializeSkin -> switchSkin -> applySkin (applies widget visibility) -> initializeDataLoaders
        // No need for separate load event handler

    </script>
</body>
</html>
